<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
  <meta name="theme-color" content="#1E293B">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="DropLit">
  <meta name="application-name" content="DropLit">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="format-detection" content="telephone=no">
  <meta name="description" content="DropLit - Voice-first idea capture app. Never lose your ideas again.">
  <title>DropLit</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-32.png">
  <link rel="apple-touch-icon" sizes="192x192" href="icons/icon-192.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css">
  
  <!-- Archive System Styles (v0.9.113) -->
  <style>
    /* Archived card - orange left border */
    .card.archived {
      border-left: 3px solid #F97316 !important;
    }
    /* Archived badge - pill style like .new-badge */
    .archived-badge {
      padding: 4px 10px;
      border-radius: var(--radius-full);
      font-size: 0.6rem;
      font-weight: 700;
      text-transform: uppercase;
      background: #FFEDD5;
      color: #9A3412;
      letter-spacing: 0.02em;
    }
    
    /* Chat History Styles (v0.9.120) */
    .chat-load-more {
      text-align: center;
      padding: 12px;
      margin-bottom: 8px;
    }
    .chat-load-more button {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .chat-load-more button:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }
    .chat-history-thumb {
      max-width: 150px;
      max-height: 150px;
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: pointer;
      display: block;
    }
    .chat-history-thumb-expired {
      color: var(--text-tertiary);
      font-size: 12px;
      padding: 8px;
      background: var(--bg-secondary);
      border-radius: 8px;
      margin-bottom: 8px;
    }
    .chat-history-media-ref {
      font-size: 11px;
      color: var(--text-tertiary);
      margin-top: 4px;
    }
    .history-message .ask-ai-time {
      font-size: 10px;
    }
    
    /* Settings Select (v0.9.120) */
    .settings-select {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 6px 12px;
      font-size: 13px;
      color: var(--text-primary);
      cursor: pointer;
      min-width: 100px;
    }
    .settings-select:focus {
      outline: none;
      border-color: var(--color-primary);
    }
  </style>

  <script src="js/utils.js"></script>
  <script src="js/tts.js"></script>
  <script src="js/tts-stream.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/validator.js"></script>
  <script src="js/command-validator.js"></script>
  <script>
    // AutoDrop check - must be defined before chat.js
    function isAutoDropEnabled() {
      return localStorage.getItem('droplit_autodrop') === 'true';
    }
  </script>
  <script src="js/chat.js"></script>
  <script src="js/settings.js"></script>
  <script src="js/photo.js"></script>
  <script src="js/sync.js"></script>
  <script src="js/notifications.js"></script>
  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Onboarding System -->
  <script src="js/onboarding.js"></script>
  
  <!-- Chart.js for Data Visualization (v0.9.120) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  
  <!-- Mermaid.js for Diagrams & Schemas (v0.9.120) -->
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>
    mermaid.initialize({ 
      startOnLoad: false,
      theme: 'default',
      securityLevel: 'loose',
      flowchart: {
        useMaxWidth: false,
        htmlLabels: true,
        curve: 'basis'
      },
      sequence: {
        useMaxWidth: false,
        diagramMarginX: 20,
        diagramMarginY: 20,
        actorMargin: 80,
        width: 180,
        height: 60
      },
      mindmap: {
        useMaxWidth: false
      },
      er: {
        useMaxWidth: false,
        minEntityWidth: 120,
        minEntityHeight: 60
      },
      gantt: {
        useMaxWidth: false,
        barHeight: 30,
        fontSize: 14
      }
    });
  </script>
  
  <!-- LZ-String for Chat History Compression (v0.9.120) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>

  <!-- ============================================
       DROPLIT PRIVACY SYSTEM v1.0
       E2E Encryption + Local AI + ZK Search
       ============================================ -->
  
  <!-- Crypto Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/tweetnacl@1.0.3/nacl-fast.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tweetnacl-util@0.15.1/nacl-util.min.js"></script>
  
  <!-- Privacy System Modules (load in order) -->
  <script src="js/privacy/crypto-keys.js"></script>
  <script src="js/privacy/drop-encryption.js"></script>
  <script src="js/privacy/local-embeddings.js"></script>
  <script src="js/privacy/zk-search.js"></script>
  <script src="js/privacy/audit-trail.js"></script>
  <script src="js/privacy/sync-encrypted.js"></script>
  <script src="js/privacy/encryption-ui.js"></script>
  <script src="js/privacy/privacy-integration.js"></script>
  
  <script>
    // Privacy System Version
    window.DROPLIT_PRIVACY_VERSION = '1.0.0';
    window.DROPLIT_PRIVACY_ENABLED = false; // Will be enabled after setup
    console.log('[DropLit] Privacy modules loaded v' + window.DROPLIT_PRIVACY_VERSION);
  </script>
  
  <!-- Encrypted Lock Icon Style - moved to styles.css -->
  
  <!-- Eruda Mobile Console (Debug) -->
  <script src="https://cdn.jsdelivr.net/npm/eruda@3.0.1/eruda.min.js"></script>
  <script>
    // Eruda will be initialized by button click
    window.ERUDA_LOADED = false;
    function toggleEruda() {
      if (!window.ERUDA_LOADED) {
        eruda.init();
        window.ERUDA_LOADED = true;
        console.log('[DropLit] Eruda console initialized');
      }
      eruda.show();
    }
  </script>

</head>
<body>
  <!-- ============================================
       ONBOARDING MODAL - Beta Access
       ============================================ -->
  <div class="onboarding-modal" id="onboardingModal">
    <div class="onboarding-container">
      
      <!-- Step 1: Invite Code -->
      <div class="onboarding-step active" id="onboardingStep1">
        <div class="onboarding-logo">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2L2 7l10 5 10-5-10-5z"/>
            <path d="M2 17l10 5 10-5"/>
            <path d="M2 12l10 5 10-5"/>
          </svg>
        </div>
        <h1 class="onboarding-title">Welcome to DropLit</h1>
        <p class="onboarding-subtitle">Voice-first idea capture</p>
        <p class="onboarding-beta-badge">üß™ Closed Beta</p>
        
        <div class="onboarding-invite-section">
          <label class="onboarding-label">Enter your invite code</label>
          <input 
            type="text" 
            class="onboarding-input" 
            id="onboardingInviteCode" 
            placeholder="INVITE-CODE"
            maxlength="20"
            autocomplete="off"
            oninput="onboardingValidateInvite()"
          >
          <div class="onboarding-invite-status" id="onboardingInviteStatus"></div>
        </div>
        
        <button 
          class="onboarding-btn primary" 
          id="onboardingContinueBtn"
          disabled
          onclick="onboardingProceedToAuth()"
        >
          Continue
        </button>
        
        <p class="onboarding-footer">
          Don't have a code? <a href="/cdn-cgi/l/email-protection#7819141d00380b01160c0a110b1d561b1715">Request access</a>
        </p>
      </div>
      
      <!-- Step 2: Auth Methods -->
      <div class="onboarding-step" id="onboardingStep2">
        <div class="onboarding-logo">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2L2 7l10 5 10-5-10-5z"/>
            <path d="M2 17l10 5 10-5"/>
            <path d="M2 12l10 5 10-5"/>
          </svg>
        </div>
        <h1 class="onboarding-title">Create Account</h1>
        <p class="onboarding-subtitle">Choose how to sign in</p>
        
        <div class="onboarding-auth-buttons">
          <button class="onboarding-btn oauth google" onclick="onboardingSignInGoogle()">
            <svg width="20" height="20" viewBox="0 0 24 24">
              <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
              <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
              <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
              <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
            </svg>
            Continue with Google
          </button>
          
          <button class="onboarding-btn oauth apple" onclick="onboardingSignInApple()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/>
            </svg>
            Continue with Apple
          </button>
          
          <div class="onboarding-divider">
            <span>or</span>
          </div>
          
          <button class="onboarding-btn secondary" onclick="onboardingShowEmailForm()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
              <polyline points="22,6 12,13 2,6"/>
            </svg>
            Continue with Email
          </button>
        </div>
        
        <div class="onboarding-error" id="onboardingError" style="display:none;"></div>
      </div>
      
      <!-- Step 3: Email Form -->
      <div class="onboarding-step" id="onboardingStep3">
        <button class="onboarding-back" onclick="onboardingBackToAuth()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
          Back
        </button>
        
        <h1 class="onboarding-title">Email Sign In</h1>
        
        <div class="onboarding-form">
          <input 
            type="email" 
            class="onboarding-input" 
            id="onboardingEmail" 
            placeholder="Email address"
            autocomplete="email"
          >
          <input 
            type="password" 
            class="onboarding-input" 
            id="onboardingPassword" 
            placeholder="Password (min 6 characters)"
            autocomplete="current-password"
          >
          
          <button 
            class="onboarding-btn primary" 
            id="onboardingEmailSubmit"
            onclick="onboardingSubmitEmail(false)"
          >
            Sign In
          </button>
          
          <button 
            class="onboarding-btn secondary"
            onclick="onboardingSubmitEmail(true)"
          >
            Create New Account
          </button>
        </div>
        
        <div class="onboarding-error" id="onboardingError2" style="display:none;"></div>
      </div>
      
    </div>
  </div>
  
  <!-- Onboarding, Security & Export Modal Styles - moved to styles.css -->


  <!-- Fullscreen Edit Panel - v0.9.95 -->
  <div class="edit-panel" id="editPanel">
    <div class="edit-panel-header">
      <div class="edit-panel-avatar" id="editPanelAvatar">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      </div>
      <div class="edit-panel-info">
        <div class="edit-panel-row1">
          <span class="edit-panel-badge" id="editPanelBadge"></span>
          <span class="edit-panel-creator" id="editPanelCreator">User</span>
        </div>
        <div class="edit-panel-row2">
          <span class="edit-panel-cat" id="editPanelCat" onclick="openCatModalFromEdit()">INBOX</span>
          <span class="encrypted-lock" id="editPanelLock" style="display:none;" title="Encrypted"><svg viewBox="0 0 24 24"><path d="M19 11H5a2 2 0 0 0-2 2v7a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7a2 2 0 0 0-2-2z"/><path d="M7 11V7a5 5 0 0 1 10 0v4" fill="none" stroke-width="2"/></svg></span>
          <span class="edit-panel-chars" id="editPanelChars">0</span>
          <span class="edit-panel-time" id="editPanelTime">00:00</span>
        </div>
      </div>
      <div class="edit-panel-header-btns">
        <button class="edit-panel-voice-btn" id="editPanelSpeakBtn" onclick="speakEditText()" title="Listen to text">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>
        </button>
        <button class="edit-panel-voice-btn" id="editPanelMicBtn" onclick="toggleEditMic()" title="Dictate at cursor">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="22"/></svg>
        </button>
        <button class="edit-panel-close-btn" onclick="cancelEditPanel()" title="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
    </div>
    <div class="edit-panel-toolbar">
      <div class="edit-panel-tools-main">
        <button class="pill-s active" id="editToolEdit" onclick="setEditMode('edit')">Edit</button>
        <button class="pill-s" id="editToolPreview" onclick="setEditMode('preview')">Preview</button>
        <button class="pill-s" id="editToolUndo" onclick="undoEditPanel()">Undo</button>
        <button class="pill-s pri" onclick="saveEditPanel()">Save</button>
        <button class="pill-s sec" onclick="cancelEditPanel()">Cancel</button>
      </div>
      <div class="edit-panel-tools-ai">
        <button class="pill-s ai" onclick="aiEditOrganize()">Organize</button>
        <button class="pill-s ai" onclick="aiEditEnhance()">Enhance</button>
        <button class="pill-s ai" onclick="aiEditSummarize()">Summarize</button>
        <button class="pill-s ai" onclick="aiEditExpand()">Expand</button>
      </div>
    </div>
    <div class="edit-panel-body">
      <textarea class="edit-panel-textarea" id="editPanelTextarea" placeholder="Enter your text..."></textarea>
      <div class="edit-panel-preview" id="editPanelPreview"></div>
    </div>
  </div>

  <!-- Insights Banner -->
  <div class="insights-banner" id="insightsBanner">
    <div class="insights-banner-icon">üéÇ</div>
    <div class="insights-banner-content">
      <div class="insights-banner-title" id="insightTitle">–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ</div>
      <div class="insights-banner-text" id="insightText">...</div>
    </div>
    <button class="insights-banner-close" onclick="dismissInsight()">√ó</button>
  </div>

  <!-- Notification Permission Banner -->
  <div class="notif-banner" id="notifBanner">
    <div class="notif-banner-title">üîî –í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è?</div>
    <div class="notif-banner-text">ASKI —Å–º–æ–∂–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞—Ç—å –æ –¥–Ω—è—Ö —Ä–æ–∂–¥–µ–Ω–∏—è –∏ –≤–∞–∂–Ω—ã—Ö —Å–æ–±—ã—Ç–∏—è—Ö</div>
    <div class="notif-banner-actions">
      <button class="notif-banner-btn secondary" onclick="dismissNotifBanner()">–ü–æ–∑–∂–µ</button>
      <button class="notif-banner-btn primary" onclick="requestNotifPermission()">–í–∫–ª—é—á–∏—Ç—å</button>
    </div>
  </div>

  <div class="app" id="app">
    <header class="header">
      <button class="logo-btn" id="logoBtn" onclick="toggleFilters()" title="Toggle filters">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"/></svg>
      </button>
      <div class="header-title"><span class="title-drop">Drop</span><span class="title-lit">Lit</span></div>
      <div class="header-right">
        <button class="header-lock" id="headerLock" onclick="showSecurityInfo()" title="Encryption status" style="display:none;">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
        </button>
        <button class="btn-icon" id="menuToggleBtn" onclick="toggleMainMenu()">
          <svg class="menu-icon-open" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
          <svg class="menu-icon-close" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" style="display:none;"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
    </header>
    <div class="network-banner" id="netBanner">No internet</div>
    <div class="warning" id="warning">Speech recognition not supported. Use Chrome.</div>
    <div class="search-indicator" id="searchIndicator" style="display:none">
      <span class="search-indicator-text">Searching: <span id="searchQueryDisplay"></span></span>
      <button class="search-indicator-clear" onclick="clearSearch()">‚úï Clear</button>
    </div>
    <div class="filters-wrap">
    <div class="filters">
      <div class="time-row" id="timeRow">
        <button class="time-btn" data-time="all">All <span class="cnt" id="cntAll">0</span></button>
        <button class="time-btn" data-time="today">Today <span class="cnt" id="cntToday">0</span></button>
        <button class="time-btn" data-time="7days">week <span class="cnt" id="cnt7d">0</span></button>
        <button class="sort-btn" id="sortBtn" onclick="toggleSort()" title="Sort order"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M18 15l-6-6-6 6"/></svg></button>
      </div>
      <div class="cat-row" id="cats">
        <button class="cat" data-category="command">Command <span class="cnt" id="cntCommand">0</span></button>
        <button class="cat" data-category="tasks">Tasks <span class="cnt" id="cntTasks">0</span></button>
        <button class="cat" data-category="ideas">Ideas <span class="cnt" id="cntIdeas">0</span></button>
        <button class="cat" data-category="handmagic">Handmagic <span class="cnt" id="cntHandmagic">0</span></button>
        <button class="cat" data-category="design">Design <span class="cnt" id="cntDesign">0</span></button>
        <button class="cat" data-category="bugs">Bugs <span class="cnt" id="cntBugs">0</span></button>
        <button class="cat" data-category="questions">Questions <span class="cnt" id="cntQuestions">0</span></button>
        <button class="cat" data-category="inbox">Inbox <span class="cnt" id="cntInbox">0</span></button>
        <button class="cat" data-category="audio">Audio <span class="cnt" id="cntAudio">0</span></button>
        <button class="cat" data-category="photo">Photo <span class="cnt" id="cntPhoto">0</span></button>
        <button class="cat" data-category="sketch">Sketch <span class="cnt" id="cntSketch">0</span></button>
        <button class="cat" data-category="scan">Scan <span class="cnt" id="cntScan">0</span></button>
        <button class="cat-add" onclick="addCatPrompt()">+</button>
      </div>
    </div>
    </div>
    <div class="ideas-wrap" id="ideasWrap">
      <div class="ideas" id="ideasList"></div>
      <div class="empty" id="emptyState">
        <div class="empty-icon"><svg viewBox="0 0 24 24"><path d="M12 2C12 2 5 10.5 5 15C5 18.866 8.134 22 12 22C15.866 22 19 18.866 19 15C19 10.5 12 2 12 2Z"/></svg></div>
        <div class="empty-title">Your ideas start here</div>
        <div class="empty-text">SHOOT ¬∑ PRESS ¬∑ SPEAK</div>
      </div>
    </div>
  </div>

<input type="file" id="cameraInput" class="camera-input" accept="image/*" capture="environment" onchange="handlePhoto(event)">
  <input type="file" id="imageUpload" class="camera-input" accept="image/*" onchange="handleUploadedImage(event)">
  <input type="file" id="fileUpload" style="display:none" accept=".txt,.md,.csv,.json" onchange="handleUploadedFile(event)">
  
  <!-- FAB Container - all bottom buttons -->
  <div class="fab-container" id="fabContainer">
    <button class="fab-camera" id="fabCamera" onclick="document.getElementById('cameraInput').click()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
    </button>
    <button class="fab-pill" id="fabAskAI" onclick="openAskAI()">AI CHAT</button>
    <button class="fab-pill create" id="fabCreate" onclick="togglePlusMenu()">CREATE+</button>
    <button class="fab-record" id="fabRecord" onclick="handleFabClick(event)" ontouchstart="fabTouchStart()" ontouchend="fabTouchEnd()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
    </button>
  </div>

  <!-- Plus Menu v3 - Two Column Layout -->
  <div class="plus-menu-backdrop" id="plusBackdrop" onclick="closePlusMenu()"></div>

  <div class="plus-menu" id="plusMenu">
    
    <!-- === AI MAGIC (top, furthest from finger) === -->
    <div class="section-divider"><span>AI Magic</span></div>
    <div class="menu-row-2">
      <button class="menu-item magic compact" onclick="openMagic('poem')">
        <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m12 3-1.9 5.8a2 2 0 0 1-1.3 1.3L3 12l5.8 1.9a2 2 0 0 1 1.3 1.3L12 21l1.9-5.8a2 2 0 0 1 1.3-1.3L21 12l-5.8-1.9a2 2 0 0 1-1.3-1.3Z"/></svg></span>
        <div class="info"><div class="title">Poem</div></div>
      </button>
      <button class="menu-item magic compact" onclick="openMagic('greeting')">
        <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg></span>
        <div class="info"><div class="title">Greeting</div></div>
      </button>
    </div>
    <div class="menu-row-2">
      <button class="menu-item magic compact" onclick="openMagic('speech')">
        <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 21h8M12 17v4M12 3C8.5 3 6 5.5 6 9v3c0 1.5-1 2-1 2h14s-1-.5-1-2V9c0-3.5-2.5-6-6-6z"/></svg></span>
        <div class="info"><div class="title">Speech</div></div>
      </button>
      <button class="menu-item magic compact" onclick="openMagic('story')">
        <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/></svg></span>
        <div class="info"><div class="title">Story</div></div>
      </button>
    </div>

    <!-- === UPLOAD (middle, 3 columns) === -->
    <div class="section-divider"><span>Upload</span></div>
    <div class="menu-row-3">
      <button class="menu-item compact" onclick="uploadImage()">
        <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="18" height="18" x="3" y="3" rx="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg></span>
        <div class="info"><div class="title">Photo</div></div>
      </button>
      <button class="menu-item compact" onclick="uploadFile()">
        <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg></span>
        <div class="info"><div class="title">File</div></div>
      </button>
      <button class="menu-item compact" onclick="pasteLink()">
        <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg></span>
        <div class="info"><div class="title">Link</div></div>
      </button>
    </div>

    <!-- === CREATE (bottom, closest to finger) === -->
    <div class="section-divider"><span>Create</span></div>
    
    <!-- 3rd: Audio Record -->
    <button class="menu-item audio" onclick="openAudioRecorder()">
      <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg></span>
      <div class="info">
        <div class="title">Audio Record</div>
        <div class="desc">Any sound, speech or music</div>
      </div>
    </button>
    
    <!-- 2nd: New Reminder -->
    <button class="menu-item command" onclick="openCreateCommand()">
      <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg></span>
      <div class="info">
        <div class="title">New Reminder</div>
        <div class="desc">Set a time-based notification</div>
      </div>
    </button>
    
    <!-- 1st (closest to finger): New Drop -->
    <button class="menu-item primary" onclick="openTextInput()">
      <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14"/><path d="M5 12h14"/></svg></span>
      <div class="info">
        <div class="title">New Drop</div>
        <div class="desc">Text note or idea</div>
      </div>
    </button>

  </div>

  <!-- Text input modal -->
  <div class="text-input-modal" id="textInputModal">
    <div class="text-input-content">
      <div class="text-input-header">
        <span class="text-input-title">New Drop</span>
        <button class="text-input-close" onclick="closeTextInput()">√ó</button>
      </div>
      <textarea class="text-input-area" id="textInputArea" placeholder="Type your idea here..."></textarea>
      <div class="text-input-actions">
        <button class="text-input-btn cancel" onclick="closeTextInput()">Cancel</button>
        <button class="text-input-btn save" onclick="saveTextNote()">Save</button>
      </div>
    </div>
  </div>

  <!-- Create Command Modal -->
  <div class="cmd-modal" id="createCommandModal" onclick="if(event.target===this)closeCreateCommand()">
    <div class="cmd-content">
      <!-- Header -->
      <div class="cmd-header">
        <div class="cmd-title">
          <span class="icon">‚è∞</span>
          <span>New Reminder</span>
        </div>
        <button class="cmd-close" onclick="closeCreateCommand()">√ó</button>
      </div>
      
      <!-- INPUT VIEW -->
      <div class="cmd-view active" id="cmdInputView">
        <div class="cmd-body">
          <p class="cmd-label">What do you need to do?</p>
          
          <div class="cmd-input-wrap">
            <textarea 
              class="cmd-input" 
              id="commandInput" 
              placeholder="Type or dictate your command..."
              oninput="updateCommandButton()"
            ></textarea>
            <button class="cmd-clear" id="commandClearBtn" onclick="document.getElementById('commandInput').value='';updateCommandButton()">‚úï</button>
          </div>
          
          <p class="cmd-hint">
            <strong>Examples:</strong> "Remind me in 30 min" ¬∑ "Tomorrow at 9am ‚Äî call" ¬∑ "Every day at 8am"
          </p>
          
          <button class="cmd-action-btn voice" id="commandActionBtn" onclick="handleCommandAction()">
            <span class="icon">üé§</span>
            <span class="text">TAP TO COMMAND</span>
          </button>
          
          <div class="cmd-secondary-row">
            <button class="cmd-secondary" onclick="showCommandView('details')">
              <span class="icon">‚öôÔ∏è</span>
              <span>Details</span>
            </button>
            <button class="cmd-secondary" onclick="showCommandView('templates')">
              <span class="icon">üìã</span>
              <span>Templates</span>
            </button>
          </div>
          
          <button class="cmd-cancel" onclick="closeCreateCommand()">Cancel</button>
        </div>
      </div>
      
      <!-- DETAILS VIEW -->
      <div class="cmd-view" id="cmdDetailsView">
        <div class="cmd-body">
          <div class="cmd-view-header">
            <span>‚öôÔ∏è Command Details</span>
            <button class="cmd-back" onclick="showCommandView('input')">‚Üê Back</button>
          </div>
          
          <div class="cmd-field">
            <label>Title</label>
            <input type="text" id="commandTitleInput" placeholder="What to remind about">
          </div>
          
          <div class="cmd-field">
            <label>When</label>
            <input type="datetime-local" id="commandTimeInput">
            <div class="cmd-quick-times">
              <button type="button" onclick="setCommandQuickTime(5)">5 min</button>
              <button type="button" onclick="setCommandQuickTime(15)">15 min</button>
              <button type="button" onclick="setCommandQuickTime(30)">30 min</button>
              <button type="button" onclick="setCommandQuickTime(60)">1 hour</button>
              <button type="button" onclick="setCommandQuickTime(1440)">Tomorrow</button>
            </div>
          </div>
          
          <div class="cmd-field-row">
            <div class="cmd-field">
              <label>Type</label>
              <select id="commandTypeSelect">
                <option value="reminder">Reminder</option>
                <option value="alarm">Alarm</option>
                <option value="cron">Recurring</option>
              </select>
            </div>
            <div class="cmd-field">
              <label>Notify</label>
              <select id="commandNotifySelect">
                <option value="push">üîî Push</option>
                <option value="tts">üîä Voice</option>
                <option value="email">üìß Email</option>
                <option value="telegram">üì± Telegram</option>
              </select>
            </div>
          </div>
          
          <div class="cmd-buttons">
            <button class="cmd-btn secondary" onclick="showCommandView('input')">Cancel</button>
            <button class="cmd-btn primary" onclick="createCommandFromUI()">Create Command</button>
          </div>
        </div>
      </div>
      
      <!-- TEMPLATES VIEW -->
      <div class="cmd-view" id="cmdTemplatesView">
        <div class="cmd-body">
          <div class="cmd-view-header">
            <span>üìã Templates</span>
            <button class="cmd-back" onclick="showCommandView('input')">‚Üê Back</button>
          </div>
          
          <div class="cmd-templates">
            <div class="cmd-template" onclick="applyCommandTemplate('morning')">
              <div class="name">üåÖ Morning routine</div>
              <div class="desc">Daily at 7:00 AM</div>
            </div>
            <div class="cmd-template" onclick="applyCommandTemplate('meeting')">
              <div class="name">üìÖ Meeting reminder</div>
              <div class="desc">15 minutes before</div>
            </div>
            <div class="cmd-template" onclick="applyCommandTemplate('medicine')">
              <div class="name">üíä Take medication</div>
              <div class="desc">Daily health reminder</div>
            </div>
            <div class="cmd-template" onclick="applyCommandTemplate('call')">
              <div class="name">üìû Call back</div>
              <div class="desc">In 30 minutes</div>
            </div>
            <div class="cmd-template" onclick="applyCommandTemplate('water')">
              <div class="name">üíß Drink water</div>
              <div class="desc">Hourly reminder</div>
            </div>
            <div class="cmd-template" onclick="applyCommandTemplate('break')">
              <div class="name">‚òï Take a break</div>
              <div class="desc">Every 2 hours</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- SUCCESS VIEW -->
      <div class="cmd-view" id="cmdSuccessView">
        <div class="cmd-body cmd-success">
          <div class="success-icon">‚úÖ</div>
          <div class="success-text">Command Created!</div>
          <div class="success-sub">You'll be notified at the scheduled time</div>
          <button class="cmd-btn secondary" onclick="document.getElementById('commandInput').value='';updateCommandButton();showCommandView('input')">Create Another</button>
          <button class="cmd-btn primary" onclick="closeCreateCommand()">Done</button>
        </div>
      </div>
    </div>
  </div>

  <!-- AI Magic Modal -->
  <div class="magic-modal" id="magicModal" onclick="if(event.target===this)closeMagic()">
    <div class="magic-content">
      <div class="magic-header">
        <h2 id="magicTitle">Create Poem</h2>
        <p id="magicSubtitle">Tell me what it should be about</p>
      </div>
      <div class="magic-body">
        <!-- Loading indicator -->
        <div class="magic-loading" id="magicLoading">
          <div class="ai-loading-dots magic">
            <span></span><span></span><span></span><span></span><span></span>
          </div>
          <div class="ai-loading-label" id="magicLoadingLabel">Creating magic...</div>
        </div>
        <!-- Form -->
        <div class="magic-form" id="magicForm">
        <!-- Photo section -->
        <div class="magic-photo-section">
          <div style="position: relative;">
            <button class="pill-l sec" id="magicPhotoBtn" onclick="togglePhotoMenu()">
              <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><rect width="18" height="18" x="3" y="3" rx="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
              <span id="magicPhotoBtnText">Add photo (optional)</span>
            </button>
            <div class="magic-photo-menu" id="magicPhotoMenu">
              <button class="magic-photo-menu-item" onclick="takeMagicPhoto()">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg> Take photo
              </button>
              <button class="magic-photo-menu-item" onclick="chooseMagicPhoto()">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><rect width="18" height="18" x="3" y="3" rx="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg> Choose from gallery
              </button>
              <button class="magic-photo-menu-item" onclick="openDropsPicker()">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg> Choose from Drops
              </button>
            </div>
          </div>
          <div class="magic-photo-preview" id="magicPhotoPreview" style="display: none;">
            <img id="magicPhotoImg" src="" alt="Selected photo">
            <button class="magic-photo-remove" onclick="removeMagicPhoto()">√ó</button>
          </div>
          <input type="file" id="magicPhotoInput" accept="image/*" style="display:none" onchange="handleMagicPhoto(event)">
          <input type="file" id="magicCameraInput" accept="image/*" capture="environment" style="display:none" onchange="handleMagicPhoto(event)">
        </div>
        
        <label class="magic-input-label" id="magicInputLabel">Add details (optional if photo added)</label>
        <textarea class="magic-input-area" id="magicInput" placeholder="Example: Birthday greeting for mom, she loves gardening and has 2 grandkids..."></textarea>
        <button class="pill-l sec" id="magicVoiceBtn" onclick="toggleMagicVoice()">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>
          <span id="magicVoiceText">Tap to speak</span>
        </button>
        <div class="magic-styles" id="magicStyles">
          <button class="magic-style active" data-style="classic">Classic</button>
          <button class="magic-style" data-style="funny">Funny</button>
          <button class="magic-style" data-style="tender">Tender</button>
          <button class="magic-style" data-style="epic">Epic</button>
        </div>
        <button class="pill-xl magic" id="magicGenerate" onclick="generateMagic()">
          Create Magic
        </button>
        </div><!-- end magic-form -->
      </div>
      <div class="magic-footer">
        <button class="pill-l sec" onclick="closeMagic()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Drops Picker Modal -->
  <div class="drops-picker" id="dropsPicker" onclick="if(event.target===this)closeDropsPicker()">
    <div class="drops-picker-content">
      <div class="drops-picker-header">
        <h3>Choose from Drops</h3>
        <button class="drops-picker-close" onclick="closeDropsPicker()">√ó</button>
      </div>
      <div class="drops-picker-grid" id="dropsPickerGrid">
        <!-- Filled dynamically -->
      </div>
    </div>
  </div>

  <!-- Audio Recorder Modal -->
  <div class="audio-recorder-modal" id="audioRecorderModal" onclick="if(event.target===this)closeAudioRecorder()">
    <div class="audio-recorder-content">
      <div class="audio-recorder-header">
        <h2>AUDIO RECORDER</h2>
      </div>
      <div class="audio-recorder-body">
        <div class="audio-recorder-waveform" id="recorderWaveform">
          <div class="bar" style="height:20px"></div>
          <div class="bar" style="height:35px"></div>
          <div class="bar" style="height:50px"></div>
          <div class="bar" style="height:40px"></div>
          <div class="bar" style="height:60px"></div>
          <div class="bar" style="height:45px"></div>
          <div class="bar" style="height:30px"></div>
          <div class="bar" style="height:55px"></div>
          <div class="bar" style="height:70px"></div>
          <div class="bar" style="height:50px"></div>
          <div class="bar" style="height:35px"></div>
          <div class="bar" style="height:60px"></div>
          <div class="bar" style="height:45px"></div>
          <div class="bar" style="height:25px"></div>
          <div class="bar" style="height:40px"></div>
          <div class="bar" style="height:55px"></div>
          <div class="bar" style="height:35px"></div>
          <div class="bar" style="height:50px"></div>
          <div class="bar" style="height:65px"></div>
          <div class="bar" style="height:40px"></div>
        </div>
        <div class="audio-recorder-time" id="recorderTime">0:00</div>
        <div class="audio-recorder-controls">
          <button class="ctrl-btn rewind" onclick="recorderRewind()">&lt;&lt;</button>
          <button class="ctrl-btn" id="recorderStopBtn" onclick="recorderStop()" style="background:#EF4444; color:white; font-weight:700;">STOP</button>
          <button class="ctrl-btn play" id="recorderPlayBtn" onclick="recorderPlayPause()">PLAY</button>
          <button class="ctrl-btn forward" onclick="recorderForward()">&gt;&gt;</button>
        </div>
        <button class="audio-recorder-main-btn ready" id="recorderMainBtn" onclick="recorderToggleRecord()">
          <span id="recorderMainText">TAP TO RECORD</span>
        </button>
        <div class="audio-recorder-actions">
          <button class="act-btn delete" onclick="recorderDelete()" disabled>DELETE</button>
          <button class="act-btn create" onclick="recorderCreateDrop()" disabled>CREATE DROP</button>
          <button class="act-btn share" onclick="recorderShare()" disabled>SHARE</button>
        </div>
        <button class="audio-recorder-cancel" onclick="closeAudioRecorder()">CANCEL</button>
      </div>
    </div>
  </div>

  <!-- AI Tools Modal (for text drops) -->
  <div class="ai-tools-modal" id="aiToolsModal" onclick="if(event.target===this)closeAITools()">
    <div class="ai-tools-content">
      <div class="ai-tools-header">
        <h2>AI Tools</h2>
        <p>What would you like to do?</p>
      </div>
      <div class="ai-tools-preview">
        <div class="ai-tools-preview-label">Selected drop:</div>
        <div class="ai-tools-preview-text" id="aiToolsPreviewText"></div>
      </div>
      <div class="ai-tools-body">
        <div class="ai-tools-grid">
          <button class="ai-tool-btn" onclick="runAITool('summarize')">
            <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/></svg></span>
            <div class="info">
              <div class="title">Summarize</div>
              <div class="desc">Make it shorter and clearer</div>
            </div>
          </button>
          <button class="ai-tool-btn" onclick="runAITool('tasks')">
            <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="m9 12 2 2 4-4"/></svg></span>
            <div class="info">
              <div class="title">Create Tasks</div>
              <div class="desc">Extract actionable to-dos</div>
            </div>
          </button>
          <button class="ai-tool-btn" onclick="runAITool('expand')">
            <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m12 3-1.9 5.8a2 2 0 0 1-1.3 1.3L3 12l5.8 1.9a2 2 0 0 1 1.3 1.3L12 21l1.9-5.8a2 2 0 0 1 1.3-1.3L21 12l-5.8-1.9a2 2 0 0 1-1.3-1.3Z"/></svg></span>
            <div class="info">
              <div class="title">Expand</div>
              <div class="desc">Add more details and ideas</div>
            </div>
          </button>
          <button class="ai-tool-btn" onclick="runAITool('rewrite')">
            <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg></span>
            <div class="info">
              <div class="title">Rewrite</div>
              <div class="desc">Different style or tone</div>
            </div>
          </button>
          <button class="ai-tool-btn" onclick="runAITool('enhance')">
            <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg></span>
            <div class="info">
              <div class="title">Enhance</div>
              <div class="desc">Fix errors, punctuation, formatting</div>
            </div>
          </button>
          <button class="ai-tool-btn" onclick="openTranslateModal()">
            <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"/><path d="M2 12h20"/></svg></span>
            <div class="info">
              <div class="title">Translate</div>
              <div class="desc">Translate to another language</div>
            </div>
          </button>
          <button class="ai-tool-btn" onclick="closeAITools();openFileExportModal(aiToolsDropId)">
            <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg></span>
            <div class="info">
              <div class="title">Export</div>
              <div class="desc">Save as TXT, PDF, DOCX, CSV</div>
            </div>
          </button>
        </div>
        <div class="ai-tools-option">
          <input type="checkbox" id="aiToolsCheckCategory" checked>
          <div class="ai-tools-option-label">
            <div class="title">Also check/update category</div>
            <div class="current">Current: <span id="aiToolsCurrentCategory">INBOX</span></div>
          </div>
        </div>
        <div class="ai-tools-option">
          <input type="checkbox" id="aiToolsRemoveLineBreaks">
          <div class="ai-tools-option-label">
            <div class="title">Remove extra line breaks</div>
            <div class="current">Join paragraphs into continuous text</div>
          </div>
        </div>
      </div>
      <div class="ai-tools-footer">
        <button class="pill-l sec" onclick="closeAITools()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- AI Result Modal (large, with actions) -->
  <div class="ai-result-modal" id="aiResultModal2" onclick="if(event.target===this)closeAIResult2()">
    <div class="ai-result-content">
      <div class="ai-result-header">
        <h2 id="aiResult2Title">Result</h2>
      </div>
      <div class="ai-result-body">
        <div class="ai-result-text" id="aiResult2Text"></div>
        <div class="ai-result-category" id="aiResult2Category" style="display:none;">
          <div class="ai-result-category-title">Suggested category</div>
          <div class="ai-result-category-row">
            <span class="ai-result-category-current" id="aiResult2CurrentCat">INBOX</span>
            <span class="ai-result-category-arrow">‚Üí</span>
            <span class="ai-result-category-suggested" id="aiResult2SuggestedCat">TASKS</span>
          </div>
          <div class="ai-result-category-actions">
            <button class="ai-result-category-btn" onclick="keepCategory()">Keep current</button>
            <button class="ai-result-category-btn accept" onclick="acceptCategory()">Change</button>
          </div>
        </div>
      </div>
      <div class="ai-result-actions">
        <button class="pill-l magic" onclick="replaceOriginal()">Replace original</button>
        <div class="pill-row">
          <button class="pill-l sec" onclick="createNewDrop()">New Drop</button>
          <button class="pill-l sec" onclick="copyResult2()">Copy</button>
        </div>
        <button class="pill-l sec" onclick="closeAIResult2()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- B2 FIX: Tasks Confirmation Modal -->
  <div class="ai-result-modal" id="tasksConfirmModal" onclick="if(event.target===this)closeTasksConfirm()">
    <div class="ai-result-content">
      <div class="ai-result-header" style="background: linear-gradient(135deg, #10B981, #3B82F6);">
        <h2>Extracted Tasks</h2>
      </div>
      <div class="ai-result-body">
        <p style="color: var(--color-text-muted); font-size: 0.85rem; margin-bottom: 12px;">Found <span id="tasksCount">0</span> tasks. Each will become a separate drop:</p>
        <div class="tasks-preview-list" id="tasksPreviewList"></div>
      </div>
      <div class="ai-result-actions">
        <button class="pill-l success" onclick="confirmCreateTasks()">
          Create <span id="tasksCountBtn">0</span> Task Drops
        </button>
        <button class="pill-l sec" onclick="closeTasksConfirm()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- I1 FIX: Translate Modal -->
  <div class="ai-result-modal" id="translateModal" onclick="if(event.target===this)closeTranslateModal()">
    <div class="ai-result-content" style="max-width: 360px;">
      <div class="ai-result-header" style="background: linear-gradient(135deg, #3B82F6, #10B981);">
        <h2>Translate</h2>
      </div>
      <div class="ai-result-body" style="padding: 20px;">
        <p style="color: var(--color-text-muted); font-size: 0.85rem; margin-bottom: 16px;">Select target language:</p>
        <div class="translate-langs">
          <button class="translate-lang-btn" onclick="runTranslate('English')">üá¨üáß English</button>
          <button class="translate-lang-btn" onclick="runTranslate('Russian')">üá∑üá∫ –†—É—Å—Å–∫–∏–π</button>
          <button class="translate-lang-btn" onclick="runTranslate('Spanish')">üá™üá∏ Espa√±ol</button>
          <button class="translate-lang-btn" onclick="runTranslate('German')">üá©üá™ Deutsch</button>
          <button class="translate-lang-btn" onclick="runTranslate('French')">üá´üá∑ Fran√ßais</button>
          <button class="translate-lang-btn" onclick="runTranslate('Chinese')">üá®üá≥ ‰∏≠Êñá</button>
          <button class="translate-lang-btn" onclick="runTranslate('Japanese')">üáØüáµ Êó•Êú¨Ë™û</button>
          <button class="translate-lang-btn" onclick="runTranslate('Portuguese')">üáßüá∑ Portugu√™s</button>
        </div>
      </div>
      <div class="ai-result-actions" style="padding: 16px 20px;">
        <button class="pill-l sec" onclick="closeTranslateModal()">Cancel</button>
      </div>
    </div>
  </div>

  <div class="rec-status" id="recStatus">
    <span class="rec-dot"></span>
    <span class="rec-text" id="recText">Listening...</span>
  </div>

  <button class="scroll-fab top" id="scrollTop" onclick="scrollToTop()"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M18 15l-6-6-6 6"/></svg></button>
  <button class="scroll-fab bottom" id="scrollBottom" onclick="scrollToBottom()"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M6 9l6 6 6-6"/></svg></button>

  <!-- Ask AI Panel -->
  <div class="ask-ai-panel" id="askAIPanel">
    <div class="ask-ai-handle" onclick="closeAskAI()">
      <div class="ask-ai-handle-bar"></div>
    </div>
    <div class="ask-ai-header">
      <div class="ask-ai-header-left">
        <div class="ask-ai-avatar">A</div>
        <div>
          <div class="ask-ai-title" id="askiTitle">Aski</div>
          <div class="ask-ai-subtitle" id="askiSubtitle">AI Assistant</div>
        </div>
      </div>
      <button class="pill-s ask-ai-btn-autodrop" id="autoDropIndicator" onclick="toggleAutoDropFromChat()" style="position: relative; z-index: 10; min-width: 100px;">AUTODROP</button>
      <button class="ask-ai-close" onclick="closeAskAI()">√ó</button>
    </div>
    <div class="ask-ai-messages" id="askAIMessages">
      <div class="ask-ai-empty" id="askAIEmpty">
        <div class="ask-ai-empty-icon"><svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#8B5CF6" stroke-width="1.5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></div>
        <div class="ask-ai-empty-title">Ask me anything</div>
        <div class="ask-ai-empty-text">I'm here to help ‚Äî answer questions, give ideas, or just chat.</div>
        <div class="ask-ai-prompts">
          <button class="ask-ai-prompt" onclick="setAskAIPrompt('–ß—Ç–æ –ø—Ä–∏–≥–æ—Ç–æ–≤–∏—Ç—å –Ω–∞ —É–∂–∏–Ω?')">–ß—Ç–æ –ø—Ä–∏–≥–æ—Ç–æ–≤–∏—Ç—å?</button>
          <button class="ask-ai-prompt" onclick="setAskAIPrompt('–ù–∞–ø–∏—à–∏ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ')">–ü–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ</button>
          <button class="ask-ai-prompt" onclick="setAskAIPrompt('–ö–∞–∫ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å –¥–µ–Ω—å?')">–ü–ª–∞–Ω –¥–Ω—è</button>
        </div>
      </div>
    </div>
    <div class="ask-ai-input-area">
      <div class="ask-ai-input-row">
        <button class="ask-ai-btn ask-ai-btn-clear" id="askAIClearBtn" onclick="clearAskAIInput()">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
        <textarea class="ask-ai-input" id="askAIInput" placeholder="Ask anything..." maxlength="2000" rows="2" oninput="updateAskAICharCount(); autoResizeTextarea(this);" onkeypress="if(event.key==='Enter' && !event.shiftKey && this.value.trim()) { event.preventDefault(); sendAskAIMessage(); }"></textarea>
        <button class="ask-ai-btn ask-ai-btn-send" id="askAISendBtn" onclick="console.log('Send clicked'); sendAskAIMessage()">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 2 11 13"/><path d="M22 2 15 22 11 13 2 9 22 2Z"/></svg>
        </button>
      </div>
	  <div class="ask-ai-controls-bottom" id="askAIControlsBottom">
        <!-- Left circle: Add to chat -->
        <button class="ask-ai-control-circle" id="askAIControlAdd" onclick="openAddToChat()">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        </button>
        <!-- Left big: Hide/Stop -->
        <button class="ask-ai-control-left" id="askAIControlLeft" onclick="handleChatControlLeft()">HIDE</button>
        <!-- Right big: Talk/Write -->
        <button class="ask-ai-control-right" id="askAIControlRight" onclick="toggleAskAIVoice()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>
          <span id="askAIControlRightText">TAP TO TALK</span>
        </button>
        <!-- Right circle: Killer Features -->
        <button class="ask-ai-control-circle features" id="askAIControlFeatures" onclick="openKillerFeatures()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
        </button>
      </div>
      <button class="ask-ai-voice-large" id="askAIVoiceLarge" onclick="toggleAskAIVoice()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>
        <span id="voiceLargeText">Tap to talk</span>
      </button>
      <div class="ask-ai-char-count" id="askAICharCount">0 / 2000</div>
      <!-- Hidden input for photo/file selection -->
      <input type="file" id="chatImageInput" accept="image/*" capture="environment" style="display:none" onchange="handleChatImageSelect(event)">
      <!-- Image preview container -->
      <div class="chat-image-preview" id="chatImagePreview" style="display:none">
        <button class="chat-image-remove" onclick="removeChatImage()">√ó</button>
        <img id="chatImagePreviewImg" src="" alt="Preview">
        <button class="chat-image-send" onclick="sendImageMessage()">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 2 11 13"/><path d="M22 2 15 22 11 13 2 9 22 2Z"/></svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Selection bar for merge -->
  <div class="select-bar" id="selectBar">
    <div class="select-info"><span id="selectCount">0</span> selected</div>
    <div class="select-actions">
      <button class="select-btn cancel" onclick="cancelSelect()">Cancel</button>
      <button class="select-btn delete" onclick="deleteSelected()">Delete</button>
      <button class="select-btn merge" onclick="showMergePreview()">Merge/Copy</button>
    </div>
  </div>

  <div class="toast-wrap" id="toastWrap"></div>

  <!-- Main Menu Modal -->
  <div class="main-menu" id="mainMenu" onclick="if(event.target===this)closeMainMenu()">
    <div class="main-menu-content">
      <div class="main-menu-header">
        <h2><svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg> Menu</h2>
        <button class="pill-s sec" onclick="closeMainMenu()">Close</button>
      </div>
      
      <!-- Account Card -->
      <div class="account-card" id="accountCard">
        <div class="account-header">
          <div class="account-avatar" id="accountAvatar">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
          </div>
          <div class="account-info">
            <div class="account-name-row">
              <span class="account-name" id="accountName">Not signed in</span>
              <span class="account-plan-badge" id="accountPlanBadge">FREE</span>
            </div>
            <div class="account-email" id="accountEmail">‚Äî</div>
          </div>
          <button class="account-logout-btn" id="accountLogoutBtn" onclick="handleLogout()" title="Sign out">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
          </button>
        </div>
        <div class="account-divider"></div>
        <div class="account-balance">
          <div class="balance-row">
            <span class="balance-label">AI Tokens</span>
            <span class="balance-value" id="tokenBalance">‚Äî</span>
          </div>
          <div class="balance-hint"><span id="tokenUsage">Loading...</span></div>
        </div>
      </div>
      
      <!-- Security Status Pill -->
      <button class="security-pill" id="securityBanner" onclick="showSecurityInfo()" style="display:none;">
        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
        <span>–ó–ê–©–ò–©–Å–ù–ù–´–ô –†–ï–ñ–ò–ú</span>
      </button>
      
      <!-- Search Section -->
      <div class="menu-section" style="border-bottom: none;">
        <div class="section-divider"><span>Search</span></div>
        <input type="text" class="menu-search-input" id="menuSearchInput" placeholder="Search drops..." onkeypress="if(event.key==='Enter')performSearch()" style="width: 100%; margin-bottom: 16px;">
        <div class="pill-row">
          <button class="pill-m sec" onclick="startVoiceSearch()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/></svg>
            Voice
          </button>
          <button class="pill-m pri" onclick="performSearch()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
            Search
          </button>
        </div>
      </div>
      
      <!-- View Settings Section (v0.9.105) -->
      <div class="menu-section" style="border-bottom: none;">
        <div class="section-divider"><span>View</span></div>
        <div class="settings-item">
          <div class="settings-item-left">
            <span class="settings-item-icon">üì¶</span>
            <span class="settings-item-label">Show Archived</span>
            <span class="settings-item-hint" style="font-size: 0.7rem; color: var(--color-text-muted); margin-left: 8px;">Include archived drops in feed</span>
          </div>
          <div class="settings-toggle" id="showArchivedToggle" onclick="toggleShowArchived()"></div>
        </div>
      </div>
      
      <!-- Undo Section -->
      <div class="menu-section" style="border-bottom: none;">
        <div class="section-divider"><span>Undo</span></div>
        <div class="undo-header">
          <button class="pill-l ai" id="undoMainBtn" onclick="undoLast()" disabled>
            ‚Ü∂ Undo Last Action
          </button>
        </div>
        <div id="undoLastInfo" style="text-align: center; font-size: 0.85rem; color: var(--color-text-muted); margin-top: 8px;"></div>
        <button class="pill-l sec" id="undoToggleBtn" onclick="toggleUndoList()" style="display: none; margin-top: 12px;">
          Show history (0)
        </button>
        <div class="undo-list" id="undoList"></div>
      </div>
      
      <!-- Settings Section -->
      <div class="menu-section no-border">
        <div class="section-divider"><span>Aski Brain</span></div>
        
        <div class="settings-item no-border" style="flex-direction: column; align-items: flex-start; gap: 12px;">
          <div class="settings-item-left">
            <span class="settings-item-icon"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="m12 3-1.9 5.8a2 2 0 0 1-1.3 1.3L3 12l5.8 1.9a2 2 0 0 1 1.3 1.3L12 21l1.9-5.8a2 2 0 0 1 1.3-1.3L21 12l-5.8-1.9a2 2 0 0 1-1.3-1.3Z"/></svg></span>
            <span class="settings-item-label">AI Persona</span>
          </div>
          <div class="pill-row" id="aiModelSelector">
            <button class="pill-m" data-model="sonnet" onclick="setAIModel('sonnet')">‚ú¶ ASKI</button>
            <button class="pill-m nous" data-model="opus" onclick="setAIModel('opus')">‚óâ NOUS</button>
          </div>
          <div style="font-size: 0.7rem; color: var(--color-text-muted); margin-top: 2px;">
            <span id="aiModelDescription">Fast, creative, enthusiastic</span>
          </div>
        </div>
      </div>
      
      <div class="menu-section no-border">
        <div class="section-divider"><span>Aski Voice</span></div>
        
        <div class="settings-item">
          <div class="settings-item-left">
            <span class="settings-item-icon"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg></span>
            <span class="settings-item-label">Voice Mode</span>
            <span class="settings-item-warning"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg> Uses more battery</span>
          </div>
          <div class="settings-toggle" id="voiceModeToggle" onclick="toggleVoiceMode()"></div>
        </div>
        
        <div class="settings-item">
          <div class="settings-item-left">
            <span class="settings-item-icon"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg></span>
            <span class="settings-item-label">Auto-speak replies</span>
          </div>
          <div class="settings-toggle" id="autoSpeakToggle" onclick="toggleAutoSpeak()"></div>
        </div>
        
        <div class="settings-item no-border" style="flex-direction: column; align-items: flex-start; gap: 12px;">
          <div class="settings-item-left">
            <span class="settings-item-icon"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="5"/><path d="M20 21a8 8 0 0 0-16 0"/></svg></span>
            <span class="settings-item-label">TTS Provider</span>
          </div>
          <div class="pill-row" id="ttsProviderSelector">
            <button class="pill-m" data-provider="openai" onclick="setTTSProvider('openai')">OpenAI</button>
            <button class="pill-m" data-provider="elevenlabs" onclick="setTTSProvider('elevenlabs')">ElevenLabs</button>
            <button class="pill-m" data-provider="browser" onclick="setTTSProvider('browser')">Browser</button>
          </div>
        </div>
        
        <!-- OpenAI Voice Settings -->
        <div id="openaiVoiceSettings">
          <div class="settings-item no-border" style="flex-direction: column; align-items: flex-start; gap: 12px;">
            <div class="settings-item-left">
              <span class="settings-item-icon"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg></span>
              <span class="settings-item-label">OpenAI Voice</span>
            </div>
            <div class="pill-row" id="voiceSelector" style="flex-wrap: wrap;">
              <button class="pill-m" data-voice="nova" onclick="setAskiVoice('nova')">Nova</button>
              <button class="pill-m" data-voice="shimmer" onclick="setAskiVoice('shimmer')">Shimmer</button>
              <button class="pill-m" data-voice="alloy" onclick="setAskiVoice('alloy')">Alloy</button>
              <button class="pill-m" data-voice="onyx" onclick="setAskiVoice('onyx')">Onyx</button>
              <button class="pill-m" data-voice="echo" onclick="setAskiVoice('echo')">Echo</button>
              <button class="pill-m" data-voice="fable" onclick="setAskiVoice('fable')">Fable</button>
            </div>
            <div class="voice-preview-hint" style="font-size: 0.75rem; color: var(--color-text-muted); margin-top: 4px;">Tap voice to preview</div>
          </div>
          
          <div class="settings-item no-border" style="flex-direction: column; align-items: flex-start; gap: 12px;">
            <div class="settings-item-left">
              <span class="settings-item-icon"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg></span>
              <span class="settings-item-label">OpenAI API Key</span>
            </div>
            <div style="width: 100%; display: flex; gap: 8px;">
              <input type="password" id="openaiApiKeyInput" placeholder="sk-..." style="flex: 1; padding: 10px 14px; border: 1px solid var(--color-border); border-radius: var(--radius-md); font-family: var(--font-main); font-size: 0.9rem; background: var(--color-bg);" oninput="saveOpenAIKey()">
              <button class="pill-m" onclick="toggleApiKeyVisibility('openai')" id="apiKeyToggleBtn" style="min-width: 60px;">Show</button>
            </div>
            <div id="apiKeyStatus" style="font-size: 0.75rem; color: var(--color-text-muted);"></div>
          </div>
        </div>
        
        <!-- ElevenLabs Voice Settings -->
        <div id="elevenlabsVoiceSettings" style="display: none;">
          <div class="settings-item no-border" style="flex-direction: column; align-items: flex-start; gap: 12px;">
            <div class="settings-item-left">
              <span class="settings-item-icon"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg></span>
              <span class="settings-item-label">ElevenLabs Voice (Russian)</span>
            </div>
            <div class="pill-row" id="elevenlabsVoiceSelector" style="flex-wrap: wrap;">
              <button class="pill-m" data-voice="Bella" data-voiceid="EXAVITQu4vr4xnSDxMaL" onclick="selectElevenLabsVoice('Bella','EXAVITQu4vr4xnSDxMaL')">Bella</button>
              <button class="pill-m" data-voice="Jeff" data-voiceid="gs0tAILXbY5DNrJrsM6F" onclick="selectElevenLabsVoice('Jeff','gs0tAILXbY5DNrJrsM6F')">Jeff</button>
              <button class="pill-m" data-voice="Archer" data-voiceid="L0Dsvb3SLTyegXwtm47J" onclick="selectElevenLabsVoice('Archer','L0Dsvb3SLTyegXwtm47J')">Archer</button>
              <button class="pill-m" data-voice="Paul" data-voiceid="WLKp2jV6nrS8aMkPPDRO" onclick="selectElevenLabsVoice('Paul','WLKp2jV6nrS8aMkPPDRO')">Paul</button>
              <button class="pill-m" data-voice="Ariana" data-voiceid="xyu8HSCv1JYrhLx4m8UG" onclick="selectElevenLabsVoice('Ariana','xyu8HSCv1JYrhLx4m8UG')">Ariana</button>
              <button class="pill-m" data-voice="Polina" data-voiceid="wUndevsXFk0ArF7vJ61U" onclick="selectElevenLabsVoice('Polina','wUndevsXFk0ArF7vJ61U')">Polina</button>
            </div>
            <div class="voice-preview-hint" style="font-size: 0.75rem; color: var(--color-text-muted); margin-top: 4px;">Tap voice to preview ‚Ä¢ Native Russian speakers</div>
          </div>
          
          <div class="settings-item no-border" style="flex-direction: column; align-items: flex-start; gap: 12px;">
            <div class="settings-item-left">
              <span class="settings-item-icon"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg></span>
              <span class="settings-item-label">ElevenLabs API Key</span>
            </div>
            <div style="width: 100%; display: flex; gap: 8px;">
              <input type="password" id="elevenlabsApiKeyInput" placeholder="xi-..." style="flex: 1; padding: 10px 14px; border: 1px solid var(--color-border); border-radius: var(--radius-md); font-family: var(--font-main); font-size: 0.9rem; background: var(--color-bg);" oninput="saveElevenLabsKey()">
              <button class="pill-m" onclick="toggleApiKeyVisibility('elevenlabs')" id="elevenlabsApiKeyToggleBtn" style="min-width: 60px;">Show</button>
              <button class="pill-m" onclick="testElevenLabsKey()" style="min-width: 50px; background: #8B5CF6; color: white;">Test</button>
            </div>
            <div id="elevenlabsApiKeyStatus" style="font-size: 0.75rem; color: var(--color-text-muted);"></div>
            <div style="font-size: 0.7rem; color: var(--color-text-muted); margin-top: 4px;">
              Get free API key at <a href="https://elevenlabs.io" target="_blank" style="color: #8B5CF6;">elevenlabs.io</a> (10K chars/month free)
            </div>
          </div>
        </div>
        
        <div class="settings-item no-border" style="flex-direction: column; align-items: flex-start; gap: 12px;">
          <div class="settings-item-left">
            <span class="settings-item-icon"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></span>
            <span class="settings-item-label">Listen time after Aski, sec</span>
          </div>
          <div class="pill-row" id="listenCyclesSelector">
            <button class="pill-m" data-cycles="10" onclick="setListenCycles(10)">10</button>
            <button class="pill-m active" data-cycles="15" onclick="setListenCycles(15)">15</button>
            <button class="pill-m" data-cycles="20" onclick="setListenCycles(20)">20</button>
            <button class="pill-m" data-cycles="25" onclick="setListenCycles(25)">25</button>
          </div>
        </div>
        
        <div class="section-divider"><span>Aski Chat</span></div>
        
        <div class="settings-item">
          <div class="settings-item-left">
            <span class="settings-item-icon"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4"/><path d="M12 18v4"/><path d="M4.93 4.93l2.83 2.83"/><path d="M16.24 16.24l2.83 2.83"/><path d="M2 12h4"/><path d="M18 12h4"/><path d="M4.93 19.07l2.83-2.83"/><path d="M16.24 7.76l2.83-2.83"/></svg></span>
            <span class="settings-item-label">AutoDrop</span>
            <span class="settings-item-hint" style="font-size: 0.7rem; color: var(--color-text-muted); margin-left: 8px;">Auto-save all messages</span>
          </div>
          <div class="settings-toggle" id="autoDropToggle" onclick="toggleAutoDrop()"></div>
        </div>
        
        <div class="settings-item no-border" style="flex-direction: column; align-items: flex-start; gap: 12px;">
          <div class="settings-item-left">
            <span class="settings-item-icon"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></span>
            <span class="settings-item-label">Email –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏</span>
          </div>
          <div style="width: 100%; display: flex; gap: 8px;">
            <input type="email" id="userEmailInput" placeholder="your@email.com" style="flex: 1; padding: 10px 14px; border: 1px solid var(--color-border); border-radius: var(--radius-md); font-family: var(--font-main); font-size: 0.9rem; background: var(--color-bg);" oninput="saveUserEmail()">
          </div>
          <div style="font-size: 0.7rem; color: var(--color-text-muted);">ASKI –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –ø–∏—Å—å–º–∞ –Ω–∞ —ç—Ç–æ—Ç –∞–¥—Ä–µ—Å –ø–æ –∑–∞–ø—Ä–æ—Å—É "–æ—Ç–ø—Ä–∞–≤—å –º–Ω–µ"</div>
        </div>
        
        <div class="section-divider"><span>ASKI Knowledge</span></div>
        
        <div class="settings-item no-border" style="flex-direction: column; align-items: flex-start; gap: 12px;">
          <div class="settings-item-left">
            <span class="settings-item-icon"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg></span>
            <span class="settings-item-label">Personal Knowledge Base</span>
          </div>
          <div style="font-size: 0.7rem; color: var(--color-text-muted); margin-bottom: 8px;">
            –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ–±–µ, –∫–æ–Ω—Ç–∞–∫—Ç—ã, –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è ‚Äî ASKI –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ –≤ –∫–∞–∂–¥–æ–º —Ä–∞–∑–≥–æ–≤–æ—Ä–µ
          </div>
          <textarea id="askiKnowledgeInput" 
            placeholder="# About Me&#10;–ò–º—è: ...&#10;&#10;# Contacts&#10;John: john@example.com&#10;&#10;# Preferences&#10;- –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ" 
            style="width: 100%; min-height: 200px; padding: 12px; border: 1px solid var(--color-border); border-radius: var(--radius-md); font-family: 'SF Mono', Monaco, monospace; font-size: 0.8rem; background: var(--color-bg); resize: vertical; line-height: 1.5;"
            oninput="saveAskiKnowledge()"></textarea>
          <div style="display: flex; gap: 8px; width: 100%;">
            <button class="pill-m" onclick="exportAskiKnowledge()" style="flex: 1;">
              <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
              Export
            </button>
            <button class="pill-m" onclick="document.getElementById('askiKnowledgeFileInput').click()" style="flex: 1;">
              <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
              Import
            </button>
            <input type="file" id="askiKnowledgeFileInput" accept=".md,.txt" style="display: none;" onchange="importAskiKnowledge(event)">
          </div>
        </div>
        
        <div class="section-divider"><span>Security</span></div>
        
        <div class="settings-item">
          <div class="settings-item-left">
            <span class="settings-item-icon"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg></span>
            <span class="settings-item-label">Sensitive data protection</span>
          </div>
          <div class="settings-toggle active" id="sensitiveDataToggle" onclick="toggleSensitiveProtection()"></div>
        </div>
        
        <div class="settings-item no-border" style="flex-direction: column; align-items: flex-start; gap: 8px; padding-top: 4px;">
          <div style="font-size: 0.75rem; color: var(--color-text-muted); line-height: 1.4;">
            Auto-detect credit cards, SSN, passwords and mask them before sending to AI.
          </div>
          <div class="pill-row" id="sensitiveActionSelector" style="margin-top: 4px;">
            <button class="pill-m" data-action="mask" onclick="setSensitiveAction('mask')">Auto-mask</button>
            <button class="pill-m active" data-action="warn" onclick="setSensitiveAction('warn')">Warn me</button>
            <button class="pill-m" data-action="ignore" onclick="setSensitiveAction('ignore')">Ignore</button>
          </div>
        </div>
        
        <div class="section-divider"><span>Display</span></div>
        
        <div class="settings-item">
          <div class="settings-item-left">
            <span class="settings-item-icon"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18"/><path d="M3 15h18"/></svg></span>
            <span class="settings-item-label">Compact feed</span>
          </div>
          <div class="settings-toggle" id="rollUpModeToggle" onclick="toggleRollUpMode()"></div>
        </div>
        
        <div class="settings-item">
          <div class="settings-item-left">
            <span class="settings-item-icon"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg></span>
            <span class="settings-item-label">Dark mode</span>
          </div>
          <div class="settings-toggle" id="darkModeToggle" onclick="toggleDarkMode()"></div>
        </div>
        
        <div class="settings-item no-border" style="flex-direction: column; align-items: flex-start; gap: 12px;">
          <div class="settings-item-left">
            <span class="settings-item-icon"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 7V4h16v3"/><path d="M9 20h6"/><path d="M12 4v16"/></svg></span>
            <span class="settings-item-label">Font size</span>
          </div>
          <div class="pill-row" id="fontSizeSelector">
            <button class="pill-m" data-size="small" onclick="setFontSize('small')">Small</button>
            <button class="pill-m" data-size="normal" onclick="setFontSize('normal')">Normal</button>
            <button class="pill-m" data-size="large" onclick="setFontSize('large')">Large</button>
          </div>
        </div>
        
        <div class="section-divider"><span>Cloud</span></div>
        
        <div class="settings-item no-border">
          <div class="settings-item-left">
            <span class="settings-item-icon"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z"/></svg></span>
            <div>
              <span class="settings-item-label">Cloud Sync</span>
              <div id="lastSyncInfo" style="font-size: 0.65rem; color: var(--color-text-muted); margin-top: 2px;">Last sync: ‚Äî</div>
            </div>
          </div>
          <button class="pill-m pri" onclick="manualSync()">Sync Now</button>
        </div>
        
        <div class="section-divider"><span>Data</span></div>
        
        <div class="settings-item">
          <div class="settings-item-left">
            <span class="settings-item-icon"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 8V5a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v3"/><path d="M21 16v3a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-3"/><path d="M4 12h16"/><path d="m9 8-4 4 4 4"/><path d="m15 8 4 4-4 4"/></svg></span>
            <span class="settings-item-label">Export data</span>
          </div>
          <button class="pill-m sec" onclick="exportData()">Export</button>
        </div>
        
        <div class="section-divider"><span>Chat History</span></div>
        
        <!-- Chat History Stats -->
        <div class="settings-item">
          <div class="settings-item-left">
            <span class="settings-item-icon">üí¨</span>
            <span class="settings-item-label">Messages stored</span>
          </div>
          <span class="settings-item-value" id="chatHistoryCount">0</span>
        </div>
        
        <!-- Auto-delete setting -->
        <div class="settings-item">
          <div class="settings-item-left">
            <span class="settings-item-icon">‚è±Ô∏è</span>
            <span class="settings-item-label">Auto-delete after</span>
          </div>
          <select id="chatAutoDeleteSelect" class="settings-select" onchange="setChatAutoDelete(this.value)">
            <option value="never">Never</option>
            <option value="1">1 day</option>
            <option value="7">7 days</option>
            <option value="30">30 days</option>
            <option value="90">90 days</option>
          </select>
        </div>
        
        <!-- Clear Chat Now -->
        <div class="settings-item no-border" style="padding-bottom: 0;">
          <div class="settings-item-left">
            <span class="settings-item-icon">üóëÔ∏è</span>
            <span class="settings-item-label">Clear chat history</span>
          </div>
          <button class="pill-m danger" onclick="clearChatHistory()">Clear</button>
        </div>
        
        <div class="section-divider"><span>Data Management</span></div>
        
        <div class="settings-item">
          <div class="settings-item-left">
            <span class="settings-item-icon"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg></span>
            <span class="settings-item-label">Import data</span>
          </div>
          <button class="pill-m sec" onclick="document.getElementById('importFileInput').click()">Import</button>
          <input type="file" id="importFileInput" style="display:none" accept=".json" onchange="handleImportFile(event)">
        </div>
        
        <div class="settings-item no-border" style="padding-bottom: 0;">
          <div class="settings-item-left">
            <span class="settings-item-icon"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg></span>
            <span class="settings-item-label">Clear all data</span>
          </div>
          <button class="pill-m danger" onclick="clearAllData()">Clear</button>
        </div>
        
        <div class="section-divider"><span>About</span></div>
        
        <!-- Debug button -->
        <div style="padding: 12px 0;">
          <button class="pill-l sec" onclick="showDebugInfo()" style="width: 100%;">üîß Debug & Sync Info</button>
        </div>
        
        <!-- Mobile Console (Eruda) -->
        <div style="padding: 12px 0;">
          <button class="pill-l sec" onclick="toggleEruda()" style="width: 100%;">üì± Mobile Console</button>
        </div>
        
        <!-- Export Drops -->
        <div style="padding: 12px 0;">
          <button class="pill-l sec" onclick="closeMainMenu();openFileExportModal()" style="width: 100%;">üì§ Export Drops</button>
        </div>
        
        <!-- Privacy Status -->
        <div style="padding: 12px 0;">
          <button class="pill-l sec" onclick="showPrivacyStatus()" style="width: 100%;">üîê Privacy Status</button>
        </div>
        
        <!-- Setup Encryption -->
        <div style="padding: 12px 0;">
          <button class="pill-l sec" onclick="setupEncryption()" style="width: 100%;" id="setupEncryptionBtn">üîê Encryption</button>
        </div>
        
        <!-- Reset Encryption (for testing) -->
        <div style="padding: 6px 0;">
          <button class="pill-m sec" onclick="resetEncryption()" style="width: 100%; font-size: 0.8rem;">üîÑ Reset Encryption</button>
        </div>
        
        <div class="menu-about" onclick="closeMainMenu(); openAbout();" style="cursor: pointer;">
          <div class="menu-about-logo">
            <svg viewBox="0 0 24 24"><path d="M12 2C12 2 5 10.5 5 15C5 18.866 8.134 22 12 22C15.866 22 19 18.866 19 15C19 10.5 12 2 12 2Z"/></svg>
          </div>
          <div class="menu-about-name">DropLit</div>
          <div class="menu-about-ver">v0.9.122 ‚Ä¢ Syntrise Inc. ¬© 2026</div>
          <div style="font-size: 0.7rem; color: var(--color-primary); margin-top: 8px;">Tap for more info</div>
        </div>
      </div>
      
      <!-- Footer with Close button -->
      <div class="main-menu-footer">
        <button class="pill-l sec" onclick="showDebugInfo()" style="margin-right: 8px;">üîß Debug</button>
        <button class="pill-l sec" onclick="closeMainMenu()">Close Menu</button>
      </div>
    </div>
  </div>

  <!-- Modals -->
  <div class="overlay" id="aboutModal"><div class="modal"><div class="about-brand"><div class="about-logo"><svg viewBox="0 0 24 24" fill="white"><path d="M12 2C12 2 5 10.5 5 15C5 18.866 8.134 22 12 22C15.866 22 19 18.866 19 15C19 10.5 12 2 12 2Z"/></svg></div><div class="about-name">DropLit</div><div class="about-ver">v0.9.122 ‚Ä¢ Syntrise Inc.</div></div><div class="modal-text" style="text-align:center">Voice-first idea capture.<br>Your data is end-to-end encrypted.<br><br><span style="font-size:11px;opacity:0.7">¬© 2026 Syntrise Inc. All rights reserved.</span></div><div class="modal-actions"><button class="modal-btn pri" onclick="closeAbout()">Got it</button></div></div></div>
  <div class="overlay" id="catModal"><div class="modal type-b"><div class="modal-header"><h3>Move to Category</h3></div><div class="modal-body"><div class="cat-grid"><button class="cat-opt" data-cat="tasks" onclick="changeCat('tasks')">Tasks</button><button class="cat-opt" data-cat="ideas" onclick="changeCat('ideas')">Ideas</button><button class="cat-opt" data-cat="handmagic" onclick="changeCat('handmagic')">Handmagic</button><button class="cat-opt" data-cat="design" onclick="changeCat('design')">Design</button><button class="cat-opt" data-cat="bugs" onclick="changeCat('bugs')">Bugs</button><button class="cat-opt" data-cat="questions" onclick="changeCat('questions')">Questions</button><button class="cat-opt" data-cat="sketch" onclick="changeCat('sketch')">Sketch</button><button class="cat-opt" data-cat="scan" onclick="changeCat('scan')">Scan</button><button class="cat-opt" data-cat="inbox" onclick="changeCat('inbox')">Inbox</button></div></div><div class="modal-actions"><button class="modal-btn sec" onclick="closeCatModal()">Cancel</button></div></div></div>
  <div class="overlay" id="sendModal"><div class="modal type-b"><div class="modal-header"><h3>Share Drop</h3></div><div class="modal-body"><div class="send-opts"><div class="send-opt" onclick="sendAI()"><div class="send-icon">AI</div><div class="send-info"><div class="send-title">AI Assistant</div><div class="send-desc">Copy + open Claude</div></div><span class="send-badge">Pro</span></div><div class="send-div">or share via</div><div class="send-opt" onclick="shareNative()"><div class="send-icon">...</div><div class="send-info"><div class="send-title">Share...</div><div class="send-desc">WhatsApp, Telegram</div></div></div><div class="send-opt" onclick="sendMail()"><div class="send-icon">@</div><div class="send-info"><div class="send-title">Email</div><div class="send-desc">Send via email</div></div></div><div class="send-opt" onclick="copyClip()"><div class="send-icon">#</div><div class="send-info"><div class="send-title">Copy</div><div class="send-desc">Copy to clipboard</div></div></div></div></div><div class="modal-actions"><button class="modal-btn sec" onclick="closeSendModal()">Cancel</button></div></div></div>
  <div class="overlay" id="exportModal"><div class="modal type-b"><div class="modal-header"><h3>Export Data</h3></div><div class="modal-body"><div class="export-box" id="exportBox"></div></div><div class="modal-actions"><button class="modal-btn sec" onclick="closeExportModal()">Close</button><button class="modal-btn pri" onclick="copyExport()">Copy All</button></div></div></div>
  <div class="overlay" id="delModal"><div class="modal"><div class="modal-title">Delete this idea?</div><div class="modal-text">This action cannot be undone.</div><div class="modal-actions"><button class="modal-btn sec" onclick="closeDelModal()">Cancel</button><button class="modal-btn danger" onclick="confirmDel()">Delete</button></div></div></div>
  <div class="overlay" id="creatorModal"><div class="modal type-b creator-modal"><div class="modal-header" id="creatorModalHeader"><div class="creator-modal-avatar" id="creatorModalAvatar"></div><div class="creator-modal-info"><h3 id="creatorModalName">Creator</h3><span class="creator-modal-role" id="creatorModalRole"></span></div></div><div class="modal-body"><div class="creator-info"><div class="creator-info-row"><span class="creator-info-label">Created</span><span class="creator-info-value" id="creatorModalDate">‚Äî</span></div><div class="creator-info-row"><span class="creator-info-label">Copyright</span><span class="creator-info-value" id="creatorModalCopyright">¬© 2025</span></div></div></div><div class="modal-actions"><button class="modal-btn" id="creatorFilterBtn" onclick="filterByCreator()">Show only</button><button class="modal-btn sec" onclick="closeCreatorModal()">Close</button></div></div></div>
  <div class="overlay" id="settingsModal"><div class="modal type-b"><div class="modal-header"><h3>Settings</h3></div><div class="modal-body"><div class="modal-text" style="margin-bottom:0;">Syntrise CORE:<br>Sync your ideas to cloud</div></div><div class="modal-actions"><button class="modal-btn sec" onclick="syncToCloud()">Sync</button><button class="modal-btn sec" onclick="closeSettings();openFileExportModal()">Export</button><button class="modal-btn pri" onclick="closeSettings()">Done</button></div></div></div>
  <div class="overlay" id="addCatModal"><div class="modal"><div class="modal-title">Add Category</div><div class="modal-text">Custom categories coming in a future update!</div><div class="modal-actions"><button class="modal-btn pri" onclick="closeAddCatModal()">OK</button></div></div></div>
  
  <!-- File Export Modal -->
  <div class="overlay" id="fileExportOverlay" onclick="if(event.target===this)closeFileExportModal()">
    <div class="export-file-modal">
      <div class="export-file-header">
        <h3>üì§ Export</h3>
        <p>Save your drops as a file</p>
      </div>
      <div class="export-file-body">
        <div class="export-field">
          <label>Format</label>
          <div class="export-format-grid">
            <button class="export-format-btn active" data-format="txt" onclick="selectExportFormat('txt')">
              <span class="format-icon">üìÑ</span>
              <span class="format-name">TXT</span>
            </button>
            <button class="export-format-btn" data-format="md" onclick="selectExportFormat('md')">
              <span class="format-icon">üìù</span>
              <span class="format-name">MD</span>
            </button>
            <button class="export-format-btn" data-format="csv" onclick="selectExportFormat('csv')">
              <span class="format-icon">üìä</span>
              <span class="format-name">CSV</span>
            </button>
            <button class="export-format-btn" data-format="docx" onclick="selectExportFormat('docx')">
              <span class="format-icon">üìò</span>
              <span class="format-name">DOCX</span>
            </button>
            <button class="export-format-btn" data-format="pdf" onclick="selectExportFormat('pdf')">
              <span class="format-icon">üìï</span>
              <span class="format-name">PDF</span>
            </button>
          </div>
        </div>
        
        <div class="export-field">
          <label>Filename</label>
          <input type="text" id="exportFilename" value="droplit-export" placeholder="Enter filename">
        </div>
        
        <div class="export-field">
          <label>What to export</label>
          <div class="export-scope-options">
            <label class="export-scope-option">
              <input type="radio" name="exportScope" value="current" onchange="selectExportScope('current')">
              <span>Current drop only</span>
            </label>
            <label class="export-scope-option active">
              <input type="radio" name="exportScope" value="all" checked onchange="selectExportScope('all')">
              <span>All drops (<span id="exportDropCount">0</span>)</span>
            </label>
            <label class="export-scope-option">
              <input type="radio" name="exportScope" value="filtered" onchange="selectExportScope('filtered')">
              <span>Current filter (<span id="exportFilteredCount">0</span>)</span>
            </label>
          </div>
        </div>
        
        <div class="export-options">
          <label class="export-option">
            <input type="checkbox" id="exportIncludeDate" checked>
            <span>Include date</span>
          </label>
          <label class="export-option">
            <input type="checkbox" id="exportIncludeCategory" checked>
            <span>Include category</span>
          </label>
          <label class="export-option">
            <input type="checkbox" id="exportIncludeMeta">
            <span>Include metadata</span>
          </label>
        </div>
        
        <!-- DOCX/PDF specific options -->
        <div class="export-options" id="exportDocOptions" style="border-top: 1px solid var(--border); padding-top: 12px; margin-top: 8px;">
          <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px;">Document options (DOCX/PDF):</div>
          <label class="export-option">
            <input type="checkbox" id="exportBusinessStyle" checked>
            <span>Business style (Times 14pt + formatting)</span>
          </label>
          <div style="display: flex; gap: 16px; margin-top: 8px;">
            <label class="export-option" style="flex: 1;">
              <input type="radio" name="pageSize" value="a4" checked>
              <span>A4 (Europe)</span>
            </label>
            <label class="export-option" style="flex: 1;">
              <input type="radio" name="pageSize" value="letter">
              <span>Letter (US)</span>
            </label>
          </div>
        </div>
        
        <div class="export-file-actions">
          <button class="export-btn-cancel" onclick="closeFileExportModal()">Cancel</button>
          <button class="export-btn-cancel" onclick="printDrops()" style="margin-right: 8px;">üñ®Ô∏è Print</button>
          <button class="export-btn-download" onclick="executeFileExport()">Export</button>
        </div>
      </div>
    </div>
  </div>
  
  <div class="overlay" id="mergeModal"><div class="modal type-b"><div class="modal-header"><h3>Merge Preview</h3></div><div class="modal-body"><div class="merge-options"><label class="merge-toggle"><input type="checkbox" id="mergeSimple" onchange="updateMergePreview()"><span>Simple merge (no headers)</span></label></div><div class="merge-preview" id="mergePreview"></div></div><div class="modal-actions"><button class="pill-m sec" onclick="closeMergeModal()">Cancel</button><button class="pill-m sec" onclick="copyMerged()">Copy</button><button class="pill-m merge" onclick="saveMerged()">Save Merge</button></div></div></div>
  
  <!-- Sensitive Data Warning Modal -->
  <div class="overlay" id="sensitiveWarningModal" onclick="if(event.target===this)closeSensitiveWarning()">
    <div class="modal type-b" style="max-width: 360px;">
      <div class="modal-header" style="background: linear-gradient(135deg, #F59E0B, #D97706); color: white;">
        <h3>‚ö†Ô∏è Sensitive Data Detected</h3>
      </div>
      <div class="modal-body" style="padding: 16px;">
        <p style="margin-bottom: 12px; color: var(--text-primary);">Found potentially sensitive information:</p>
        <div id="sensitiveDataList" style="background: var(--bg-secondary); border-radius: 8px; padding: 12px; margin-bottom: 12px; font-family: monospace; font-size: 0.85rem; max-height: 150px; overflow-y: auto;"></div>
        <p style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 8px;">
          üí° AI assistants can see this data when processing your notes.
        </p>
        <p style="font-size: 0.8rem; color: var(--text-secondary);">
          Masking replaces sensitive data with [****] placeholders.
        </p>
      </div>
      <div class="modal-actions" style="flex-direction: column; gap: 8px;">
        <button class="modal-btn" onclick="saveSensitiveAsMasked()" style="width: 100%; background: #10B981;">üõ°Ô∏è Mask & Save</button>
        <button class="modal-btn" onclick="saveSensitiveAsIs()" style="width: 100%; background: #6366F1;">üíæ Save As Is</button>
        <button class="modal-btn sec" onclick="closeSensitiveWarning()" style="width: 100%;">Cancel</button>
      </div>
    </div>
  </div>
  
  <div class="overlay image-viewer" id="imageViewer" onclick="handleImageViewerClick(event)">
    <div class="image-viewer-close" onclick="closeImageViewer()">‚úï</div>
    <div class="image-viewer-markers" id="imageViewerMarkers" onclick="openPhotoMarkers()"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.57a2 2 0 0 1-2.83-2.83l8.49-8.47"/></svg></div>
    <div class="image-viewer-ai" onclick="openPhotoAI()"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m12 3-1.9 5.8a2 2 0 0 1-1.3 1.3L3 12l5.8 1.9a2 2 0 0 1 1.3 1.3L12 21l1.9-5.8a2 2 0 0 1 1.3-1.3L21 12l-5.8-1.9a2 2 0 0 1-1.3-1.3Z"/></svg></div>
    <div class="image-counter" id="imageCounter">1 / 1</div>
    <div class="image-viewer-nav prev" id="imgNavPrev" onclick="navigateImage(-1)"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M15 18l-6-6 6-6"/></svg></div>
    <div class="image-viewer-nav next" id="imgNavNext" onclick="navigateImage(1)"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M9 18l6-6-6-6"/></svg></div>
    <div class="image-viewer-content" id="imageViewerContent">
      <img id="imageViewerImg" src="" alt="Full size">
    </div>
    <div class="image-viewer-panel" onclick="event.stopPropagation()">
      <div class="image-meta" id="imageMeta"></div>
      <div class="image-caption-row">
        <button class="caption-edit-btn" onclick="startEditCaption()">Edit</button>
        <div class="image-caption-display" id="imageCaptionDisplay"></div>
      </div>
      <div class="image-notes-wrap" id="imageNotesWrap">
        <textarea class="image-notes" id="imageNotes" placeholder="Add caption or notes..." rows="2"></textarea>
        <div class="image-edit-actions" id="imageEditActions">
          <button class="img-act" onclick="cancelEditCaption()">Cancel</button>
          <button class="img-act primary" onclick="saveCaption()">Save</button>
        </div>
      </div>
      <div class="image-actions" id="imageActions">
        <button class="img-act" onclick="shareImage()">Share</button>
        <button class="img-act" onclick="saveImageToGallery()">Download</button>
        <button class="img-act delete" onclick="deleteFromViewer()">Delete</button>
      </div>
    </div>
  </div>

  <!-- Photo AI Tools Modal -->
  <div class="photo-ai-modal" id="photoAIModal" onclick="if(event.target===this)closePhotoAI()">
    <div class="photo-ai-content">
      <div class="photo-ai-header">
        <h3>AI Tools</h3>
        <p>What would you like to do?</p>
      </div>
      <div class="photo-ai-tools">
        <button class="photo-ai-btn" onclick="runPhotoAI('ocr')">
          <div class="icon"><svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/></svg></div>
          <div class="info">
            <div class="title">Extract Text (OCR)</div>
            <div class="desc">Read and copy text from image</div>
          </div>
        </button>
        <button class="photo-ai-btn" onclick="runPhotoAI('describe')">
          <div class="icon"><svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg></div>
          <div class="info">
            <div class="title">Describe Image</div>
            <div class="desc">AI generates detailed description</div>
          </div>
        </button>
        <button class="photo-ai-btn" onclick="startEditCaption(); closePhotoAI();">
          <div class="icon"><svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg></div>
          <div class="info">
            <div class="title">Edit Caption</div>
            <div class="desc">Add or edit photo notes</div>
          </div>
        </button>
      </div>
      <button class="pill-l sec" onclick="closePhotoAI()">Cancel</button>
    </div>
  </div>

  <!-- Photo AI Result Modal -->
  <div class="photo-ai-result" id="photoAIResult" onclick="if(event.target===this)closePhotoAIResult()">
    <div class="photo-ai-result-content">
      <div class="photo-ai-result-header">
        <h3 id="photoAIResultTitle">Result</h3>
      </div>
      <div class="photo-ai-result-text" id="photoAIResultText"></div>
      <div class="photo-ai-result-actions">
        <button class="pill-l ai" onclick="savePhotoAIToCaption()">Set as Caption</button>
        <button class="pill-l sec" onclick="savePhotoAIToNewDrop()">Create New Drop</button>
        <button class="pill-l sec" onclick="copyPhotoAIResult()">Copy to Clipboard</button>
      </div>
    </div>
  </div>

  <!-- Photo Markers Modal -->
  <div class="photo-markers-modal" id="photoMarkersModal" onclick="if(event.target===this)closePhotoMarkersModal()">
    <div class="photo-markers-content">
      <div class="photo-markers-title">Add Markers</div>
      <div class="photo-markers-grid" id="photoMarkersGrid"></div>
      <button class="photo-markers-done" onclick="closePhotoMarkersModal()">Done</button>
    </div>
  </div>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
if('serviceWorker' in navigator){navigator.serviceWorker.register('sw.js').catch(()=>{});}

let ideas=JSON.parse(localStorage.getItem('droplit_ideas'))||[];

// ============================================
// AUTO-FIX: Repair string IDs (v0.9.58)
// ============================================
(function autoFixIds() {
  let fixed = 0;
  ideas = ideas.map((item, index) => {
    if (typeof item.id === 'string') {
      item.id = Date.now() + index; // Unique numeric ID
      fixed++;
    }
    return item;
  });
  if (fixed > 0) {
    localStorage.setItem('droplit_ideas', JSON.stringify(ideas));
    console.log(`‚úÖ Auto-fixed ${fixed} drop(s) with string IDs`);
  }
})();

let curCat='all',curTime='all',sortAsc=true,isRec=false,recognition=null,saved=false;
let sendId=null,delId=null,catChangeId=null,editId=null,activeCardId=null,creatorModalId=null;
let selectMode=false,selectedIds=[];
let lastScrollTop=0,longPressTimer=null;

// Date utility functions
function isToday(dateStr) {
  if (!dateStr) return false;
  const today = new Date().toLocaleDateString('ru-RU');
  return dateStr === today;
}

function inDays(dateStr, days) {
  if (!dateStr) return false;
  // Parse ru-RU date format (DD.MM.YYYY)
  const parts = dateStr.split('.');
  if (parts.length !== 3) return false;
  const itemDate = new Date(parts[2], parts[1] - 1, parts[0]);
  const now = new Date();
  const diffTime = now - itemDate;
  const diffDays = diffTime / (1000 * 60 * 60 * 24);
  return diffDays >= 0 && diffDays <= days;
}

// AI Configuration
const AI_API_URL = '/api/ai';
const STREAMING_ENABLED = true;
let aiProcessing = false;
let showArchived = false;
let rollUpMode = false;

function stopAllAudio() {
  document.querySelectorAll('audio').forEach(a => { a.pause(); a.currentTime = 0; });
  if (window.speechSynthesis) window.speechSynthesis.cancel();
  if (typeof window.stopTTS === 'function') window.stopTTS();
}

const ideasWrap=document.getElementById('ideasWrap');
const scrollTopBtn=document.getElementById('scrollTop');
const scrollBottomBtn=document.getElementById('scrollBottom');
let scrollTimeout=null;

ideasWrap.addEventListener('scroll',()=>{
  const st=ideasWrap.scrollTop;
  const maxScroll=ideasWrap.scrollHeight-ideasWrap.clientHeight;
  const dir=st>lastScrollTop?1:-1;
  lastScrollTop=st;
  clearTimeout(scrollTimeout);
  scrollTopBtn.classList.remove('show');
  scrollBottomBtn.classList.remove('show');
  if(maxScroll>300){
    if(dir<0 && st>200) scrollTopBtn.classList.add('show');
    else if(dir>0 && st<maxScroll-200) scrollBottomBtn.classList.add('show');
  }
  scrollTimeout=setTimeout(()=>{
    scrollTopBtn.classList.remove('show');
    scrollBottomBtn.classList.remove('show');
  },2000);
});

function scrollToTop(){ideasWrap.scrollTo({top:0,behavior:'smooth'});scrollTopBtn.classList.remove('show');}
function scrollToBottom(){ideasWrap.scrollTo({top:ideasWrap.scrollHeight,behavior:'smooth'});scrollBottomBtn.classList.remove('show');}
function scrollToBottomInstant(){ideasWrap.scrollTo({top:ideasWrap.scrollHeight,behavior:'instant'});}
function toggleSort(){sortAsc=!sortAsc;document.getElementById('sortBtn').innerHTML=sortAsc?'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M18 15l-6-6-6 6"/></svg>':'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"/></svg>';document.getElementById('sortBtn').classList.toggle('desc',!sortAsc);render();}

// Selection mode
function enterSelectMode(id){
  selectMode=true;
  selectedIds=[id];
  activeCardId=null;
  document.body.classList.add('select-mode');
  document.getElementById('fabRecord').style.display='none';
  document.getElementById('fabCamera').style.display='none';
  updateSelectBar();
  // Fast targeted update instead of render()
  const card = document.querySelector('.card[data-id="'+id+'"]');
  if(card) {
    card.classList.add('selected');
    card.classList.remove('active');
    const checkbox = card.querySelector('.card-checkbox');
    if(checkbox) checkbox.textContent = '‚úì';
  }
}

function cancelSelect(){
  // Remove selected class from tracked cards
  selectedIds.forEach(id => {
    const card = document.querySelector('.card[data-id="'+id+'"]');
    if(card) {
      card.classList.remove('selected');
      const checkbox = card.querySelector('.card-checkbox');
      if(checkbox) checkbox.textContent = '';
    }
  });
  // Fallback: remove .selected from ANY card that might have it
  document.querySelectorAll('.card.selected').forEach(card => {
    card.classList.remove('selected');
    const checkbox = card.querySelector('.card-checkbox');
    if(checkbox) checkbox.textContent = '';
  });
  selectMode=false;
  selectedIds=[];
  document.body.classList.remove('select-mode');
  document.getElementById('selectBar').classList.remove('show');
  document.getElementById('fabRecord').style.display='flex';
  document.getElementById('fabCamera').style.display='flex';
}

function deleteSelected(){
  if(selectedIds.length===0)return;
  const count=selectedIds.length;
  if(confirm('Delete '+count+' selected items?')){
    // Cancel any command drops in Supabase before deleting (v1.2)
    const commandDrops = ideas.filter(i => 
      selectedIds.includes(i.id) && 
      (i.category === 'command' || i.type === 'command') && 
      i.event_id
    );
    if (commandDrops.length > 0 && typeof DropLitNotifications !== 'undefined' && DropLitNotifications.cancelCommandDrop) {
      commandDrops.forEach(cmd => {
        DropLitNotifications.cancelCommandDrop(cmd.event_id);
      });
    }
    
    ideas=ideas.filter(i=>!selectedIds.includes(i.id));
    save();
    cancelSelect();
    render();counts();
    toast(count+' items deleted','info');
  }
}

function toggleSelect(id){
  const card = document.querySelector('.card[data-id="'+id+'"]');
  
  if(selectedIds.includes(id)){
    // DESELECT: First remove visual, then update array
    if(card) {
      card.classList.remove('selected');
      const checkbox = card.querySelector('.card-checkbox');
      if(checkbox) checkbox.textContent = '';
    }
    selectedIds=selectedIds.filter(x=>x!==id);
    if(selectedIds.length===0) {
      cancelSelect();
      // Extra safety: ensure no orphan selected cards
      document.querySelectorAll('.card.selected').forEach(c => {
        c.classList.remove('selected');
        const cb = c.querySelector('.card-checkbox');
        if(cb) cb.textContent = '';
      });
      return;
    }
    updateSelectBar();
  } else {
    // SELECT: Add to array and update visual
    selectedIds.push(id);
    updateSelectBar();
    if(card) {
      card.classList.add('selected');
      const checkbox = card.querySelector('.card-checkbox');
      if(checkbox) checkbox.textContent = '‚úì';
    }
  }
}

function updateSelectBar(){
  document.getElementById('selectCount').textContent=selectedIds.length;
  document.getElementById('selectBar').classList.toggle('show',selectMode&&selectedIds.length>0);
}

function getMergedText(simple=false){
  const selected=ideas.filter(i=>selectedIds.includes(i.id));
  // Sort by timestamp
  selected.sort((a,b)=>new Date(a.timestamp)-new Date(b.timestamp));
  
  if(simple){
    // Simple merge - just text, double newline between
    return selected.map(i=>{
      if(i.isMedia){
        return i.notes||'[Photo '+i.date+' '+i.time+']';
      }
      return i.text;
    }).join('\n\n');
  }
  
  // List merge with headers
  return selected.map(i=>{
    const cat=CATS[i.category]?.name||'INBOX';
    if(i.isMedia){
      const content=i.notes||'[Photo '+i.date+' '+i.time+']';
      return `- [${cat}] ${content}`;
    }
    return `- [${cat}] ${i.text}`;
  }).join('\n');
}

function updateMergePreview(){
  const simple=document.getElementById('mergeSimple').checked;
  document.getElementById('mergePreview').textContent=getMergedText(simple);
}

function showMergePreview(){
  if(selectedIds.length<2){toast('Select at least 2 cards','warning');return;}
  // Check if any selected item is media
  const hasMedia=selectedIds.some(id=>{
    const item=ideas.find(x=>x.id===id);
    return item&&item.isMedia;
  });
  if(hasMedia){toast('Cannot merge media items','warning');return;}
  
  // Get current checkbox state and update preview accordingly
  const simple=document.getElementById('mergeSimple').checked;
  const mergedText = getMergedText(simple);
  document.getElementById('mergePreview').textContent=mergedText;
  
  // Warning for large merge
  const charCount = mergedText.length;
  if (charCount > 10000) {
    toast(`Large merge: ${Math.round(charCount/1000)}K chars`, 'warning');
  }
  
  document.getElementById('mergeModal').classList.add('show');
}

function closeMergeModal(){stopAllAudio();document.getElementById('mergeModal').classList.remove('show');}

function copyMerged(){
  const simple=document.getElementById('mergeSimple').checked;
  navigator.clipboard.writeText(getMergedText(simple));
  toast('Copied to clipboard!','success');
  closeMergeModal();
}

function saveMerged(){
  const simple=document.getElementById('mergeSimple').checked;
  const text=getMergedText(simple);
  
  // Check size limit
  const MAX_DROP_SIZE = 50000; // 50KB
  if (text.length > MAX_DROP_SIZE) {
    toast(`Too large! Max: ${MAX_DROP_SIZE/1000}K chars`, 'error');
    return;
  }
  
  const mergedId = Date.now();
  const idea={id:mergedId,text:text,category:'inbox',timestamp:new Date().toISOString(),date:new Date().toLocaleDateString('ru-RU'),time:new Date().toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'}),isMerged:true,encrypted:window.DROPLIT_PRIVACY_ENABLED||false};
  ideas.push(idea);
  
  // Save undo
  saveUndo('merge', { mergedId: mergedId, count: selectedIds.length });
  
  save();
  playDropSound(); // Play signature sound
  closeMergeModal();
  cancelSelect();
  resetToShowAll();
  toast('Merged & saved!','success');
}

// Card interactions
function handleCardClick(id,e){
  // Ignore clicks on category badge, action buttons, textarea, checkbox, markers
  if(e.target.closest('.card-cat')||e.target.closest('.act')||e.target.closest('.card-ta')||e.target.closest('.card-checkbox')||e.target.closest('.card-markers')||e.target.closest('.card-avatar'))return;
  
  // Ignore clicks on audio player buttons only
  if(e.target.closest('.audio-btn'))return;
  
  // Convert id to string for comparison (handles UUID strings)
  const idStr = String(id);
  const item=ideas.find(x=>String(x.id)===idStr);
  
  if(selectMode){
    // In select mode - always toggle selection
    toggleSelect(id);
  } else if(editId && editId !== id) {
    // If editing another card, don't activate this one
    return;
  } else if(item && item.isMedia && item.category !== 'audio') {
    // For image/photo cards - open viewer directly (NOT for audio)
    viewImage(id,e);
  } else {
    // For text cards AND audio cards - toggle expand/collapse
    const prevId = activeCardId;
    activeCardId = activeCardId===id ? null : id;
    
    // Stop audio when deactivating or switching cards
    if(prevId) stopAllAudio();
    
    // Fast class manipulation (no render)
    if(prevId) {
      const prevCard = document.querySelector('.card[data-id="'+prevId+'"]');
      if(prevCard) {
        prevCard.classList.remove('active');
        if(rollUpMode) prevCard.classList.add('roll-up');
      }
    }
    if(activeCardId) {
      const newCard = document.querySelector('.card[data-id="'+activeCardId+'"]');
      if(newCard) {
        // Remember top position before expanding
        const topBefore = newCard.getBoundingClientRect().top;
        
        newCard.classList.add('active');
        newCard.classList.remove('roll-up');
        
        // Keep top position fixed (expand only down)
        requestAnimationFrame(() => {
          const topAfter = newCard.getBoundingClientRect().top;
          const diff = topAfter - topBefore;
          if(Math.abs(diff) > 2) {
            ideasWrap.scrollTop += diff;
          }
        });
      }
    }
  }
}

function toggleMarker(id,marker,e){
  if(e){e.stopPropagation();}
  const item=ideas.find(x=>x.id===id);
  if(!item)return;
  
  // Initialize markers array if needed
  if(!item.markers)item.markers=[];
  
  // Toggle marker (silent - no toast per B3 fix)
  const idx=item.markers.indexOf(marker);
  if(idx===-1){
    item.markers.push(marker);
  } else {
    item.markers.splice(idx,1);
  }
  
  save();
  
  // Fast DOM update (no render)
  const card = document.querySelector('.card[data-id="'+id+'"]');
  if(card) {
    // 1. Update header marker display
    const row2 = card.querySelector('.card-row2');
    if(row2) {
      let existingMarker = row2.querySelector('.card-marker');
      if(item.markers && item.markers.length) {
        const markerText = item.markers.map(m => MARKERS[m] || '').join('');
        if(existingMarker) {
          existingMarker.textContent = markerText;
        } else {
          // Insert before NEW badge if exists, otherwise at end
          const newBadge = row2.querySelector('.new-badge');
          const span = document.createElement('span');
          span.className = 'card-marker';
          span.textContent = markerText;
          if(newBadge) {
            row2.insertBefore(span, newBadge);
          } else {
            row2.appendChild(span);
          }
        }
      } else if(existingMarker) {
        existingMarker.remove();
      }
    }
    
    // 2. Update marker buttons state
    const markersPanel = card.querySelector('.card-markers');
    if(markersPanel) {
      markersPanel.querySelectorAll('.marker-btn').forEach(btn => {
        const mk = Object.keys(MARKERS).find(k => MARKERS[k] === btn.textContent);
        if(mk) {
          btn.classList.toggle('active', item.markers && item.markers.includes(mk));
        }
      });
    }
  }
  
  // Update photo markers button if in image viewer
  if(currentImageId === id) {
    updatePhotoMarkersButton();
  }
}

function handleCardLongPress(id){
  if(!selectMode){
    enterSelectMode(id);
    if(navigator.vibrate)navigator.vibrate(50);
  }
}

let touchStartX=0,touchStartY=0;
let swipeCardId=null,swipeCardEl=null; // Swipe state (v0.9.111)

function cardTouchStart(id,e){
  if(selectMode||editId)return;
  const touch=e.touches[0];
  touchStartX=touch.clientX;
  touchStartY=touch.clientY;
  
  // Swipe init (v0.9.117)
  // Block swipe: when archived shown, OR card is active (action buttons visible)
  const card = e.target.closest('.card');
  const isActive = card && card.classList.contains('active');
  
  if(!showArchived && !isActive){
    swipeCardId = id;
    swipeCardEl = card;
  } else {
    swipeCardId = null;
    swipeCardEl = null;
  }
  
  longPressTimer=setTimeout(()=>handleCardLongPress(id),800);
}

function cardTouchMove(e){
  const touch=e.touches[0];
  const dx=touch.clientX-touchStartX;
  const dy=touch.clientY-touchStartY;
  const absDx=Math.abs(dx);
  const absDy=Math.abs(dy);
  
  // Cancel long press if moved
  if(longPressTimer && (absDx>10||absDy>10)){
    clearTimeout(longPressTimer);
    longPressTimer=null;
  }
  
  // Swipe left only (v0.9.113)
  if(swipeCardEl && dx < -20 && absDx > absDy * 1.5){
    e.preventDefault();
    const swipeX = Math.max(dx, -100);
    swipeCardEl.style.transform = `translateX(${swipeX}px)`;
    swipeCardEl.style.transition = 'none';
  }
}

function cardTouchEnd(){
  clearTimeout(longPressTimer);
  longPressTimer=null;
  
  // Swipe end (v0.9.117)
  if(swipeCardEl){
    const transform = swipeCardEl.style.transform;
    const match = transform.match(/translateX\((-?[\d.]+)px\)/);
    const swipeX = match ? parseFloat(match[1]) : 0;
    
    if(swipeX < -60){
      // Archive with animation
      animateArchive(swipeCardEl, swipeCardId);
    } else {
      // ALWAYS snap back to 0 - fix for stuck cards
      swipeCardEl.style.transition = 'transform 0.2s ease-out';
      swipeCardEl.style.transform = 'translateX(0)';
    }
  }
  
  // Reset swipe state
  swipeCardId = null;
  swipeCardEl = null;
}

// ============================================
// FAST ARCHIVE ANIMATION (v0.9.117)
// Gmail-style: slide out, collapse, done
// ============================================

function animateArchive(cardEl, cardId) {
  if (!cardEl) return;
  
  // Prevent double-trigger
  if (cardEl.dataset.archiving) return;
  cardEl.dataset.archiving = 'true';
  
  // 1. Slide out animation
  cardEl.style.transition = 'transform 0.2s ease-out, opacity 0.2s ease-out';
  cardEl.style.transform = 'translateX(-100%)';
  cardEl.style.opacity = '0';
  
  // 2. After slide, collapse height smoothly
  setTimeout(() => {
    cardEl.style.height = cardEl.offsetHeight + 'px';
    cardEl.style.overflow = 'hidden';
    // Force reflow
    void cardEl.offsetHeight;
    
    cardEl.style.transition = 'height 0.15s ease-out, margin 0.15s ease-out, padding 0.15s ease-out';
    cardEl.style.height = '0';
    cardEl.style.marginTop = '0';
    cardEl.style.marginBottom = '0';
    cardEl.style.paddingTop = '0';
    cardEl.style.paddingBottom = '0';
  }, 200);
  
  // 3. After collapse, remove and update data
  setTimeout(() => {
    cardEl.remove();
    archiveDropSilent(cardId);
  }, 380);
}

// Archive without render() - just update data
function archiveDropSilent(id) {
  const item = ideas.find(x => x.id == id);
  if (!item) return;
  
  // Save undo
  if (typeof saveUndo === 'function') {
    saveUndo('archive', {...item});
  }
  
  // Mark as archived
  item.lifecycle_state = 'archived';
  item.archived_at = new Date().toISOString();
  
  // Save locally
  save();
  
  // Update counts only (fast)
  activeCardId = null;
  counts();
  
  // Update undo UI
  if (typeof updateUndoList === 'function') {
    updateUndoList();
  }
  
  // Sync to server in background
  if (syncEnabled && currentUser) {
    setTimeout(() => syncDropToServer(item, 'update'), 100);
  }
}

document.addEventListener('click',(e)=>{
  if(activeCardId&&!e.target.closest('.card')&&!e.target.closest('.overlay')&&!e.target.closest('.fab-record')&&!e.target.closest('.select-bar')){
    stopAllAudio();
    const prevCard = document.querySelector('.card[data-id="'+activeCardId+'"]');
    if(prevCard) {
      prevCard.classList.remove('active');
      if(rollUpMode) prevCard.classList.add('roll-up');
    }
    activeCardId=null;
  }
});

function initSR(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){document.getElementById('warning').style.display='block';document.getElementById('fabRecord').style.opacity='0.5';return false;}
  recognition=new SR();
  recognition.lang='ru-RU';
  recognition.continuous=false;
  recognition.interimResults=true;
  recognition.maxAlternatives=1;
  recognition.onstart=async()=>{isRec=true;saved=false;updateRecUI(true);await acquireWakeLock();};
  recognition.onresult=(e)=>{
    let f='',i='';
    for(let x=0;x<e.results.length;x++){if(e.results[x].isFinal)f+=e.results[x][0].transcript;else i+=e.results[x][0].transcript;}
    document.getElementById('recText').textContent=(f||i)||'Listening...';
    if(f&&!saved){saved=true;saveIdea(f.trim());}
  };
  recognition.onerror=(e)=>{
    if(e.error==='no-speech')toast('No speech detected','warning');
    else if(e.error==='not-allowed')toast('Microphone access denied','error');
    isRec=false;updateRecUI(false);releaseWakeLock();
  };
  recognition.onend=()=>{isRec=false;updateRecUI(false);releaseWakeLock();};
  return true;
}

// B4 FIX: Wake Lock to prevent screen from turning off during recording
let wakeLock = null;
async function acquireWakeLock() {
  if ('wakeLock' in navigator) {
    try { 
      wakeLock = await navigator.wakeLock.request('screen');
      console.log('Wake Lock acquired');
      // Re-acquire if released (e.g., when tab becomes visible again)
      wakeLock.addEventListener('release', () => {
        console.log('Wake Lock released');
        wakeLock = null;
      });
    } 
    catch (err) { console.log('Wake Lock error:', err); }
  }
}
function releaseWakeLock() {
  if (wakeLock) { 
    wakeLock.release(); 
    wakeLock = null; 
    console.log('Wake Lock released manually');
  }
}

// ===== FAB DOUBLE-TAP & LONG-PRESS =====
let fabLastTap = 0;
let fabLongPressTimer = null;

function handleFabClick(event) {
  const now = Date.now();
  const timeDiff = now - fabLastTap;
  fabLastTap = now;
  
  // Double-tap detection (within 300ms)
  if (timeDiff < 300 && timeDiff > 0) {
    event.preventDefault();
    openAudioRecorder();
    return;
  }
  
  // Single tap - normal voice recognition
  toggleRec();
}

function fabTouchStart() {
  // Long press detection (500ms)
  fabLongPressTimer = setTimeout(() => {
    openAudioRecorder();
    fabLongPressTimer = null;
  }, 500);
}

function fabTouchEnd() {
  if (fabLongPressTimer) {
    clearTimeout(fabLongPressTimer);
    fabLongPressTimer = null;
  }
}

function toggleRec(){if(isRec)recognition.stop();else{saved=false;recognition.start();}}
function updateRecUI(on){
  const fab=document.getElementById('fabRecord'),status=document.getElementById('recStatus');
  if(on){fab.classList.add('recording');status.classList.add('show');document.getElementById('recText').textContent='Listening...';}
  else{fab.classList.remove('recording');status.classList.remove('show');}
}
function detectCat(t){
  const l=t.toLowerCase();
  for(const[k,v]of Object.entries(CATS)){
    if(k==='inbox'||!v.kw||v.kw.length===0)continue;
    for(const w of v.kw){
      // Check: starts with word, contains word with spaces, or ends with word
      if(l.startsWith(w+' ')||l.startsWith(w+',')||l.startsWith(w+'.')||
         l.includes(' '+w+' ')||l.includes(' '+w+',')||l.includes(' '+w+'.')||
         l.endsWith(' '+w)||l===w)return k;
    }
  }
  return'inbox';
}
function saveIdea(t){
  // ============================================
  // SLASH COMMANDS (v0.9.58)
  // ============================================
  if (t.startsWith('/')) {
    const cmd = t.toLowerCase().trim();
    
    if (cmd === '/fix') {
      // Fix string IDs
      let fixed = 0;
      ideas = ideas.map((item, index) => {
        if (typeof item.id === 'string') {
          item.id = Date.now() + index;
          fixed++;
        }
        return item;
      });
      if (fixed > 0) {
        localStorage.setItem('droplit_ideas', JSON.stringify(ideas));
        toast(`‚úÖ Fixed ${fixed} drop(s)!`, 'success');
        render();
      } else {
        toast('All IDs are OK!', 'info');
      }
      return;
    }
    
    if (cmd === '/debug') {
      // Show debug info
      const total = ideas.length;
      const stringIds = ideas.filter(i => typeof i.id === 'string').length;
      const merged = ideas.filter(i => i.isMerged).length;
      const audio = ideas.filter(i => i.category === 'audio').length;
      const userId = currentUser ? currentUser.id.substring(0, 8) + '...' : 'Not logged in';
      const deviceId = DEVICE_ID || 'Not set';
      const syncStatus = syncEnabled ? 'Enabled' : 'Disabled';
      alert(`DropLit Debug v0.9.83\n\n=== DROPS ===\nTotal: ${total}\nString IDs: ${stringIds}\nMerged: ${merged}\nAudio: ${audio}\n\n=== SYNC ===\nUser ID: ${userId}\nDevice ID: ${deviceId}\nSync: ${syncStatus}\n\n=== STORAGE ===\nLocalStorage: ${(localStorage.getItem('droplit_ideas')?.length / 1024).toFixed(1)} KB`);
      return;
    }
    
    if (cmd === '/clear') {
      if (confirm('‚ö†Ô∏è Delete ALL drops? This cannot be undone!')) {
        ideas = [];
        localStorage.removeItem('droplit_ideas');
        toast('All drops deleted', 'warning');
        render();
        counts();
      }
      return;
    }
    
    if (cmd === '/help') {
      alert('DropLit Commands:\n\n/fix - Repair broken IDs\n/debug - Show stats\n/clear - Delete all drops\n/help - This message');
      return;
    }
  }
  
  const c=detectCat(t);
  const idea={id:Date.now(),text:t,category:c,timestamp:new Date().toISOString(),date:new Date().toLocaleDateString('ru-RU'),time:new Date().toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'}),isMedia:false,encrypted:window.DROPLIT_PRIVACY_ENABLED||false};
  ideas.push(idea);save(idea);
  playDropSound(); // Play signature sound
  resetToShowAll();
  // Show encryption indicator if privacy enabled
  const encIcon = window.DROPLIT_PRIVACY_ENABLED ? 'üîê ' : '';
  toast(encIcon + 'Saved to '+CATS[c].name,'success');
}

function resetToShowAll(){
  try{
    // Reset filter variables
    curCat='all';
    curTime='7days';
    activeCardId=null;
    sortAsc=true;
    // Update sort button UI
    const sortBtn=document.getElementById('sortBtn');
    if(sortBtn){
      sortBtn.innerHTML='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M18 15l-6-6-6 6"/></svg>';
      sortBtn.classList.remove('desc');
    }
    // Remove active class from category buttons
    document.querySelectorAll('.cat').forEach(x=>x.classList.remove('active'));
    // Update time buttons - activate 7d
    document.querySelectorAll('.time-btn').forEach(x=>x.classList.remove('active'));
    const btn7d=document.querySelector('.time-btn[data-time="7days"]');
    if(btn7d)btn7d.classList.add('active');
    // Render and scroll (instant, no animation)
    render();
    counts();
    setTimeout(()=>{
      const wrap=document.getElementById('ideasWrap');
      if(wrap)wrap.scrollTo({top:wrap.scrollHeight,behavior:'auto'});
    },50);
  }catch(err){
    console.error('resetToShowAll error:',err);
  }
}

function handlePhoto(e){
  const file=e.target.files[0];
  if(!file)return;
  
  toast('Processing photo...','info');
  
  // Compress image before saving
  const img=new Image();
  img.onload=function(){
    const canvas=document.createElement('canvas');
    const maxSize=1200; // Max dimension
    let w=img.width,h=img.height;
    
    if(w>maxSize||h>maxSize){
      if(w>h){h=Math.round(h*maxSize/w);w=maxSize;}
      else{w=Math.round(w*maxSize/h);h=maxSize;}
    }
    
    canvas.width=w;
    canvas.height=h;
    const ctx=canvas.getContext('2d');
    ctx.drawImage(img,0,0,w,h);
    
    // Compress to JPEG 70% quality
    const dataUrl=canvas.toDataURL('image/jpeg',0.7);
    savePhoto(dataUrl,null);
  };
  img.onerror=function(){
    toast('Failed to load photo','error');
  };
  
  const reader=new FileReader();
  reader.onload=function(ev){
    img.src=ev.target.result;
  };
  reader.onerror=function(){
    toast('Failed to read photo','error');
  };
  reader.readAsDataURL(file);
  e.target.value='';
}

function savePhoto(dataUrl,geo){
  const idea={
    id:Date.now(),
    text:'',
    notes:'',
    image:dataUrl,
    category:'photo',
    timestamp:new Date().toISOString(),
    date:new Date().toLocaleDateString('ru-RU'),
    time:new Date().toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'}),
    geo:geo,
    isMedia:true,
    encrypted:window.DROPLIT_PRIVACY_ENABLED||false
  };
  ideas.push(idea);
  save();
  playDropSound(); // Play signature sound
  const encIcon = window.DROPLIT_PRIVACY_ENABLED ? 'üîê ' : '';
  toast(encIcon + 'Photo saved!','success');
  try{
    resetToShowAll();
  }catch(err){
    // Silent fail - photo is saved
  }
}

// ============================================
// PLUS MENU FUNCTIONS
// ============================================

function togglePlusMenu(){
  const menu=document.getElementById('plusMenu');
  const backdrop=document.getElementById('plusBackdrop');
  
  if(menu.classList.contains('show')){
    closePlusMenu();
  } else {
    menu.classList.add('show');
    backdrop.classList.add('show');
  }
}

function closePlusMenu(){
  document.getElementById('plusMenu').classList.remove('show');
  document.getElementById('plusBackdrop').classList.remove('show');
}

// ============================================
// CREATE COMMAND MODAL (v1.1)
// ============================================

function openCreateCommand(){
  closePlusMenu();
  initCommandVoice();
  document.getElementById('createCommandModal').classList.add('show');
  document.getElementById('commandInput').focus();
}

function closeCreateCommand(){
  document.getElementById('createCommandModal').classList.remove('show');
  document.getElementById('commandInput').value = '';
  showCommandView('input');
  updateCommandButton();
}

// Command modal state
let commandRecognition = null;
let isCommandRecording = false;

// Switch command views
function showCommandView(viewId) {
  document.querySelectorAll('#createCommandModal .cmd-view').forEach(v => v.classList.remove('active'));
  document.getElementById('cmd' + viewId.charAt(0).toUpperCase() + viewId.slice(1) + 'View')?.classList.add('active');
}

// Update command button state
function updateCommandButton() {
  const input = document.getElementById('commandInput');
  const btn = document.getElementById('commandActionBtn');
  if (!input || !btn) return;
  
  const hasText = input.value.trim().length > 0;
  const iconEl = btn.querySelector('.icon');
  const textEl = btn.querySelector('.text');
  
  btn.classList.remove('voice', 'recording', 'create');
  
  if (isCommandRecording) {
    btn.classList.add('recording');
    iconEl.textContent = '‚èπ';
    textEl.textContent = 'TAP TO STOP';
    input.classList.add('recording');
  } else if (hasText) {
    btn.classList.add('create');
    iconEl.textContent = 'üöÄ';
    textEl.textContent = 'CREATE COMMAND';
    input.classList.remove('recording');
  } else {
    btn.classList.add('voice');
    iconEl.textContent = 'üé§';
    textEl.textContent = 'TAP TO COMMAND';
    input.classList.remove('recording');
  }
  
  // Clear button
  const clearBtn = document.getElementById('commandClearBtn');
  if (clearBtn) clearBtn.classList.toggle('visible', hasText);
}

// Init command voice recognition (lazy)
function initCommandVoice() {
  if (commandRecognition) return;
  
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) {
    console.log('[Command] Speech recognition not supported');
    return;
  }
  
  commandRecognition = new SR();
  commandRecognition.lang = 'ru-RU';
  commandRecognition.continuous = false;
  commandRecognition.interimResults = true;
  commandRecognition.maxAlternatives = 1;
  
  commandRecognition.onstart = () => {
    isCommandRecording = true;
    updateCommandButton();
  };
  
  commandRecognition.onresult = (event) => {
    let final = '', interim = '';
    for (let i = 0; i < event.results.length; i++) {
      if (event.results[i].isFinal) {
        final += event.results[i][0].transcript;
      } else {
        interim += event.results[i][0].transcript;
      }
    }
    const input = document.getElementById('commandInput');
    if (input) {
      input.value = final || interim;
      updateCommandButton();
    }
  };
  
  commandRecognition.onerror = (e) => {
    console.log('[Command] Speech error:', e.error);
    if (e.error === 'no-speech') toast('No speech detected', 'warning');
    else if (e.error === 'not-allowed') toast('Microphone access denied', 'error');
    isCommandRecording = false;
    updateCommandButton();
  };
  
  commandRecognition.onend = () => {
    isCommandRecording = false;
    updateCommandButton();
  };
}

// Command action button click
function handleCommandAction() {
  const input = document.getElementById('commandInput');
  const hasText = input.value.trim().length > 0;
  
  if (isCommandRecording) {
    commandRecognition?.stop();
  } else if (hasText) {
    createCommandFromUI();
  } else {
    if (commandRecognition) {
      commandRecognition.start();
    } else {
      toast('Voice input not supported', 'error');
    }
  }
}

// Create command from UI (uses ASKI backend)
async function createCommandFromUI() {
  const text = document.getElementById('commandInput').value.trim();
  if (!text) {
    toast('Enter command text', 'warning');
    return;
  }
  
  const btn = document.getElementById('commandActionBtn');
  const iconEl = btn.querySelector('.icon');
  const textEl = btn.querySelector('.text');
  iconEl.textContent = '‚è≥';
  textEl.textContent = 'Creating...';
  btn.disabled = true;
  
  try {
    // Get values from Details view
    const titleInput = document.getElementById('commandTitleInput');
    const timeInput = document.getElementById('commandTimeInput');
    const notifySelect = document.getElementById('commandNotifySelect');
    
    const title = (titleInput && titleInput.value.trim()) || text;
    const actionType = notifySelect ? notifySelect.value : 'push';
    
    // Build message for ASKI
    let askiMessage = title;
    if (timeInput && timeInput.value) {
      const d = new Date(timeInput.value);
      askiMessage = `–ù–∞–ø–æ–º–Ω–∏ ${d.toLocaleDateString('ru-RU')} –≤ ${d.toLocaleTimeString('ru-RU', {hour:'2-digit', minute:'2-digit'})} ${title}`;
    } else {
      // If no time specified, add "–Ω–∞–ø–æ–º–Ω–∏ —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç" as default
      if (!askiMessage.toLowerCase().includes('–Ω–∞–ø–æ–º–Ω–∏')) {
        askiMessage = '–ù–∞–ø–æ–º–Ω–∏ —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç ' + askiMessage;
      }
    }
    
    console.log('[Command UI] Sending to AI:', askiMessage);
    
    // Direct API call (–±–µ–∑ UI —á–∞—Ç–∞)
    const response = await fetch(AI_API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'chat',
        text: askiMessage,
        history: [],
        stream: true,
        enableTools: true,
        userId: window.currentUser?.id,
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
      })
    });
    
    if (!response.ok) {
      throw new Error('API error: ' + response.status);
    }
    
    // Handle streaming response
    const contentType = response.headers.get('content-type') || '';
    if (contentType.includes('text/event-stream')) {
      await handleCommandStreamResponse(response);
    } else {
      const data = await response.json();
      if (data.createEvent?.command) {
        // Non-streaming: manually create the drop
        processCommandEvent(data.createEvent.command);
      } else if (data.error) {
        throw new Error(data.error);
      }
    }
    
    // Success!
    showCommandView('success');
    
  } catch (err) {
    console.error('[Command] Error:', err);
    toast('Error: ' + (err.message || 'failed to create'), 'error');
    updateCommandButton();
    btn.disabled = false;
  }
}

// Handle streaming response for command creation
async function handleCommandStreamResponse(response) {
  const reader = response.body.getReader();
  const decoder = new TextDecoder();
  let buffer = '';
  
  while (true) {
    const { done, value } = await reader.read();
    if (done) break;
    
    buffer += decoder.decode(value, { stream: true });
    const lines = buffer.split('\n');
    buffer = lines.pop() || '';
    
    for (const line of lines) {
      if (line.startsWith('data: ')) {
        const data = line.slice(6);
        if (data === '[DONE]') continue;
        
        try {
          const parsed = JSON.parse(data);
          
          // Check for command creation
          if (parsed.createEvent?.action === 'create_event' && parsed.createEvent?.command) {
            processCommandEvent(parsed.createEvent.command);
          }
          
          // Check for validation error
          if (parsed.createEvent?.error) {
            toast(parsed.createEvent.error, 'error');
          }
        } catch (e) {
          // Ignore parse errors for text chunks
        }
      }
    }
  }
}

// Process command event and create local drop
function processCommandEvent(cmd) {
  const now = new Date();
  const eventId = cmd.id;
  
  // Format scheduled time
  let scheduledDateStr = '';
  let scheduledTimeStr = '';
  
  if (cmd.scheduled_at) {
    const scheduledDate = new Date(cmd.scheduled_at);
    if (!isNaN(scheduledDate.getTime())) {
      scheduledDateStr = scheduledDate.toLocaleDateString('ru-RU', {day:'2-digit', month:'2-digit'});
      scheduledTimeStr = scheduledDate.toLocaleTimeString('ru-RU', {hour:'2-digit', minute:'2-digit'});
    }
  }
  
  // Build drop text (–±–µ–∑ –∏–∫–æ–Ω–∫–∏ ‚Äî –æ–Ω–∞ —Ä–µ–Ω–¥–µ—Ä–∏—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏)
  let dropText;
  if (scheduledDateStr && scheduledTimeStr) {
    dropText = `${scheduledDateStr} ${scheduledTimeStr} ${cmd.title}`;
  } else if (scheduledTimeStr) {
    dropText = `${scheduledTimeStr} ${cmd.title}`;
  } else {
    dropText = cmd.title;
  }
  
  const newIdea = {
    id: eventId || Date.now().toString(),
    text: dropText,
    content: dropText,
    category: 'command',
    type: 'command',
    timestamp: now.toISOString(),
    created_at: now.toISOString(),
    scheduled_at: cmd.scheduled_at,
    event_id: eventId,
    status: 'pending',
    date: now.toLocaleDateString('ru-RU'),
    time: now.toLocaleTimeString('ru-RU', {hour:'2-digit', minute:'2-digit'}),
    isMedia: false,
    source: 'command_modal',
    creator: 'user',
    sense_type: 'reminder',
    action_type: cmd.action_type || 'push',
    encrypted: window.DROPLIT_PRIVACY_ENABLED || false
  };
  
  // Add to ideas
  ideas.push(newIdea);
  localStorage.setItem('droplit_ideas', JSON.stringify(ideas));
  
  // Play sound
  if (typeof playDropSound === 'function') {
    playDropSound();
  }
  
  // Refresh feed
  if (typeof resetToShowAll === 'function') {
    resetToShowAll();
  } else {
    render();
  }
  
  console.log('‚úÖ [Command UI] Created:', newIdea.id, dropText);
  toast('‚ö° ' + scheduledTimeStr + ' ' + cmd.title, 'success');
}

// Quick time buttons
function setCommandQuickTime(minutes) {
  const input = document.getElementById('commandTimeInput');
  if (!input) return;
  const d = new Date(Date.now() + minutes * 60000);
  input.value = d.toISOString().slice(0, 16);
}

// Apply template
function applyCommandTemplate(template) {
  const templates = {
    morning: { text: 'Morning routine - start the day', time: '07:00' },
    meeting: { text: 'Meeting reminder', time: '+15' },
    medicine: { text: 'Take medication', time: '09:00' },
    call: { text: 'Call back', time: '+30' },
    water: { text: 'Drink water', time: '+60' },
    break: { text: 'Take a break', time: '+120' }
  };
  
  const t = templates[template];
  if (t) {
    document.getElementById('commandInput').value = t.text;
    updateCommandButton();
    showCommandView('input');
  }
}

// TEXT NOTE
function openTextInput(){
  closePlusMenu();
  document.getElementById('textInputModal').classList.add('show');
  setTimeout(()=>{
    document.getElementById('textInputArea').focus();
  },100);
}

function closeTextInput(){
  document.getElementById('textInputModal').classList.remove('show');
  document.getElementById('textInputArea').value='';
}

function saveTextNote(){
  const text=document.getElementById('textInputArea').value.trim();
  if(!text){
    toast('Please enter some text','error');
    return;
  }
  
  // Check for sensitive data before saving
  checkSensitiveBeforeSave(text, (finalText) => {
    const category=detectCat(finalText);
    const idea={
      id:Date.now(),
      text:finalText,
      category:category,
      timestamp:new Date().toISOString(),
      date:new Date().toLocaleDateString('ru-RU'),
      time:new Date().toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'}),
      encrypted:window.DROPLIT_PRIVACY_ENABLED||false
    };
    ideas.push(idea);
    save();
    playDropSound();
    const encIcon = window.DROPLIT_PRIVACY_ENABLED ? 'üîê ' : '';
    toast(encIcon + 'Note saved!','success');
    closeTextInput();
    resetToShowAll();
  });
}

// PASTE LINK
async function pasteLink(){
  closePlusMenu();
  
  try{
    // Try to read from clipboard
    const text=await navigator.clipboard.readText();
    
    if(text&&isUrl(text.trim())){
      createLinkCard(text.trim());
    } else if(text&&text.trim()){
      // Not a URL but has text - ask user
      toast('Clipboard: "'+text.substring(0,30)+'..."','info');
      // Create as text note with the link
      const category=detectCat(text);
      const idea={
        id:Date.now(),
        text:text.trim(),
        category:category,
        timestamp:new Date().toISOString(),
        date:new Date().toLocaleDateString('ru-RU'),
        time:new Date().toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'}),
        encrypted:window.DROPLIT_PRIVACY_ENABLED||false
      };
      ideas.push(idea);
      save();
      playDropSound();
      toast('Saved from clipboard!','success');
      resetToShowAll();
    } else {
      toast('Clipboard is empty','error');
    }
  }catch(err){
    // Clipboard API not available or denied
    toast('Cannot access clipboard. Please paste manually.','error');
    openTextInput();
  }
}

function isUrl(str){
  return /^(https?:\/\/|www\.)/i.test(str);
}

function createLinkCard(url){
  // Ensure URL has protocol
  let href=url;
  if(url.startsWith('www.'))href='https://'+url;
  
  const idea={
    id:Date.now(),
    text:href,
    category:'link',
    timestamp:new Date().toISOString(),
    date:new Date().toLocaleDateString('ru-RU'),
    time:new Date().toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'}),
    isLink:true,
    encrypted:window.DROPLIT_PRIVACY_ENABLED||false
  };
  ideas.push(idea);
  save();
  playDropSound();
  toast('Link saved!','success');
  resetToShowAll();
}

// UPLOAD IMAGE
function uploadImage(){
  closePlusMenu();
  document.getElementById('imageUpload').click();
}

function handleUploadedImage(e){
  const file=e.target.files[0];
  if(!file)return;
  
  toast('Processing image...','info');
  
  // Compress image before saving
  const img=new Image();
  img.onload=function(){
    const canvas=document.createElement('canvas');
    const maxSize=1200;
    let w=img.width,h=img.height;
    
    if(w>maxSize||h>maxSize){
      if(w>h){h=Math.round(h*maxSize/w);w=maxSize;}
      else{w=Math.round(w*maxSize/h);h=maxSize;}
    }
    
    canvas.width=w;
    canvas.height=h;
    const ctx=canvas.getContext('2d');
    ctx.drawImage(img,0,0,w,h);
    
    const dataUrl=canvas.toDataURL('image/jpeg',0.7);
    
    // Save as uploaded image (no geo)
    const idea={
      id:Date.now(),
      text:'',
      notes:'',
      image:dataUrl,
      category:'photo',
      timestamp:new Date().toISOString(),
      date:new Date().toLocaleDateString('ru-RU'),
      time:new Date().toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'}),
      geo:null,
      isMedia:true,
      isUploaded:true,
      encrypted:window.DROPLIT_PRIVACY_ENABLED||false
    };
    ideas.push(idea);
    save();
    playDropSound();
    toast('Image uploaded!','success');
    resetToShowAll();
  };
  img.onerror=function(){
    toast('Failed to load image','error');
  };
  
  const reader=new FileReader();
  reader.onload=function(ev){
    img.src=ev.target.result;
  };
  reader.onerror=function(){
    toast('Failed to read image','error');
  };
  reader.readAsDataURL(file);
  e.target.value='';
}

// ============================================
// FILE UPLOAD (v0.8.2)
// ============================================

const MAX_FILE_SIZE = 50 * 1024; // 50KB limit
const SUPPORTED_TEXT_EXTENSIONS = ['txt', 'md', 'csv', 'json'];

function uploadFile(){
  closePlusMenu();
  document.getElementById('fileUpload').click();
}

function handleUploadedFile(e){
  const file = e.target.files[0];
  if (!file) return;
  
  // Check extension
  const ext = file.name.split('.').pop().toLowerCase();
  if (!SUPPORTED_TEXT_EXTENSIONS.includes(ext)) {
    toast('Supported: .txt, .md, .csv, .json', 'error');
    e.target.value = '';
    return;
  }
  
  // Check size
  if (file.size > MAX_FILE_SIZE) {
    const sizeKB = Math.round(file.size / 1024);
    toast(`File too large (${sizeKB}KB). Max: 50KB`, 'error');
    e.target.value = '';
    return;
  }
  
  toast('Reading file...', 'info');
  
  const reader = new FileReader();
  reader.onload = function(ev) {
    const text = ev.target.result;
    
    if (!text || text.trim().length === 0) {
      toast('File is empty', 'error');
      return;
    }
    
    // Create drop from file content
    const idea = {
      id: Date.now(),
      text: text.trim(),
      category: detectCat(text.trim()),
      timestamp: new Date().toISOString(),
      date: new Date().toLocaleDateString('ru-RU'),
      time: new Date().toLocaleTimeString('ru-RU', {hour:'2-digit', minute:'2-digit'}),
      isImported: true,
      sourceFile: file.name,
      encrypted: window.DROPLIT_PRIVACY_ENABLED || false
    };
    
    ideas.push(idea);
    save();
    
    const charCount = text.length;
    toast(`Imported! ${charCount} chars from ${file.name}`, 'success');
    resetToShowAll();
  };
  
  reader.onerror = function() {
    toast('Failed to read file', 'error');
  };
  
  reader.readAsText(file);
  e.target.value = '';
}

function aiProcess(id){toast('AI processing coming soon!','info');}
function openCatModal(id){
  catChangeId=id;
  const item=ideas.find(x=>x.id===id);
  const isMedia=item?.isMedia;
  const grid=document.querySelector('#catModal .cat-grid');
  // Show only appropriate categories
  grid.querySelectorAll('.cat-opt').forEach(btn=>{
    const cat=btn.dataset.cat;
    if(isMedia){
      // Media items can only go to sketch, scan, inbox
      btn.style.display=MEDIA_CATS.includes(cat)?'block':'none';
    } else {
      // Text items can go to all except sketch, scan
      btn.style.display=!CATS[cat]?.isMedia?'block':'none';
    }
  });
  document.getElementById('catModal').classList.add('show');
}
function closeCatModal(){stopAllAudio();document.getElementById('catModal').classList.remove('show');catChangeId=null;}
function changeCat(c){if(catChangeId){const i=ideas.find(x=>x.id===catChangeId);if(i){saveUndo('category',{id:i.id,previousCategory:i.category,newCategory:c});i.category=c;save();render();counts();toast('Moved to '+CATS[c].name,'success');if(editId===catChangeId)updateEditPanelCategory(c);}}closeCatModal();}
function openCreatorModal(id, e) {
  if(e) e.stopPropagation();
  const item = ideas.find(x => x.id === id);
  if(!item) return;
  
  creatorModalId = id;
  const creator = item.creator || 'user';
  const creatorName = creator === 'aski' ? 'ASKI' : creator === 'system' ? 'System' : (item.creatorName || 'You');
  const creatorRole = creator === 'aski' ? 'AI Assistant' : creator === 'system' ? 'System Service' : (item.creatorRole || '');
  const creatorStatus = creator === 'aski' ? 'aski' : (item.creatorStatus || (creator === 'user' ? 'public' : '')); // aski gets purple, user gets blue
  
  const avatarSvg = creator === 'aski' 
    ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m12 3-1.9 5.8a2 2 0 0 1-1.3 1.3L3 12l5.8 1.9a2 2 0 0 1 1.3 1.3L12 21l1.9-5.8a2 2 0 0 1 1.3-1.3L21 12l-5.8-1.9a2 2 0 0 1-1.3-1.3Z"/></svg>'
    : creator === 'system'
    ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>'
    : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>';
  
  document.getElementById('creatorModalAvatar').innerHTML = avatarSvg;
  document.getElementById('creatorModalAvatar').className = 'creator-modal-avatar ' + creator;
  document.getElementById('creatorModalName').textContent = creatorName;
  document.getElementById('creatorModalRole').textContent = creatorRole;
  document.getElementById('creatorModalDate').textContent = item.date + ' ' + item.time;
  document.getElementById('creatorModalCopyright').textContent = '¬© ' + new Date(item.timestamp || Date.now()).getFullYear() + ' ' + creatorName;
  
  // Set header gradient based on status
  const header = document.getElementById('creatorModalHeader');
  header.className = 'modal-header ' + creatorStatus;
  
  // Update filter button state
  const filterBtn = document.getElementById('creatorFilterBtn');
  const isFiltering = window.filterCreator && (
    window.filterCreator === creator || 
    window.filterCreator === (item.creatorName || 'You')
  );
  if(isFiltering) {
    filterBtn.textContent = 'Clear filter';
    filterBtn.className = 'modal-btn danger';
  } else {
    filterBtn.textContent = 'Show only';
    filterBtn.className = 'modal-btn sec';
  }
  
  document.getElementById('creatorModal').classList.add('show');
}

function filterByCreator() {
  const item = ideas.find(x => x.id === creatorModalId);
  if(!item) return;
  
  const creator = item.creator || 'user';
  const creatorName = item.creatorName || (creator === 'aski' ? 'ASKI' : creator === 'system' ? 'System' : 'You');
  const filterValue = creator === 'user' ? (item.creatorName || 'You') : creator;
  
  // Close modal first
  document.getElementById('creatorModal').classList.remove('show');
  creatorModalId = null;
  
  // Toggle filter
  if(window.filterCreator === filterValue) {
    // Already filtering this creator - clear it
    window.filterCreator = null;
    // Show all cards instantly
    document.querySelectorAll('.card[data-hidden-by-filter]').forEach(card => {
      card.removeAttribute('data-hidden-by-filter');
      card.style.display = '';
    });
    toast('Filter cleared', 'success');
  } else {
    // Set new filter
    window.filterCreator = filterValue;
    // Hide/show cards instantly without render
    document.querySelectorAll('.card').forEach(card => {
      const cardId = parseInt(card.dataset.id);
      const cardItem = ideas.find(x => x.id === cardId);
      if(!cardItem) return;
      
      const cardCreator = cardItem.creator || 'user';
      const cardCreatorName = cardItem.creatorName || 'You';
      const shouldShow = (filterValue === cardCreator) || 
                         (cardCreator === 'user' && cardCreatorName === filterValue);
      
      if(shouldShow) {
        card.removeAttribute('data-hidden-by-filter');
        card.style.display = '';
      } else {
        card.setAttribute('data-hidden-by-filter', '1');
        card.style.display = 'none';
      }
    });
    toast('Showing drops by ' + creatorName, 'success');
  }
}

function clearCreatorFilter() {
  window.filterCreator = null;
  render();
  toast('Filter cleared', 'success');
}

function closeCreatorModal() {
  stopAllAudio();
  document.getElementById('creatorModal').classList.remove('show');
  creatorModalId = null;
}

// Mark reminder as done (v2.0)
function markReminderDone(id) {
  const drop = ideas.find(x => x.id == id || x.id === id);
  if (drop) {
    drop.status = 'completed';
    localStorage.setItem('droplit_ideas', JSON.stringify(ideas));
    
    // Cancel on server if has event_id
    if (drop.event_id && typeof DropLitNotifications !== 'undefined' && DropLitNotifications.cancelCommandDrop) {
      DropLitNotifications.cancelCommandDrop(drop.event_id);
    }
    
    render();
    toast('‚úì Reminder marked as done', 'success');
  }
}

// Close active card
function closeActiveCard() {
  activeCardId = null;
  render();
}

function reqDel(id){delId=id;document.getElementById('delModal').classList.add('show');}
function closeDelModal(){stopAllAudio();document.getElementById('delModal').classList.remove('show');delId=null;}
function confirmDel(){
  if(delId){
    const delItem=ideas.find(x=>x.id==delId);
    if(delItem) {
      saveUndo('delete',{...delItem});
      // Sync delete to Supabase (v0.9.58)
      if (syncEnabled && currentUser) {
        deleteDropFromServer(delId);
      }
      // Cancel command in Supabase if it's a command drop (v1.2)
      if ((delItem.category === 'command' || delItem.type === 'command') && delItem.event_id) {
        if (typeof DropLitNotifications !== 'undefined' && DropLitNotifications.cancelCommandDrop) {
          DropLitNotifications.cancelCommandDrop(delItem.event_id);
        }
      }
    }
    ideas=ideas.filter(x=>x.id!=delId);
    save();
    activeCardId=null;
    render();
    counts();
    toast('Deleted','info');
  }
  closeDelModal();
}

// ============================================
// ARCHIVE SYSTEM (v0.9.113)
// ============================================

function archiveDrop(id) {
  // Find card element first
  const cardEl = document.querySelector('.card[data-id="'+id+'"]');
  
  if (cardEl && !showArchived) {
    // Animate out then update data
    animateArchive(cardEl, id);
  } else {
    // No animation needed (archived visible or no element)
    archiveDropSilent(id);
    // If showing archived, just update the badge
    if (showArchived && cardEl) {
      cardEl.classList.add('archived');
      // Add badge if not exists
      const row2 = cardEl.querySelector('.card-row2');
      if (row2 && !row2.querySelector('.archived-badge')) {
        row2.insertAdjacentHTML('beforeend', '<span class="archived-badge">ARCHIVED</span>');
      }
    }
  }
}

function restoreDrop(id) {
  const item = ideas.find(x => x.id == id);
  if (!item) return;
  
  // Save undo
  if (typeof saveUndo === 'function') {
    saveUndo('restore', {...item});
  }
  
  // Restore to active
  item.lifecycle_state = 'active';
  delete item.archived_at;
  
  // Save locally
  save();
  
  // Update card visually (no render)
  const cardEl = document.querySelector('.card[data-id="'+id+'"]');
  if (cardEl) {
    cardEl.classList.remove('archived');
    const badge = cardEl.querySelector('.archived-badge');
    if (badge) badge.remove();
    // Swap Restore button back to Archive
    const restoreBtn = cardEl.querySelector('.act[onclick*="restoreDrop"]');
    if (restoreBtn) {
      restoreBtn.textContent = 'Archive';
      restoreBtn.setAttribute('onclick', `archiveDrop(${id})`);
    }
  }
  
  // Update counts
  counts();
  
  // Sync to server in background
  if (syncEnabled && currentUser) {
    setTimeout(() => syncDropToServer(item, 'update'), 100);
  }
}

function toggleShowArchived() {
  showArchived = !showArchived;
  localStorage.setItem('droplit_show_archived', showArchived ? 'true' : 'false');
  
  // Update toggle UI (div based toggle, not checkbox)
  const toggle = document.getElementById('showArchivedToggle');
  if (toggle) {
    toggle.classList.toggle('active', showArchived);
  }
  
  render();
  counts();
  
  if (showArchived) {
    toast('üì¶ Showing archived', 'info');
  } else {
    toast('Active only', 'info');
  }
}

// Load showArchived preference
(function loadArchivePreference() {
  showArchived = localStorage.getItem('droplit_show_archived') === 'true';
})();

function startEdit(id){
  if(editId) cancelEditPanel();
  editId = id;
  
  const i = ideas.find(x => x.id === id);
  if(!i) return;
  
  // Get elements
  const panel = document.getElementById('editPanel');
  const avatar = document.getElementById('editPanelAvatar');
  const badge = document.getElementById('editPanelBadge');
  const creator = document.getElementById('editPanelCreator');
  const cat = document.getElementById('editPanelCat');
  const chars = document.getElementById('editPanelChars');
  const time = document.getElementById('editPanelTime');
  const textarea = document.getElementById('editPanelTextarea');
  
  if(!panel || !textarea) return;
  
  // Set avatar style
  const isAski = i.creator === 'aski';
  avatar.className = 'edit-panel-avatar' + (isAski ? ' aski' : '');
  
  // Set badge (before name)
  // ASKI = public (blue), verified user = green, new user = red
  if(isAski) {
    badge.className = 'edit-panel-badge public';
    badge.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>';
  } else {
    badge.className = 'edit-panel-badge verified';
    badge.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>';
  }
  
  // Set creator name
  const creatorName = isAski ? 'ASKI' : (i.creator || 'User');
  creator.textContent = creatorName;
  
  // Set category
  const category = i.category || 'inbox';
  cat.className = 'edit-panel-cat ' + category;
  cat.textContent = CATS[category]?.single || 'INBOX';
  cat.setAttribute('data-id', id);
  
  // Set chars and time
  chars.textContent = (i.text || '').length;
  time.textContent = i.time || '';
  
  // Show/hide encrypted lock
  const lock = document.getElementById('editPanelLock');
  if(lock) {
    lock.style.display = i.encrypted ? 'inline-flex' : 'none';
  }
  
  // Set textarea content
  textarea.value = i.text || '';
  
  // Update char count on input
  textarea.oninput = function() {
    document.getElementById('editPanelChars').textContent = this.value.length;
  };
  
  // Reset to edit mode
  setEditMode('edit');
  
  // Show panel
  panel.classList.add('show');
  document.body.classList.add('editing-mode');
  
  // Focus textarea after small delay
  setTimeout(() => {
    textarea.focus();
  }, 100);
}

// Switch between Edit and Preview modes
function setEditMode(mode) {
  const panel = document.getElementById('editPanel');
  const editBtn = document.getElementById('editToolEdit');
  const previewBtn = document.getElementById('editToolPreview');
  const textarea = document.getElementById('editPanelTextarea');
  const preview = document.getElementById('editPanelPreview');
  
  if(mode === 'preview') {
    // Switch to preview
    panel.classList.add('preview-mode');
    editBtn.classList.remove('active');
    previewBtn.classList.add('active');
    
    // Render markdown
    preview.innerHTML = renderMarkdown(textarea.value || '');
  } else {
    // Switch to edit
    panel.classList.remove('preview-mode');
    editBtn.classList.add('active');
    previewBtn.classList.remove('active');
    
    // Focus textarea
    setTimeout(() => textarea.focus(), 50);
  }
}

// Save from fullscreen edit panel
function saveEditPanel() {
  if(!editId) return;
  
  const textarea = document.getElementById('editPanelTextarea');
  
  if(textarea) {
    const t = textarea.value.trim();
    if(t) {
      const i = ideas.find(x => x.id === editId);
      if(i && t !== i.text) {
        saveUndo('edit', {id: i.id, previousText: i.text});
        i.text = t;
        i.category = detectCat(t);
        save();
        
        // Sync update to Supabase
        if(syncEnabled && currentUser) {
          syncDropToServer(i, 'update');
        }
        toast('Saved', 'success');
      }
    }
  }
  
  // Close panel
  closeEditPanel();
  
  // Re-render to show changes
  render();
  counts();
}

// Cancel from fullscreen edit panel
function cancelEditPanel() {
  // Stop any playing audio
  stopEditPanelAudio();
  closeEditPanel();
}

// Close fullscreen edit panel
function closeEditPanel() {
  const panel = document.getElementById('editPanel');
  if(panel) {
    panel.classList.remove('show');
    panel.classList.remove('preview-mode');
  }
  editId = null;
  document.body.classList.remove('editing-mode');
  // Stop recording if active
  stopEditMic();
  // Stop audio
  stopEditPanelAudio();
}

// ============================================
// EDIT PANEL VOICE FUNCTIONS
// ============================================

let editPanelRecognition = null;
let editPanelAudio = null;
let editPanelSpeaking = false;

// Stop all audio in edit panel
function stopEditPanelAudio() {
  // Stop any playing audio element
  if (editPanelAudio) {
    editPanelAudio.pause();
    editPanelAudio.currentTime = 0;
    editPanelAudio = null;
  }
  // Stop browser speech synthesis
  if (window.speechSynthesis) {
    window.speechSynthesis.cancel();
  }
  // Stop TTS if function exists
  if (typeof window.stopTTS === 'function') {
    window.stopTTS();
  }
  // Update button state
  editPanelSpeaking = false;
  const speakBtn = document.getElementById('editPanelSpeakBtn');
  if (speakBtn) speakBtn.classList.remove('speaking');
}

// Speak text from edit panel (all or selected)
async function speakEditText() {
  const textarea = document.getElementById('editPanelTextarea');
  const speakBtn = document.getElementById('editPanelSpeakBtn');
  if (!textarea) return;
  
  // If already speaking, stop
  if (editPanelSpeaking) {
    stopEditPanelAudio();
    return;
  }
  
  // Get text - selected or all
  let text = '';
  const start = textarea.selectionStart;
  const end = textarea.selectionEnd;
  
  if (start !== end) {
    // Has selection - speak only selected
    text = textarea.value.substring(start, end);
  } else {
    // No selection - speak all
    text = textarea.value;
  }
  
  if (!text.trim()) {
    toast('No text to read', 'warning');
    return;
  }
  
  // Update button state
  editPanelSpeaking = true;
  if (speakBtn) speakBtn.classList.add('speaking');
  
  try {
    // Try OpenAI TTS first if available
    const apiKey = localStorage.getItem('openai_tts_key');
    const voice = localStorage.getItem('aski_voice') || 'nova';
    
    if (apiKey) {
      // Use OpenAI TTS
      const response = await fetch('https://api.openai.com/v1/audio/speech', {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer ' + apiKey,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          model: 'tts-1',
          input: text.substring(0, 4096), // API limit
          voice: voice
        })
      });
      
      if (response.ok) {
        const blob = await response.blob();
        const url = URL.createObjectURL(blob);
        editPanelAudio = new Audio(url);
        editPanelAudio.onended = () => {
          stopEditPanelAudio();
          URL.revokeObjectURL(url);
        };
        editPanelAudio.onerror = () => {
          stopEditPanelAudio();
          URL.revokeObjectURL(url);
        };
        editPanelAudio.play();
        return;
      }
    }
    
    // Fallback to browser speech synthesis
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.onend = () => stopEditPanelAudio();
    utterance.onerror = () => stopEditPanelAudio();
    window.speechSynthesis.speak(utterance);
    
  } catch (e) {
    console.error('TTS error:', e);
    stopEditPanelAudio();
    toast('Failed to read text', 'error');
  }
}

// Toggle microphone for STT at cursor position
function toggleEditMic() {
  const micBtn = document.getElementById('editPanelMicBtn');
  
  if (editPanelRecognition) {
    // Stop recording
    stopEditMic();
  } else {
    // Start recording
    startEditMic();
  }
}

// Start microphone recording
function startEditMic() {
  const textarea = document.getElementById('editPanelTextarea');
  const micBtn = document.getElementById('editPanelMicBtn');
  
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    toast('Speech recognition not supported', 'warning');
    return;
  }
  
  // Stop any playing audio
  stopEditPanelAudio();
  
  // Save original text and cursor position
  const originalText = textarea.value;
  const cursorPos = textarea.selectionStart;
  
  // Create recognition - same settings as chat.js
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  editPanelRecognition = new SpeechRecognition();
  editPanelRecognition.continuous = false;
  editPanelRecognition.interimResults = false; // Like chat.js - final result only
  editPanelRecognition.lang = navigator.language || 'ru-RU';
  
  // Update button state
  if (micBtn) micBtn.classList.add('recording');
  
  editPanelRecognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript;
    
    if (transcript.trim()) {
      // Insert at cursor position
      const before = originalText.substring(0, cursorPos);
      const after = originalText.substring(cursorPos);
      
      // Add space before if needed
      const needSpaceBefore = before.length > 0 && !before.endsWith(' ') && !before.endsWith('\n');
      const spaceBefore = needSpaceBefore ? ' ' : '';
      
      textarea.value = before + spaceBefore + transcript + after;
      
      // Update char count
      document.getElementById('editPanelChars').textContent = textarea.value.length;
      
      // Move cursor to end of inserted text
      const newCursorPos = cursorPos + spaceBefore.length + transcript.length;
      textarea.setSelectionRange(newCursorPos, newCursorPos);
      textarea.focus();
    }
  };
  
  editPanelRecognition.onerror = (event) => {
    console.error('Speech recognition error:', event.error);
    stopEditMic();
    if (event.error !== 'aborted' && event.error !== 'no-speech') {
      toast('Voice input error', 'error');
    }
  };
  
  editPanelRecognition.onend = () => {
    stopEditMic();
  };
  
  editPanelRecognition.start();
  toast('Listening...', 'info');
}

// Stop microphone recording
function stopEditMic() {
  const micBtn = document.getElementById('editPanelMicBtn');
  
  if (editPanelRecognition) {
    editPanelRecognition.stop();
    editPanelRecognition = null;
  }
  
  if (micBtn) micBtn.classList.remove('recording');
}

// Undo in edit panel
function undoEditPanel() {
  const textarea = document.getElementById('editPanelTextarea');
  if (!textarea || !editId) return;
  
  // Get original text
  const original = ideas.find(x => x.id === editId);
  if (original && original.text !== textarea.value) {
    textarea.value = original.text || '';
    document.getElementById('editPanelChars').textContent = textarea.value.length;
    toast('Restored original', 'info');
  }
}

// ============================================
// AI EDIT TOOLS (Placeholders)
// ============================================

async function aiEditOrganize() {
  const textarea = document.getElementById('editPanelTextarea');
  if (!textarea || !textarea.value.trim()) {
    toast('No text to organize', 'warning');
    return;
  }
  toast('Organize: Coming soon!', 'info');
  // TODO: Call AI API with organize prompt
}

async function aiEditEnhance() {
  const textarea = document.getElementById('editPanelTextarea');
  if (!textarea || !textarea.value.trim()) {
    toast('No text to enhance', 'warning');
    return;
  }
  toast('Enhance: Coming soon!', 'info');
  // TODO: Call AI API with enhance prompt
}

async function aiEditSummarize() {
  const textarea = document.getElementById('editPanelTextarea');
  if (!textarea || !textarea.value.trim()) {
    toast('No text to summarize', 'warning');
    return;
  }
  toast('Summarize: Coming soon!', 'info');
  // TODO: Call AI API with summarize prompt
}

async function aiEditExpand() {
  const textarea = document.getElementById('editPanelTextarea');
  if (!textarea || !textarea.value.trim()) {
    toast('No text to expand', 'warning');
    return;
  }
  toast('Expand: Coming soon!', 'info');
  // TODO: Call AI API with expand prompt
}

// Open category modal from edit panel
function openCatModalFromEdit() {
  if(editId) {
    openCatModal(editId);
  }
}

// Update category badge in edit panel after change
function updateEditPanelCategory(category) {
  const cat = document.getElementById('editPanelCat');
  if(cat && editId) {
    cat.className = 'edit-panel-cat ' + category;
    cat.textContent = CATS[category]?.single || 'INBOX';
  }
}

// Legacy wrappers for compatibility
function saveEdit(id) {
  if(editId === id) saveEditPanel();
}
function cancelEdit(id) {
  if(editId === id || !id) cancelEditPanel();
}
function openSendModal(id){sendId=id;document.getElementById('sendModal').classList.add('show');}
function closeSendModal(){stopAllAudio();document.getElementById('sendModal').classList.remove('show');sendId=null;}
function sendAI(){const i=ideas.find(x=>x.id===sendId);if(i){navigator.clipboard.writeText(i.text);window.open('https://claude.ai','_blank');toast('Copied to clipboard!','success');}closeSendModal();}
function shareNative(){const i=ideas.find(x=>x.id===sendId);if(i&&navigator.share)navigator.share({title:'DropLit',text:i.text}).catch(()=>{});else if(i){navigator.clipboard.writeText(i.text);toast('Copied','success');}closeSendModal();}
function sendMail(){const i=ideas.find(x=>x.id===sendId);if(i)window.open('mailto:?subject='+encodeURIComponent('DropLit: '+CATS[i.category].name)+'&body='+encodeURIComponent(i.text));closeSendModal();}
function copyClip(){const i=ideas.find(x=>x.id===sendId);if(i){navigator.clipboard.writeText(i.text);toast('Copied','success');}closeSendModal();}
function copyIdea(id){const i=ideas.find(x=>x.id===id);if(i){navigator.clipboard.writeText(i.text);toast('Copied','success');}}

function saveAsMd(id) {
  const item = ideas.find(x => x.id === id);
  if (!item || !item.text) {
    toast('No text to save');
    return;
  }
  
  // Create filename from first line or date
  let filename = item.text.split('\n')[0].replace(/[#*_\[\]()]/g, '').trim().substring(0, 30);
  if (!filename) filename = 'drop-' + item.date;
  filename = filename.replace(/[^a-zA-Z0-9–∞-—è–ê-–Ø\s-]/g, '').replace(/\s+/g, '-') + '.md';
  
  // Add metadata header
  const content = `---
date: ${item.date}
time: ${item.time}
category: ${item.category}
creator: ${item.creator || 'user'}
---

${item.text}
`;
  
  // Create and download file
  const blob = new Blob([content], { type: 'text/markdown;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  toast('Saved as ' + filename, 'success');
}

function duplicateCard(id){
  const item=ideas.find(x=>x.id===id);
  if(!item)return;
  
  // Create copy with new timestamp
  const now=new Date();
  const copy={
    id: Date.now(),
    text: item.text,
    category: item.category,
    timestamp: now.toISOString(),
    date: now.toLocaleDateString('ru-RU'),
    time: now.toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'}),
    markers: item.markers ? [...item.markers] : [],
    notes: item.notes || '',
    encrypted: item.encrypted || window.DROPLIT_PRIVACY_ENABLED || false
  };
  
  // Copy media if exists
  if(item.isMedia){
    copy.isMedia = true;
    copy.image = item.image;
  }
  
  ideas.push(copy);
  save();
  activeCardId=null;
  render();
  
  toast('Duplicated!','success');
  
  // Scroll to the new card at bottom
  setTimeout(()=>{
    const card=document.querySelector('[data-id="'+copy.id+'"]');
    if(card)card.scrollIntoView({behavior:'smooth',block:'center'});
  },100);
}
function save(newDrop){
  try{
    const data=JSON.stringify(ideas);
    localStorage.setItem('droplit_ideas',data);
    
    // Sync to Supabase (v0.9.58)
    if (newDrop && syncEnabled && currentUser) {
      syncDropToServer(newDrop, 'create');
    }
    
    // Legacy: Sync to Syntrise CORE
    if (newDrop && window.SyntriseCore) {
      syncDropToCore(newDrop);
    }
  }catch(err){
    // Storage full - usually QuotaExceededError
    const sizeMB=(JSON.stringify(ideas).length/1024/1024).toFixed(1);
    toast('Storage full ('+sizeMB+'MB)! Delete old photos','error');
  }
}
function smartTime(i){
  if(!i.date && !i.time) return '';
  
  const td=new Date().toLocaleDateString('ru-RU');
  const yd=new Date(Date.now()-864e5).toLocaleDateString('ru-RU');
  
  // Normalize date to ru-RU format if it's ISO
  let dateStr = i.date || '';
  if(dateStr.includes('-') && !dateStr.includes('T')){
    // ISO format: 2026-01-02 -> 02.01.2026
    const [y,m,d] = dateStr.split('-');
    dateStr = d+'.'+m+'.'+y;
  } else if(dateStr.includes('T')){
    // Full ISO: 2026-01-02T12:00:00
    const dt = new Date(dateStr);
    dateStr = dt.toLocaleDateString('ru-RU');
  }
  
  const timeStr = i.time || '';
  
  if(dateStr===td) return timeStr;
  if(dateStr===yd) return 'Yesterday '+timeStr;
  
  const p=dateStr.split('.');
  if(p.length >= 2){
    return p[0]+'.'+p[1]+' '+timeStr;
  }
  return timeStr;
}

// NEW badge for drops < 15 minutes old
function isNewDrop(i) {
  if (!i.date || !i.time) return false;
  const [d, m, y] = i.date.split('.');
  const [h, min] = i.time.split(':');
  const created = new Date(+y, +m - 1, +d, +h, +min);
  const diff = Date.now() - created.getTime();
  return diff < 15 * 60 * 1000; // 15 minutes
}
function filtered(){
  let f=[...ideas].filter(x=>x&&x.date); // Filter out invalid entries
  
  // Filter by lifecycle state (v0.9.105)
  // By default hide archived/deleted, show only active
  // Drops without lifecycle_state are treated as 'active' (backward compatible)
  if (!showArchived) {
    f = f.filter(x => !x.lifecycle_state || x.lifecycle_state === 'active');
  }
  
  // Apply search filter
  if(searchMode && searchQuery) {
    f = f.filter(x => {
      const text = (x.text || '').toLowerCase();
      const notes = (x.notes || '').toLowerCase();
      return text.includes(searchQuery) || notes.includes(searchQuery);
    });
    return f; // Skip other filters when searching
  }
  
  if(curTime==='today')f=f.filter(x=>isToday(x.date));
  else if(curTime==='7days')f=f.filter(x=>inDays(x.date,7));
  if(curCat!=='all')f=f.filter(x=>x.category===curCat);
  // Filter by creator if set
  if(window.filterCreator) {
    f = f.filter(x => {
      const c = x.creator || 'user';
      if(window.filterCreator === 'aski') return c === 'aski';
      if(window.filterCreator === 'system') return c === 'system';
      return c === 'user' && (x.creatorName || 'You') === window.filterCreator;
    });
  }
  return f;
}

function toggleRollUpMode() {
  rollUpMode = !rollUpMode;
  localStorage.setItem('droplit_rollup_mode', rollUpMode ? 'true' : 'false');
  document.getElementById('rollUpModeToggle')?.classList.toggle('active', rollUpMode);
  
  // Apply to all cards instantly (no render)
  document.querySelectorAll('.card').forEach(card => {
    const isActive = card.classList.contains('active');
    if(rollUpMode && !isActive) {
      card.classList.add('roll-up');
    } else {
      card.classList.remove('roll-up');
    }
  });
}

function render(){
  const wrap=document.getElementById('ideasList'),empty=document.getElementById('emptyState'),list=filtered();
  if(!list.length){wrap.innerHTML='';empty.style.display='flex';return;}
  empty.style.display='none';
  const grp={};for(const i of list){if(!grp[i.date])grp[i.date]=[];grp[i.date].push(i);}
  let dates=Object.keys(grp).sort((a,b)=>sortAsc?parseD(a)-parseD(b):parseD(b)-parseD(a));
  let h='';
  const td=new Date().toLocaleDateString('ru-RU'),yd=new Date(Date.now()-864e5).toLocaleDateString('ru-RU');
  for(const d of dates){
    let lbl=d;if(d===td)lbl='Today';else if(d===yd)lbl='Yesterday';
    h+='<div class="date-sep">'+lbl+'</div>';
    // Sort within day by timestamp (precise to millisecond)
    let dayIdeas=grp[d].slice().sort((a,b)=>{
      // Use timestamp for precise sorting (includes seconds/ms)
      const tsA = a.timestamp ? new Date(a.timestamp).getTime() : 0;
      const tsB = b.timestamp ? new Date(b.timestamp).getTime() : 0;
      return sortAsc ? tsA - tsB : tsB - tsA;
    });
    for(const i of dayIdeas){
      const isActive=activeCardId===i.id;
      const isEditing=editId===i.id;
      const isSelected=selectedIds.includes(i.id);
      const isRollUp=rollUpMode&&!isActive;
      const cc=i.isMedia?0:(i.text?.length||0);
      const isTruncated=cc>1000; /* ~20 lines */
      // Determine creator type and display name
      const creator = i.creator || 'user';
      const creatorName = creator === 'aski' ? 'ASKI' : creator === 'system' ? 'System' : (i.creatorName || 'Benedict Cumberbatch');
      const creatorStatus = i.creatorStatus || (creator === 'user' ? 'public' : ''); // Demo: public for user
      const avatarSvg = creator === 'aski' 
        ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m12 3-1.9 5.8a2 2 0 0 1-1.3 1.3L3 12l5.8 1.9a2 2 0 0 1 1.3 1.3L12 21l1.9-5.8a2 2 0 0 1 1.3-1.3L21 12l-5.8-1.9a2 2 0 0 1-1.3-1.3Z"/></svg>'
        : creator === 'system'
        ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>'
        : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>';
      // Verified badge SVG (checkmark)
      const badgeSvg = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg>';
      const verifiedBadge = creatorStatus ? '<span class="verified-badge '+creatorStatus+'">'+badgeSvg+'</span>' : '';
      // Check if command drop
      const isCommand = i.type === 'command' || i.category === 'command';
      // Check if command is expired (scheduled_at in the past)
      const isExpired = isCommand && i.scheduled_at && new Date(i.scheduled_at) < new Date();
      // Check if command is cancelled or executed
      const isCancelled = isCommand && (i.status === 'cancelled' || i.status === 'executed');
      // Command drop sense type and status classes (v1.0)
      const senseClass = isCommand ? ' sense-' + (i.sense_type || 'reminder') : '';
      const statusClass = isCommand && i.status ? ' status-' + i.status : '';
      const isArchived = i.lifecycle_state === 'archived'; // v0.9.105
      // Card with full width, avatar inside
      const idStr = typeof i.id === 'string' ? "'"+i.id+"'" : i.id;
      h+='<div class="card'+(isActive?' active':'')+(isEditing?' editing':'')+(isSelected?' selected':'')+(isRollUp?' roll-up':'')+(isCommand?' command':'')+(isExpired?' expired':'')+(isCancelled?' cancelled':'')+(isArchived?' archived':'')+senseClass+statusClass+'" data-id="'+i.id+'" onclick="handleCardClick('+idStr+',event)" ontouchstart="cardTouchStart('+idStr+',event)" ontouchmove="cardTouchMove(event)" ontouchend="cardTouchEnd()" ontouchcancel="cardTouchEnd()">';
      h+='<div class="card-checkbox">'+(isSelected?'‚úì':'')+'</div>';
      // Header: Avatar left, two rows right
      h+='<div class="card-header">';
      h+='<div class="card-avatar '+creator+'" onclick="openCreatorModal('+i.id+',event)">'+avatarSvg+'</div>';
      h+='<div class="card-header-content">';
      // Row 1: Badge + Name + Time
      h+='<div class="card-row1">';
      h+='<span class="card-creator">'+verifiedBadge+creatorName+'</span>';
      h+='<span class="card-time">'+smartTime(i)+'</span>';
      h+='</div>';
      // Row 2: Category + params + NEW
      h+='<div class="card-row2">';
      // Category label and class (command drops use 'command' category from CATS)
      const catLabel = CATS[i.category]?.single || 'INBOX';
      const catClass = i.category || 'inbox';
      h+='<span class="card-cat '+catClass+'" onclick="openCatModal('+i.id+')">'+catLabel+'</span>';
      // Encrypted lock icon (shows if drop is encrypted)
      if(i.encrypted){
        h+='<span class="encrypted-lock" title="Encrypted"><svg viewBox="0 0 24 24"><path d="M19 11H5a2 2 0 0 0-2 2v7a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7a2 2 0 0 0-2-2z"/><path d="M7 11V7a5 5 0 0 1 10 0v4" fill="none" stroke-width="2"/></svg></span>';
      }
      // Counter: text=chars, audio=duration, image=dimensions, command=action type
      if(i.category==='audio'){
        h+='<span class="card-chars">'+formatDuration(i.duration||0)+'</span>';
      } else if(isCommand){
        // Command drop: show action type instead of char count
        const actionIcons = {push:'üì±',email:'üìß',telegram:'üí¨',webhook:'üîó',tts:'üîä'};
        const actionLabels = {push:'Push',email:'Email',telegram:'Telegram',webhook:'Webhook',tts:'–ì–æ–ª–æ—Å'};
        const actionType = i.action_type || 'push';
        const actionIcon = actionIcons[actionType] || 'üì±';
        const actionLabel = actionLabels[actionType] || 'Push';
        h+='<span class="cmd-action-type"><span class="cmd-action-icon">'+actionIcon+'</span>'+actionLabel+'</span>';
      } else if(i.isMedia&&i.imageDimensions){
        h+='<span class="card-chars">'+i.imageDimensions+'</span>';
      } else if(i.isMedia){
        h+='<span class="card-chars">IMG</span>';
      } else {
        h+='<span class="card-chars">'+cc+'</span>';
      }
      // Markers
      if(i.markers&&i.markers.length){
        h+='<span class="card-marker">'+i.markers.map(m=>MARKERS[m]||'').join('')+'</span>';
      }
      if(isNewDrop(i))h+='<span class="new-badge">NEW</span>';
      // Archived badge (v0.9.106)
      if(isArchived)h+='<span class="archived-badge">ARCHIVED</span>';
      h+='</div>';
      h+='</div>'; // close card-header-content
      h+='</div>'; // close card-header
      // Audio player
      if(i.category==='audio'&&i.audioData){
        h+='<div class="card-audio-player" data-audio-id="'+i.id+'">';
        h+='<div class="audio-waveform" id="waveform-'+i.id+'">';
        for(let bi=0;bi<30;bi++){
          const bh=8+Math.random()*32;
          h+='<div class="audio-waveform-bar" style="height:'+bh+'px"></div>';
        }
        h+='</div>';
        h+='<div class="audio-controls">';
        h+='<button class="audio-btn" onclick="seekAudio('+i.id+',-10,event)">&lt;&lt;</button>';
        h+='<button class="audio-btn play" onclick="togglePlayAudio('+i.id+',event)" id="playbtn-'+i.id+'">PLAY</button>';
        h+='<button class="audio-btn" onclick="seekAudio('+i.id+',10,event)">&gt;&gt;</button>';
        h+='</div>';
        h+='<div class="audio-time"><span id="audiotime-'+i.id+'">0:00</span><span>'+formatDuration(i.duration||0)+'</span></div>';
        if(i.audioFormat)h+='<div class="audio-format">'+i.audioFormat.toUpperCase()+'</div>';
        h+='</div>';
      } else if(i.isMedia&&i.image){
        // Chart/Diagram drops: show title above image (v0.9.120)
        if(i.category === 'chart' && i.text){
          h+='<div class="chart-title">üìä '+esc(i.text)+'</div>';
        }
        if(i.category === 'diagram' && i.text){
          h+='<div class="chart-title">üìê '+esc(i.text)+'</div>';
        }
        h+='<img class="card-image'+((i.category==='chart'||i.category==='diagram')?' chart-preview':'')+'" src="'+i.image+'" alt="'+(i.category==='chart'?'Chart':i.category==='diagram'?'Diagram':'Photo')+'" loading="lazy">';
        // Show date/geo and notes under image
        h+='<div class="card-media-meta">';
        h+='<span>'+i.date+' '+i.time+'</span>';
        if(i.geo)h+='<span>'+i.geo.lat.toFixed(2)+','+i.geo.lng.toFixed(2)+'</span>';
        h+='</div>';
        if(i.notes){
          const notesLong = i.notes.length > 100;
          h+='<div class="card-notes'+(notesLong?'':' expanded')+'" id="notes-'+i.id+'">'+esc(i.notes)+'</div>';
          if(notesLong)h+='<div class="card-more show" onclick="toggleNotesExpand('+i.id+',event)">Show more</div>';
        }
      }
      if(i.text){
        // v1.1: Command drops get status icon prefix
        let displayText = i.text;
        if (isCommand) {
          const statusIcons = {pending:'‚è∞', completed:'‚úÖ', executed:'‚úÖ', failed:'‚ùå', cancelled:'üö´'};
          const statusIcon = statusIcons[i.status] || '‚è∞';
          // Remove old icon if present (for backward compatibility)
          displayText = displayText.replace(/^[‚è∞‚úÖ‚ùåüö´]\s*/, '');
          displayText = statusIcon + ' ' + displayText;
        }
        h+='<div class="card-text'+(isTruncated?' truncated':'')+'" id="text-'+i.id+'">'+renderMarkdown(displayText)+'</div>';
        if(isTruncated)h+='<div class="card-more show" onclick="toggleExpand('+i.id+',event)">Show more</div>';
      }
      if(!i.isMedia){
        h+='<div class="card-edit"><textarea class="card-ta">'+esc(i.text||'')+'</textarea></div>';
      }
      h+='<div class="card-actions">';
      if(i.category==='audio'){
        h+='<button class="act ai" onclick="transcribeAudio('+i.id+')">Transcribe</button>';
        h+='<button class="act act-tts" onclick="speakDrop('+i.id+',event)">Read</button>';
        h+='<button class="act" onclick="openSendModal('+i.id+')">Share</button>';
        h+='<button class="act" onclick="copyIdea('+i.id+')">Copy</button>';
        h+='<button class="act" onclick="duplicateCard('+i.id+')">Dup</button>';
        // Archive or Restore (v0.9.105)
        if(i.lifecycle_state === 'archived') {
          h+='<button class="act" onclick="restoreDrop('+i.id+')">Restore</button>';
        } else {
          h+='<button class="act" onclick="archiveDrop('+i.id+')">Archive</button>';
        }
        h+='<button class="act danger" onclick="reqDel('+i.id+')">Del</button>';
      } else if(isCommand){
        // Command drop actions: Mark done, Delete, Close
        h+='<button class="act" onclick="markReminderDone(\''+i.id+'\')">‚úì Done</button>';
        h+='<button class="act danger" onclick="reqDel(\''+i.id+'\')">Delete</button>';
        h+='<button class="act" onclick="closeActiveCard()">Close</button>';
      } else if(i.isMedia){
        h+='<button class="act" onclick="viewImage('+i.id+',event)">View</button>';
        h+='<button class="act act-tts" onclick="speakDrop('+i.id+',event)">Read</button>';
        h+='<button class="act" onclick="openSendModal('+i.id+')">Share</button>';
        h+='<button class="act" onclick="copyIdea('+i.id+')">Copy</button>';
        h+='<button class="act" onclick="duplicateCard('+i.id+')">Dup</button>';
        // Archive or Restore (v0.9.105)
        if(i.lifecycle_state === 'archived') {
          h+='<button class="act" onclick="restoreDrop('+i.id+')">Restore</button>';
        } else {
          h+='<button class="act" onclick="archiveDrop('+i.id+')">Archive</button>';
        }
        h+='<button class="act danger" onclick="reqDel('+i.id+')">Del</button>';
      } else {
        h+='<button class="act ai" onclick="openAITools('+i.id+')">AI Tools</button>';
        h+='<button class="act act-tts" onclick="speakDrop('+i.id+',event)">Read</button>';
        h+='<button class="act" onclick="startEdit('+i.id+')">Edit</button>';
        h+='<button class="act" onclick="openSendModal('+i.id+')">Share</button>';
        h+='<button class="act" onclick="openFileExportModal('+i.id+')">Export</button>';
        h+='<button class="act" onclick="copyIdea('+i.id+')">Copy</button>';
        // Archive or Restore button (v0.9.105)
        if(i.lifecycle_state === 'archived') {
          h+='<button class="act" onclick="restoreDrop('+i.id+')">Restore</button>';
        } else {
          h+='<button class="act" onclick="archiveDrop('+i.id+')">Archive</button>';
        }
        h+='<button class="act danger" onclick="reqDel('+i.id+')">Del</button>';
      }
      h+='</div>';
      if(!i.isMedia){
        h+='<div class="card-edit-actions"><button class="act primary" onclick="saveEdit('+i.id+')">Save</button><button class="act secondary" onclick="cancelEdit('+i.id+')">Cancel</button></div>';
      }
      // Markers panel at bottom
      h+='<div class="card-markers">';
      for(const mk of Object.keys(MARKERS)){
        const isMarked=i.markers&&i.markers.includes(mk);
        h+='<button class="marker-btn'+(isMarked?' active':'')+'" onclick="toggleMarker('+i.id+',\''+mk+'\',event)">'+MARKERS[mk]+'</button>';
      }
      h+='</div>';
      // Copyright line
      const copyrightYear = new Date(i.timestamp || Date.now()).getFullYear();
      const copyrightName = creatorName;
      h+='<div class="card-copyright">¬© '+copyrightYear+' '+copyrightName+'</div>';
      h+='</div>'; // close card
    }
  }
  wrap.innerHTML=h;
}

function esc(t){const d=document.createElement('div');d.textContent=t;return d.innerHTML;}

// Markdown parser - lightweight, safe, no dependencies
function renderMarkdown(text) {
  if(!text) return '';
  
  // 1. Escape HTML first (security)
  let html = esc(text);
  
  // 2. Code blocks ``` (before other processing)
  html = html.replace(/```(\w*)\n?([\s\S]*?)```/g, '<pre><code>$2</code></pre>');
  
  // 3. Inline code `code`
  html = html.replace(/`([^`]+)`/g, '<code class="md-inline-code">$1</code>');
  
  // 4. Headers # ## ###
  html = html.replace(/^### (.+)$/gm, '<h4 class="md-h4">$1</h4>');
  html = html.replace(/^## (.+)$/gm, '<h3 class="md-h3">$1</h3>');
  html = html.replace(/^# (.+)$/gm, '<h2 class="md-h2">$1</h2>');
  
  // 5. Bold **text** or __text__
  html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  html = html.replace(/__(.+?)__/g, '<strong>$1</strong>');
  
  // 6. Italic *text* or _text_ (but not inside words)
  html = html.replace(/(?<!\w)\*([^*]+)\*(?!\w)/g, '<em>$1</em>');
  html = html.replace(/(?<!\w)_([^_]+)_(?!\w)/g, '<em>$1</em>');
  
  // 7. Strikethrough ~~text~~
  html = html.replace(/~~(.+?)~~/g, '<del>$1</del>');
  
  // 8. Blockquote > text
  html = html.replace(/^&gt; (.+)$/gm, '<blockquote class="md-quote">$1</blockquote>');
  
  // 9. Unordered lists - item
  html = html.replace(/^- (.+)$/gm, '<li class="md-li">$1</li>');
  // Wrap consecutive <li> in <ul>
  html = html.replace(/(<li class="md-li">.*<\/li>\n?)+/g, '<ul class="md-ul">$&</ul>');
  
  // 10. Horizontal rule ---
  html = html.replace(/^---$/gm, '<hr class="md-hr">');
  
  // 11. Links [text](url) - sanitize javascript:
  html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, (match, text, url) => {
    if(url.toLowerCase().startsWith('javascript:')) return text;
    return '<a href="' + url + '" target="_blank" rel="noopener" class="md-link">' + text + '</a>';
  });
  
  // 12. Auto-link URLs (if not already in <a>)
  html = html.replace(/(?<!href="|">)(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank" rel="noopener" class="md-link">$1</a>');
  
  // 13. Line breaks (preserve single newlines in paragraphs)
  html = html.replace(/\n/g, '<br>');
  
  // Clean up extra <br> after block elements
  html = html.replace(/<\/(h[234]|pre|blockquote|ul|li|hr)><br>/g, '</$1>');
  html = html.replace(/<br><(h[234]|pre|blockquote|ul|hr)/g, '<$1');
  
  return html;
}

function linkify(text){
  // First escape HTML, then convert URLs to links
  const escaped=esc(text);
  // URL regex - matches http, https, and www
  const urlRegex=/(\b(https?:\/\/|www\.)[^\s<]+[^\s<.,;:!?\)\]'"])/gi;
  return escaped.replace(urlRegex,(url)=>{
    let href=url;
    if(url.startsWith('www.'))href='https://'+url;
    return '<a href="'+href+'" target="_blank" rel="noopener" onclick="event.stopPropagation()">'+url+'</a>';
  });
}

function toggleExpand(id,e){
  e.stopPropagation();
  const textEl=document.getElementById('text-'+id);
  const btn=e.target;
  if(textEl.classList.contains('expanded')){
    textEl.classList.remove('expanded');
    textEl.classList.add('truncated');
    btn.textContent='Show more';
  } else {
    textEl.classList.add('expanded');
    textEl.classList.remove('truncated');
    btn.textContent='Show less';
  }
}

function toggleNotesExpand(id,e){
  e.stopPropagation();
  const notesEl=document.getElementById('notes-'+id);
  const btn=e.target;
  if(notesEl.classList.contains('expanded')){
    notesEl.classList.remove('expanded');
    btn.textContent='Show more';
  } else {
    notesEl.classList.add('expanded');
    btn.textContent='Show less';
  }
}

let currentImageId=null;
let allMediaIds=[];
let currentMediaIndex=0;
let currentImageOrientation='';

// ============================================
// ZOOM/PAN SYSTEM (iOS/Android standard)
// ============================================

// State
let scale = 1;           // Current zoom level (1 = fit-to-screen)
let offsetX = 0;         // Pan offset X
let offsetY = 0;         // Pan offset Y
const MIN_SCALE = 1;     // Fit to screen
const MAX_SCALE = 4;     // Maximum zoom
const DOUBLE_TAP_SCALE = 2; // Double-tap zoom level

// Touch tracking
let lastTapTime = 0;
let lastTapX = 0;
let lastTapY = 0;

// Pinch state
let isPinching = false;
let pinchStartScale = 1;
let pinchStartDistance = 0;
let pinchCenterX = 0;
let pinchCenterY = 0;

// Pan state  
let isPanning = false;
let panStartX = 0;
let panStartY = 0;
let panStartOffsetX = 0;
let panStartOffsetY = 0;

// Swipe state
let swipeStartX = 0;
let swipeStartY = 0;
let isSwiping = false;

// Caption edit state
let isEditingCaption=false;

function getMediaItems(){
  return ideas.filter(i=>i.isMedia&&i.image);
}

function viewImage(id,e){
  if(e)e.stopPropagation();
  const item=ideas.find(x=>x.id===id);
  if(!item||!item.image)return;
  
  allMediaIds=getMediaItems().map(i=>i.id);
  currentMediaIndex=allMediaIds.indexOf(id);
  currentImageId=id;
  isEditingCaption=false;
  
  // Reset zoom/pan
  resetTransform();
  
  showImagePanel();
  loadCurrentImage();
  updateNavigation();
  updatePhotoMarkersButton();
  
  document.getElementById('imageViewer').classList.add('show');
  
  const content=document.getElementById('imageViewerContent');
  content.addEventListener('touchstart',handleTouchStart,{passive:false});
  content.addEventListener('touchmove',handleTouchMove,{passive:false});
  content.addEventListener('touchend',handleTouchEnd,{passive:false});
}

function loadCurrentImage(){
  const item=ideas.find(x=>x.id===currentImageId);
  if(!item)return;
  
  const img=document.getElementById('imageViewerImg');
  img.classList.remove('portrait','landscape','zoomed');
  img.style.opacity = '1';
  
  // Reset transform
  resetTransform();
  applyTransform(false);
  
  // Detect orientation
  const tempImg=new Image();
  tempImg.onload=function(){
    currentImageOrientation=(this.height>this.width)?'portrait':'landscape';
    img.classList.add(currentImageOrientation);
  };
  tempImg.src=item.image;
  img.src=item.image;
  
  // Meta info
  let meta='<span>'+item.date+' '+item.time+'</span>';
  if(item.geo){
    meta+='<span>'+item.geo.lat.toFixed(4)+', '+item.geo.lng.toFixed(4)+'</span>';
  }
  document.getElementById('imageMeta').innerHTML=meta;
  
  // Caption display
  updateCaptionDisplay(item);
  
  // Reset to view mode
  showImagePanel();
}

function updateCaptionDisplay(item){
  const display=document.getElementById('imageCaptionDisplay');
  if(item.notes&&item.notes.trim()){
    display.textContent=item.notes;
    display.classList.remove('empty');
  } else {
    display.textContent='No caption';
    display.classList.add('empty');
  }
}

function showImagePanel(){
  isEditingCaption=false;
  
  // Show caption row, hide edit area
  const captionRow=document.querySelector('.image-caption-row');
  const notesWrap=document.getElementById('imageNotesWrap');
  
  if(captionRow) captionRow.style.display='flex';
  if(notesWrap) notesWrap.classList.remove('editing');
}

function updateNavigation(){
  const counter=document.getElementById('imageCounter');
  const prevBtn=document.getElementById('imgNavPrev');
  const nextBtn=document.getElementById('imgNavNext');
  
  counter.textContent=(currentMediaIndex+1)+' / '+allMediaIds.length;
  
  if(allMediaIds.length>1){
    prevBtn.classList.toggle('show',currentMediaIndex>0);
    nextBtn.classList.toggle('show',currentMediaIndex<allMediaIds.length-1);
  } else {
    prevBtn.classList.remove('show');
    nextBtn.classList.remove('show');
  }
}

function navigateImage(direction){
  const newIndex=currentMediaIndex+direction;
  if(newIndex<0||newIndex>=allMediaIds.length)return;
  
  if(isEditingCaption){
    saveCaption();
  }
  
  // Reset zoom before navigating
  resetTransform();
  
  const img = document.getElementById('imageViewerImg');
  
  // Quick fade transition for button navigation
  img.style.transition = 'opacity 0.15s ease-out';
  img.style.opacity = '0';
  
  setTimeout(() => {
    currentMediaIndex=newIndex;
    currentImageId=allMediaIds[currentMediaIndex];
    loadCurrentImageNoReset();
    
    img.style.transition = 'opacity 0.15s ease-out';
    img.style.opacity = '1';
    updateNavigation();
    updatePhotoMarkersButton();
  }, 100);
}

function loadCurrentImageNoReset(){
  const item=ideas.find(x=>x.id===currentImageId);
  if(!item)return;
  
  const img=document.getElementById('imageViewerImg');
  img.classList.remove('portrait','landscape','zoomed');
  
  // Detect orientation
  const tempImg=new Image();
  tempImg.onload=function(){
    currentImageOrientation=(this.height>this.width)?'portrait':'landscape';
    img.classList.add(currentImageOrientation);
  };
  tempImg.src=item.image;
  img.src=item.image;
  
  // Meta info
  let meta='<span>'+item.date+' '+item.time+'</span>';
  if(item.geo){
    meta+='<span>'+item.geo.lat.toFixed(4)+', '+item.geo.lng.toFixed(4)+'</span>';
  }
  document.getElementById('imageMeta').innerHTML=meta;
  
  // Caption display
  updateCaptionDisplay(item);
  
  // Reset to view mode
  showImagePanel();
}

// ============================================
// TRANSFORM HELPERS
// ============================================

function resetTransform(){
  scale = 1;
  offsetX = 0;
  offsetY = 0;
}

function applyTransform(animate = true){
  const img = document.getElementById('imageViewerImg');
  if(!img) return;
  
  img.style.transition = animate ? 'transform 0.25s ease-out' : 'none';
  img.style.transform = `scale(${scale}) translate(${offsetX}px, ${offsetY}px)`;
  
  // Update class for CSS
  if(scale > 1){
    img.classList.remove('portrait','landscape');
    img.classList.add('zoomed');
  } else {
    img.classList.remove('zoomed');
    if(currentImageOrientation){
      img.classList.add(currentImageOrientation);
    }
  }
}

function clampOffset(){
  // Restrict pan so image doesn't go outside bounds
  const img = document.getElementById('imageViewerImg');
  const content = document.getElementById('imageViewerContent');
  if(!img || !content) return;
  
  const contentRect = content.getBoundingClientRect();
  
  // Calculate how much image can move based on scale
  // When scale=1, no movement allowed. When scale>1, allow proportional movement.
  const imgWidth = img.offsetWidth || 300;
  const imgHeight = img.offsetHeight || 300;
  
  const scaledWidth = imgWidth * scale;
  const scaledHeight = imgHeight * scale;
  
  // Max offset is half the overflow (scaled size - container size) / 2, divided by scale
  const maxOffsetX = Math.max(0, (scaledWidth - contentRect.width) / 2 / scale);
  const maxOffsetY = Math.max(0, (scaledHeight - contentRect.height) / 2 / scale);
  
  offsetX = Math.max(-maxOffsetX, Math.min(maxOffsetX, offsetX));
  offsetY = Math.max(-maxOffsetY, Math.min(maxOffsetY, offsetY));
}

// ============================================
// TOUCH HANDLERS
// ============================================

function handleTouchStart(e){
  const touches = e.touches;
  
  if(touches.length === 2){
    // PINCH START
    e.preventDefault();
    isPinching = true;
    isPanning = false;
    isSwiping = false;
    
    pinchStartScale = scale;
    pinchStartDistance = getPinchDistance(touches);
    
  } else if(touches.length === 1){
    // SINGLE TOUCH START
    const x = touches[0].clientX;
    const y = touches[0].clientY;
    
    if(scale > 1){
      // Zoomed in - start panning
      isPanning = true;
      isSwiping = false;
      panStartX = x;
      panStartY = y;
      panStartOffsetX = offsetX;
      panStartOffsetY = offsetY;
    } else {
      // Not zoomed - could be swipe or tap
      isSwiping = true;
      isPanning = false;
      swipeStartX = x;
      swipeStartY = y;
    }
    
    isPinching = false;
  }
}

function handleTouchMove(e){
  const touches = e.touches;
  
  if(isPinching && touches.length === 2){
    // PINCH MOVE
    e.preventDefault();
    
    const newDistance = getPinchDistance(touches);
    const scaleChange = newDistance / pinchStartDistance;
    let newScale = pinchStartScale * scaleChange;
    
    // Clamp scale
    newScale = Math.max(MIN_SCALE, Math.min(MAX_SCALE, newScale));
    scale = newScale;
    
    // Apply without animation for smooth feel
    applyTransform(false);
    
  } else if(isPanning && touches.length === 1){
    // PAN MOVE
    e.preventDefault();
    
    const x = touches[0].clientX;
    const y = touches[0].clientY;
    
    // Calculate delta and apply to offset (divide by scale for correct movement)
    offsetX = panStartOffsetX + (x - panStartX) / scale;
    offsetY = panStartOffsetY + (y - panStartY) / scale;
    
    // Clamp to bounds
    clampOffset();
    
    // Apply without animation
    applyTransform(false);
    
  } else if(isSwiping && touches.length === 1 && scale <= 1){
    // SWIPE MOVE - image follows finger
    const deltaX = touches[0].clientX - swipeStartX;
    const deltaY = touches[0].clientY - swipeStartY;
    
    // Only horizontal swipe
    if(Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 5){
      e.preventDefault();
      
      // Move image with finger (with resistance at edges)
      const img = document.getElementById('imageViewerImg');
      let moveX = deltaX;
      
      // Add resistance if at first/last image
      if((currentMediaIndex === 0 && deltaX > 0) || 
         (currentMediaIndex === allMediaIds.length - 1 && deltaX < 0)){
        moveX = deltaX * 0.3; // Rubber band effect
      }
      
      img.style.transition = 'none';
      img.style.transform = `translateX(${moveX}px)`;
      img.style.opacity = Math.max(0.5, 1 - Math.abs(deltaX) / 500);
    }
  }
}

function handleTouchEnd(e){
  const changedTouches = e.changedTouches;
  
  if(isPinching){
    // PINCH END
    isPinching = false;
    
    // Snap to 1 if close
    if(scale < 1.1){
      scale = 1;
      offsetX = 0;
      offsetY = 0;
    } else {
      // Clamp offset after pinch
      clampOffset();
    }
    
    applyTransform(true);
    return;
  }
  
  if(isPanning){
    // PAN END
    isPanning = false;
    
    // Check for double-tap while zoomed (to reset)
    const now = Date.now();
    const x = changedTouches[0].clientX;
    const y = changedTouches[0].clientY;
    const dx = Math.abs(x - panStartX);
    const dy = Math.abs(y - panStartY);
    
    // If didn't move much, might be a tap
    if(dx < 10 && dy < 10){
      if(now - lastTapTime < 300){
        // Double tap while zoomed - reset to fit
        e.preventDefault();
        resetTransform();
        applyTransform(true);
        lastTapTime = 0;
        return;
      }
      lastTapTime = now;
    }
    return;
  }
  
  if(isSwiping && scale <= 1){
    // SWIPE END (not zoomed)
    isSwiping = false;
    
    const x = changedTouches[0].clientX;
    const y = changedTouches[0].clientY;
    const deltaX = x - swipeStartX;
    const deltaY = y - swipeStartY;
    const img = document.getElementById('imageViewerImg');
    
    // Check for SWIPE (horizontal, more than 80px threshold)
    if(Math.abs(deltaX) > 80 && Math.abs(deltaY) < 100){
      // Animate current image out
      const direction = deltaX > 0 ? 1 : -1;
      const canNavigate = (direction > 0 && currentMediaIndex > 0) || 
                          (direction < 0 && currentMediaIndex < allMediaIds.length - 1);
      
      if(canNavigate){
        // Slide out completely
        img.style.transition = 'transform 0.2s ease-out, opacity 0.15s ease-out';
        img.style.transform = `translateX(${direction * 300}px)`;
        img.style.opacity = '0';
        
        setTimeout(() => {
          // Update index
          currentMediaIndex += (direction > 0 ? -1 : 1);
          currentImageId = allMediaIds[currentMediaIndex];
          
          // Position for slide in
          img.style.transition = 'none';
          img.style.transform = `translateX(${-direction * 100}px)`;
          
          loadCurrentImageNoReset();
          
          // Animate in
          setTimeout(() => {
            img.style.transition = 'transform 0.2s ease-out, opacity 0.15s ease-out';
            img.style.transform = 'translateX(0)';
            img.style.opacity = '1';
            updateNavigation();
            updatePhotoMarkersButton();
          }, 20);
        }, 150);
        return;
      }
    }
    
    // Return to center (swipe cancelled or at edge)
    img.style.transition = 'transform 0.25s ease-out, opacity 0.15s ease-out';
    img.style.transform = 'translateX(0)';
    img.style.opacity = '1';
    
    // Check for DOUBLE TAP (to zoom in)
    const now = Date.now();
    const tapDist = Math.sqrt(
      Math.pow(x - lastTapX, 2) + Math.pow(y - lastTapY, 2)
    );
    
    if(now - lastTapTime < 300 && tapDist < 30 && Math.abs(deltaX) < 10){
      // DOUBLE TAP - zoom to 2x centered on tap point
      e.preventDefault();
      doubleTapZoom(x, y);
      lastTapTime = 0;
      lastTapX = 0;
      lastTapY = 0;
    } else {
      lastTapTime = now;
      lastTapX = x;
      lastTapY = y;
    }
  }
  
  isSwiping = false;
  isPanning = false;
}

function doubleTapZoom(tapX, tapY){
  if(scale > 1){
    // Already zoomed - reset to fit
    resetTransform();
  } else {
    // Zoom to 2x, centered on tap point
    const content = document.getElementById('imageViewerContent');
    const img = document.getElementById('imageViewerImg');
    if(!content || !img) return;
    
    const rect = content.getBoundingClientRect();
    
    // Calculate offset to center on tap point
    const tapRelX = tapX - (rect.left + rect.width / 2);
    const tapRelY = tapY - (rect.top + rect.height / 2);
    
    // New scale
    scale = DOUBLE_TAP_SCALE;
    
    // Offset to keep tap point in same screen position
    offsetX = -tapRelX / scale;
    offsetY = -tapRelY / scale;
    
    // Clamp
    clampOffset();
  }
  
  applyTransform(true);
}

function getPinchDistance(touches){
  const dx = touches[0].clientX - touches[1].clientX;
  const dy = touches[0].clientY - touches[1].clientY;
  return Math.sqrt(dx * dx + dy * dy);
}

// Caption editing
function startEditCaption(){
  isEditingCaption=true;
  const item=ideas.find(x=>x.id===currentImageId);
  
  document.getElementById('imageNotes').value=item?.notes||'';
  
  // Show edit area, hide caption row
  document.querySelector('.image-caption-row').style.display='none';
  document.getElementById('imageNotesWrap').classList.add('editing');
  
  setTimeout(()=>{
    document.getElementById('imageNotes').focus();
  },100);
}

function saveCaption(){
  const notes=document.getElementById('imageNotes').value.trim();
  const item=ideas.find(x=>x.id===currentImageId);
  if(item){
    item.notes=notes;
    save();
    render();
    updateCaptionDisplay(item);
  }
  showImagePanel();
}

function cancelEditCaption(){
  showImagePanel();
}

function handleImageViewerClick(e){
  if(e.target.classList.contains('image-viewer')){
    closeImageViewer();
  }
}

function closeImageViewer(){
  stopAllAudio();
  if(isEditingCaption){
    saveCaption();
  }
  
  // Reset zoom/pan state
  resetTransform();
  isPinching=false;
  isPanning=false;
  isSwiping=false;
  isEditingCaption=false;
  
  const content=document.getElementById('imageViewerContent');
  content.removeEventListener('touchstart',handleTouchStart);
  content.removeEventListener('touchmove',handleTouchMove);
  content.removeEventListener('touchend',handleTouchEnd);
  
  currentImageId=null;
  allMediaIds=[];
  document.getElementById('imageViewer').classList.remove('show');
  document.getElementById('imageViewerImg').src='';
}

function shareImage(){
  const item=ideas.find(x=>x.id===currentImageId);
  if(!item)return;
  
  fetch(item.image)
    .then(res=>res.blob())
    .then(blob=>{
      const file=new File([blob],'droplit-sketch.jpg',{type:'image/jpeg'});
      if(navigator.share&&navigator.canShare&&navigator.canShare({files:[file]})){
        navigator.share({
          files:[file],
          title:'DropLit Sketch',
          text:item.notes||'Shared from DropLit'
        }).catch(()=>{});
      } else {
        window.open(item.image,'_blank');
        toast('Use browser menu to share','info');
      }
    });
}

function saveImageToGallery(){
  const item=ideas.find(x=>x.id===currentImageId);
  if(!item)return;
  
  const link=document.createElement('a');
  link.href=item.image;
  link.download='droplit-sketch-'+item.id+'.jpg';
  link.click();
  toast('Image saved!','success');
}

// ============================================
// AI FUNCTIONS (v0.8.2)
// ============================================

async function ocrImage() {
  if (aiProcessing) {
    toast('AI is processing...', 'info');
    return;
  }
  
  const item = ideas.find(x => x.id === currentImageId);
  if (!item || !item.image) {
    toast('No image to process', 'error');
    return;
  }

  aiProcessing = true;
  showAILoading('ocr', false);

  try {
    const response = await fetch(AI_API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'ocr', image: item.image }),
    });

    const data = await response.json();

    hideAILoading();

    if (data.success && data.result) {
      const existingNotes = item.notes || '';
      const ocrText = data.result;
      
      if (existingNotes) {
        item.notes = existingNotes + '\n\n--- OCR ---\n' + ocrText;
      } else {
        item.notes = ocrText;
      }
      
      if (!item.text) {
        item.text = ocrText.substring(0, 200) + (ocrText.length > 200 ? '...' : '');
      }
      
      save();
      
      const notesArea = document.getElementById('imgNotes');
      if (notesArea) notesArea.value = item.notes;
      
      toast('Text extracted! ‚úÖ', 'success');
      showAIResult('OCR Result', ocrText);
    } else {
      toast(data.error || 'OCR failed', 'error');
    }
  } catch (error) {
    console.error('OCR error:', error);
    hideAILoading();
    toast('Connection error', 'error');
  } finally {
    aiProcessing = false;
  }
}

async function aiDescribe() {
  if (aiProcessing) {
    toast('AI is processing...', 'info');
    return;
  }
  
  const item = ideas.find(x => x.id === currentImageId);
  if (!item || !item.image) {
    toast('No image to process', 'error');
    return;
  }

  aiProcessing = true;
  showAILoading('describe', false);

  try {
    const response = await fetch(AI_API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'describe', image: item.image }),
    });

    const data = await response.json();

    hideAILoading();

    if (data.success && data.result) {
      const description = data.result;
      const existingNotes = item.notes || '';
      
      if (existingNotes) {
        item.notes = existingNotes + '\n\n--- AI Description ---\n' + description;
      } else {
        item.notes = description;
      }
      
      if (!item.text) {
        item.text = description.substring(0, 200) + (description.length > 200 ? '...' : '');
      }
      
      save();
      
      const notesArea = document.getElementById('imgNotes');
      if (notesArea) notesArea.value = item.notes;
      
      toast('Image analyzed! ‚úÖ', 'success');
      showAIResult('AI Description', description);
    } else {
      toast(data.error || 'Analysis failed', 'error');
    }
  } catch (error) {
    console.error('AI describe error:', error);
    hideAILoading();
    toast('Connection error', 'error');
  } finally {
    aiProcessing = false;
  }
}

// AI Result Modal
function showAIResult(title, text) {
  let modal = document.getElementById('aiResultModal');
  
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'aiResultModal';
    modal.className = 'ai-result-modal';
    modal.onclick = function(e) { if(e.target === this) closeAIResult(); };
    modal.innerHTML = `
      <div class="ai-result-content">
        <div class="ai-result-header" style="background: linear-gradient(135deg, #8B5CF6, #EC4899);">
          <h2 id="aiResultTitle">AI Result</h2>
        </div>
        <div class="ai-result-body">
          <div id="aiResultContent" style="font-size: 0.95rem; line-height: 1.6; white-space: pre-wrap;"></div>
        </div>
        <div class="ai-result-actions">
          <button class="pill-l magic" onclick="createDropFromResult()">Create Drop</button>
          <div class="pill-row">
            <button class="pill-l sec" onclick="shareResult()">Share</button>
            <button class="pill-l sec" onclick="copyAIResult()">Copy</button>
          </div>
          <button class="pill-l sec" onclick="closeAIResult()">Close</button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  }
  
  document.getElementById('aiResultTitle').textContent = title;
  document.getElementById('aiResultContent').textContent = text;
  modal.classList.add('show');
}

function closeAIResult() {
  const modal = document.getElementById('aiResultModal');
  if (modal) modal.classList.remove('show');
}

function copyAIResult() {
  const content = document.getElementById('aiResultContent');
  if (content) {
    navigator.clipboard.writeText(content.textContent);
    toast('Copied!', 'success');
  }
}

// Create Drop from AI result
function createDropFromResult() {
  const content = document.getElementById('aiResultContent');
  if (!content) return;
  
  const text = content.textContent;
  const title = document.getElementById('aiResultTitle').textContent;
  
  // Determine category based on title
  let category = 'ideas';
  if (title.includes('Poem') || title.includes('–°—Ç–∏—Ö')) category = 'ideas';
  if (title.includes('Speech') || title.includes('–°–ø–∏—á')) category = 'ideas';
  if (title.includes('Greeting') || title.includes('–ü–æ–∑–¥—Ä–∞–≤')) category = 'ideas';
  
  const idea = {
    id: Date.now(),
    text: text,
    category: category,
    timestamp: new Date().toISOString(),
    date: new Date().toLocaleDateString('ru-RU'),
    time: new Date().toLocaleTimeString('ru-RU', {hour:'2-digit', minute:'2-digit'}),
    aiGenerated: true, // Mark as AI generated
    encrypted: window.DROPLIT_PRIVACY_ENABLED || false
  };
  
  ideas.push(idea);
  save();
  closeAIResult();
  render();
  counts();
  toast('Drop created!', 'success');
}

// Share AI result
function shareResult() {
  const content = document.getElementById('aiResultContent');
  if (!content) return;
  
  const text = content.textContent;
  
  if (navigator.share) {
    navigator.share({
      text: text
    }).catch(() => {});
  } else {
    navigator.clipboard.writeText(text);
    toast('Copied! Paste to share', 'success');
  }
}

// ============================================
// AI MAGIC FUNCTIONS (v0.8.2)
// ============================================

let currentMagicType = 'poem';
let magicRecognition = null;
let isMagicRecording = false;
let magicPhotoData = null; // Store selected photo

const MAGIC_CONFIG = {
  poem: {
    title: 'Create Poem',
    subtitle: 'Tell me what it should be about',
    placeholder: 'Example: Birthday greeting for mom, she loves gardening and has 2 grandkids...',
    styles: [
      { id: 'classic', label: 'Classic' },
      { id: 'funny', label: 'Funny' },
      { id: 'tender', label: 'Tender' },
      { id: 'epic', label: 'Epic' }
    ]
  },
  greeting: {
    title: 'Create Greeting',
    subtitle: 'Who is it for and what occasion?',
    placeholder: 'Example: New Year greeting for colleagues, warm and professional...',
    styles: [
      { id: 'warm', label: 'Warm' },
      { id: 'funny', label: 'Funny' },
      { id: 'formal', label: 'Formal' },
      { id: 'poetic', label: 'Poetic' }
    ]
  },
  speech: {
    title: 'Create Speech',
    subtitle: 'What occasion? Who is the audience?',
    placeholder: 'Example: Wedding toast for my best friend, he loves fishing, we know each other 15 years...',
    styles: [
      { id: 'short', label: 'Short (1-2 min)' },
      { id: 'medium', label: 'Medium (3-5 min)' },
      { id: 'long', label: 'Long (7-10 min)' }
    ]
  }
};

function openMagic(type) {
  closePlusMenu();
  currentMagicType = type;
  magicPhotoData = null; // Reset photo
  
  const config = MAGIC_CONFIG[type];
  if (!config) return;
  
  // Update UI
  document.getElementById('magicTitle').textContent = config.title;
  document.getElementById('magicSubtitle').textContent = config.subtitle;
  document.getElementById('magicInput').placeholder = config.placeholder;
  document.getElementById('magicInput').value = '';
  
  // Reset photo UI
  document.getElementById('magicPhotoBtn').classList.remove('has-photo');
  document.getElementById('magicPhotoBtnText').textContent = 'Add photo (optional)';
  document.getElementById('magicPhotoPreview').style.display = 'none';
  document.getElementById('magicPhotoMenu').classList.remove('show');
  
  // Update styles
  const stylesContainer = document.getElementById('magicStyles');
  stylesContainer.innerHTML = config.styles.map((s, i) => 
    `<button class="magic-style${i === 0 ? ' active' : ''}" data-style="${s.id}">${s.label}</button>`
  ).join('');
  
  // Add click handlers to styles
  stylesContainer.querySelectorAll('.magic-style').forEach(btn => {
    btn.onclick = () => {
      stylesContainer.querySelectorAll('.magic-style').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    };
  });
  
  // Show modal
  document.getElementById('magicModal').classList.add('show');
  // Removed autofocus to prevent keyboard popup
}

function closeMagic() {
  document.getElementById('magicModal').classList.remove('show');
  document.getElementById('magicPhotoMenu').classList.remove('show');
  if (isMagicRecording) {
    stopMagicVoice();
  }
}

// ============================================
// MAGIC PHOTO FUNCTIONS
// ============================================

function togglePhotoMenu() {
  const menu = document.getElementById('magicPhotoMenu');
  menu.classList.toggle('show');
}

function takeMagicPhoto() {
  document.getElementById('magicPhotoMenu').classList.remove('show');
  document.getElementById('magicCameraInput').click();
}

function chooseMagicPhoto() {
  document.getElementById('magicPhotoMenu').classList.remove('show');
  document.getElementById('magicPhotoInput').click();
}

function handleMagicPhoto(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = (e) => {
    magicPhotoData = e.target.result;
    showMagicPhotoPreview(magicPhotoData);
  };
  reader.readAsDataURL(file);
  
  // Reset input so same file can be selected again
  event.target.value = '';
}

function showMagicPhotoPreview(dataUrl) {
  document.getElementById('magicPhotoImg').src = dataUrl;
  document.getElementById('magicPhotoPreview').style.display = 'block';
  document.getElementById('magicPhotoBtn').classList.add('has-photo');
  document.getElementById('magicPhotoBtnText').textContent = 'Photo added ‚úì';
  document.getElementById('magicInputLabel').textContent = 'Add details about this photo (optional)';
}

function removeMagicPhoto() {
  magicPhotoData = null;
  document.getElementById('magicPhotoPreview').style.display = 'none';
  document.getElementById('magicPhotoBtn').classList.remove('has-photo');
  document.getElementById('magicPhotoBtnText').textContent = 'Add photo (optional)';
  document.getElementById('magicInputLabel').textContent = 'Add details (optional if photo added)';
}

// Drops Picker
function openDropsPicker() {
  document.getElementById('magicPhotoMenu').classList.remove('show');
  
  // Get all photo drops
  const photoDrops = ideas.filter(i => i.image);
  const grid = document.getElementById('dropsPickerGrid');
  
  if (photoDrops.length === 0) {
    grid.innerHTML = '<div class="drops-picker-empty">No photo drops yet.<br>Take some photos first!</div>';
  } else {
    grid.innerHTML = photoDrops.map(drop => `
      <div class="drops-picker-item" onclick="selectDropPhoto('${drop.id}')">
        <img src="${drop.image}" alt="Drop photo">
      </div>
    `).join('');
  }
  
  document.getElementById('dropsPicker').classList.add('show');
}

function closeDropsPicker() {
  document.getElementById('dropsPicker').classList.remove('show');
}

function selectDropPhoto(id) {
  const drop = ideas.find(i => i.id == id);
  if (drop && drop.image) {
    magicPhotoData = drop.image;
    showMagicPhotoPreview(drop.image);
  }
  closeDropsPicker();
}

function toggleMagicVoice() {
  if (isMagicRecording) {
    stopMagicVoice();
  } else {
    startMagicVoice();
  }
}

function startMagicVoice() {
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    toast('Speech not supported', 'error');
    return;
  }
  
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  magicRecognition = new SpeechRecognition();
  magicRecognition.continuous = false; // Single phrase, no duplicates
  magicRecognition.interimResults = true;
  magicRecognition.maxAlternatives = 1;
  magicRecognition.lang = 'ru-RU';
  
  const inputEl = document.getElementById('magicInput');
  const existingText = inputEl.value;
  let finalTranscript = '';
  
  magicRecognition.onresult = (e) => {
    let interim = '';
    for (let i = 0; i < e.results.length; i++) {
      if (e.results[i].isFinal) {
        finalTranscript += e.results[i][0].transcript;
      } else {
        interim += e.results[i][0].transcript;
      }
    }
    // Show interim while speaking
    document.getElementById('magicVoiceText').textContent = interim || finalTranscript || 'Listening...';
  };
  
  magicRecognition.onerror = (e) => {
    if (e.error === 'no-speech') toast('No speech detected', 'warning');
    stopMagicVoice();
  };
  
  magicRecognition.onend = () => {
    // Append final result to existing text
    if (finalTranscript) {
      inputEl.value = existingText + (existingText ? ' ' : '') + finalTranscript.trim();
    }
    stopMagicVoice();
  };
  
  magicRecognition.start();
  isMagicRecording = true;
  document.getElementById('magicVoiceBtn').classList.add('recording');
  document.getElementById('magicVoiceText').textContent = 'Listening...';
}

function stopMagicVoice() {
  if (magicRecognition) {
    magicRecognition.stop();
    magicRecognition = null;
  }
  isMagicRecording = false;
  document.getElementById('magicVoiceBtn').classList.remove('recording');
  document.getElementById('magicVoiceText').textContent = 'Tap to speak';
}

async function generateMagic() {
  const input = document.getElementById('magicInput').value.trim();
  
  // Need either text or photo
  if (!input && !magicPhotoData) {
    toast('Add a photo or describe what you want', 'error');
    return;
  }
  
  const activeStyle = document.querySelector('.magic-style.active');
  const style = activeStyle ? activeStyle.dataset.style : 'classic';
  
  // Get context
  const context = {
    timeOfDay: getTimeOfDay(),
    location: null
  };
  
  // Show loading in modal
  const loadingLabels = {
    poem: 'Creating your poem',
    greeting: 'Crafting your greeting',
    speech: 'Writing your speech'
  };
  document.getElementById('magicLoadingLabel').textContent = (loadingLabels[currentMagicType] || 'Creating magic') + '...';
  document.getElementById('magicForm').classList.add('hidden');
  document.getElementById('magicLoading').classList.add('show');
  
  try {
    const requestBody = {
      action: currentMagicType,
      text: input,
      style: style,
      context: context
    };
    
    // Add photo if present
    if (magicPhotoData) {
      requestBody.image = magicPhotoData;
    }
    
    const response = await fetch(AI_API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(requestBody),
    });
    
    const data = await response.json();
    
    // Hide loading and close modal
    document.getElementById('magicLoading').classList.remove('show');
    document.getElementById('magicForm').classList.remove('hidden');
    closeMagic();
    
    if (data.success && data.result) {
      const titles = {
        poem: 'Your Poem',
        greeting: 'Your Greeting',
        speech: 'Your Speech'
      };
      
      showAIResult(titles[currentMagicType] || 'AI Result', data.result);
    } else {
      toast(data.error || 'Generation failed', 'error');
    }
  } catch (error) {
    console.error('Magic error:', error);
    document.getElementById('magicLoading').classList.remove('show');
    document.getElementById('magicForm').classList.remove('hidden');
    toast('Connection error', 'error');
  }
}

// ============================================
// AI LOADING INDICATOR (compact, inside modal)
// ============================================

const AI_LOADING_LABELS = {
  poem: 'Creating poem',
  greeting: 'Crafting greeting',
  speech: 'Writing speech',
  summarize: 'Summarizing',
  expand: 'Expanding',
  rewrite: 'Rewriting',
  enhance: 'Enhancing',
  translate: 'Translating',
  tasks: 'Extracting tasks',
  ocr: 'Reading text',
  describe: 'Analyzing image',
  default: 'Processing'
};

let currentLoadingModal = null;

function showAILoading(action, useModal2 = true) {
  const label = AI_LOADING_LABELS[action] || AI_LOADING_LABELS.default;
  
  const loadingHTML = `
    <div class="ai-loading-inline">
      <div class="ai-loading-dots">
        <span></span><span></span><span></span><span></span><span></span>
      </div>
      <div class="ai-loading-label">${label}...</div>
    </div>
  `;
  
  if (useModal2) {
    // Use AI Result Modal 2 (for AI Tools)
    currentLoadingModal = 'modal2';
    document.getElementById('aiResult2Title').textContent = label;
    document.getElementById('aiResult2Text').innerHTML = loadingHTML;
    document.querySelector('.ai-result-actions').style.display = 'none';
    document.getElementById('aiResult2Category').style.display = 'none';
    document.getElementById('aiResultModal2').classList.add('show');
  } else {
    // Use simple toast for Magic/OCR/Describe
    currentLoadingModal = 'toast';
    toast(label + '...', 'info');
  }
}

function hideAILoading() {
  if (currentLoadingModal === 'modal2') {
    // Restore action buttons
    document.querySelector('.ai-result-actions').style.display = 'flex';
  }
  currentLoadingModal = null;
}

function getTimeOfDay() {
  const hour = new Date().getHours();
  if (hour < 6) return 'night';
  if (hour < 12) return 'morning';
  if (hour < 18) return 'afternoon';
  return 'evening';
}

// ============================================
// AI TOOLS FOR TEXT DROPS (v0.8.2)
// ============================================

let aiToolsDropId = null;
let aiToolsResult = null;
let aiToolsSuggestedCategory = null;

function openAITools(id) {
  const drop = ideas.find(x => x.id === id);
  if (!drop || !drop.text) {
    toast('No text to process', 'error');
    return;
  }
  
  aiToolsDropId = id;
  
  // Show preview
  const previewText = drop.text.length > 200 
    ? drop.text.substring(0, 200) + '...' 
    : drop.text;
  document.getElementById('aiToolsPreviewText').textContent = previewText;
  
  // Show current category
  const catName = CATS[drop.category]?.single || drop.category.toUpperCase();
  document.getElementById('aiToolsCurrentCategory').textContent = catName;
  
  document.getElementById('aiToolsModal').classList.add('show');
}

function closeAITools() {
  document.getElementById('aiToolsModal').classList.remove('show');
  // Don't reset aiToolsDropId here - it's needed for Replace/Create Drop actions
}

async function runAITool(tool) {
  const drop = ideas.find(x => x.id === aiToolsDropId);
  if (!drop) {
    toast('Drop not found', 'error');
    return;
  }
  
  const checkCategory = document.getElementById('aiToolsCheckCategory').checked;
  const removeLineBreaks = document.getElementById('aiToolsRemoveLineBreaks').checked;
  
  // Close tools modal and show loading overlay
  closeAITools();
  showAILoading(tool);
  
  try {
    const response = await fetch(AI_API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: tool,
        text: drop.text,
        checkCategory: checkCategory
      }),
    });
    
    const data = await response.json();
    
    hideAILoading();
    
    if (data.success && data.result) {
      // Parse result (may be JSON or plain text)
      let resultText = data.result;
      let suggestedCat = null;
      
      // Try to extract JSON from response (may have markdown wrapper)
      let jsonStr = resultText;
      const jsonMatch = resultText.match(/```json\s*([\s\S]*?)\s*```/);
      if (jsonMatch) {
        jsonStr = jsonMatch[1];
      } else if (resultText.trim().startsWith('{')) {
        jsonStr = resultText.trim();
      }
      
      try {
        // Try to parse as JSON
        const parsed = JSON.parse(jsonStr);
        if (tool === 'summarize' && parsed.summary) {
          resultText = parsed.summary;
          suggestedCat = parsed.suggestedCategory;
        } else if (tool === 'expand' && parsed.expanded) {
          resultText = parsed.expanded;
          suggestedCat = parsed.suggestedCategory;
        } else if (tool === 'rewrite' && parsed.rewritten) {
          resultText = parsed.rewritten;
          suggestedCat = parsed.suggestedCategory;
        } else if (tool === 'enhance' && parsed.enhanced) {
          resultText = parsed.enhanced;
          suggestedCat = parsed.suggestedCategory;
        } else if (tool === 'tasks' && parsed.tasks) {
          // Create task drops
          createTaskDrops(parsed.tasks);
          return;
        } else {
          // JSON parsed but no expected field - use first text value found
          const textValue = parsed.summary || parsed.expanded || parsed.rewritten || parsed.enhanced || parsed.result || parsed.text;
          if (textValue) {
            resultText = textValue;
            suggestedCat = parsed.suggestedCategory;
          }
          // else keep original resultText (will be cleaned below)
        }
      } catch (e) {
        // Not JSON, use as plain text
        if (tool === 'tasks') {
          // Parse numbered list
          const tasks = resultText.split('\n')
            .map(line => line.replace(/^\d+[\.\)]\s*/, '').trim())
            .filter(line => line.length > 0);
          createTaskDrops(tasks);
          return;
        }
        // For other tools, clean up any JSON-like artifacts
        if (resultText.trim().startsWith('{') || resultText.trim().startsWith('```')) {
          // Failed to parse, try to extract text manually
          const textMatch = resultText.match(/"(?:summary|expanded|rewritten|text)":\s*"([^"]+)"/);
          if (textMatch) {
            resultText = textMatch[1].replace(/\\n/g, '\n').replace(/\\"/g, '"');
          }
        }
      }
      
      // T1 FIX: Remove extra line breaks if option is checked
      if (removeLineBreaks && tool !== 'tasks') {
        resultText = resultText
          .replace(/\n+/g, ' ')      // Replace newlines with space
          .replace(/\s{2,}/g, ' ')   // Replace multiple spaces with single
          .trim();
      }
      
      // Show result modal
      showAIResult2(tool, resultText, drop.category, suggestedCat);
      
    } else {
      toast(data.error || 'Processing failed', 'error');
    }
  } catch (error) {
    console.error('AI Tools error:', error);
    hideAILoading();
    toast('Connection error', 'error');
  }
}

// B2 FIX: Store pending tasks for confirmation
let pendingTasks = [];

function createTaskDrops(tasks) {
  if (!tasks || tasks.length === 0) {
    toast('No tasks found', 'warning');
    return;
  }
  
  // Show confirmation modal instead of creating immediately
  pendingTasks = tasks;
  showTasksConfirmModal(tasks);
}

function showTasksConfirmModal(tasks) {
  // Close AI Tools modal first to prevent it showing after Cancel
  closeAITools();
  
  document.getElementById('tasksCount').textContent = tasks.length;
  document.getElementById('tasksCountBtn').textContent = tasks.length;
  
  const listEl = document.getElementById('tasksPreviewList');
  listEl.innerHTML = tasks.map((task, i) => `
    <div class="tasks-preview-item">
      <span class="tasks-preview-num">${i + 1}</span>
      <span class="tasks-preview-text">${task}</span>
    </div>
  `).join('');
  
  document.getElementById('tasksConfirmModal').classList.add('show');
}

function closeTasksConfirm() {
  document.getElementById('tasksConfirmModal').classList.remove('show');
  pendingTasks = [];
  aiToolsDropId = null;
}

function confirmCreateTasks() {
  if (!pendingTasks || pendingTasks.length === 0) {
    closeTasksConfirm();
    return;
  }
  
  const createdIds = [];
  
  pendingTasks.forEach(taskText => {
    const id = Date.now() + Math.random();
    const idea = {
      id: id,
      text: taskText,
      category: 'tasks',
      timestamp: new Date().toISOString(),
      date: new Date().toLocaleDateString('ru-RU'),
      time: new Date().toLocaleTimeString('ru-RU', {hour:'2-digit', minute:'2-digit'}),
      aiGenerated: true,
      sourceDropId: aiToolsDropId,
      encrypted: window.DROPLIT_PRIVACY_ENABLED || false
    };
    ideas.push(idea);
    createdIds.push(id);
  });
  
  saveUndo('createTasks', { taskIds: createdIds });
  
  save();
  render();
  counts();
  toast(`Created ${pendingTasks.length} tasks! ‚úì`, 'success');
  
  closeTasksConfirm();
}

// ============================================
// I1 FIX: TRANSLATE FUNCTIONS
// ============================================

function openTranslateModal() {
  closeAITools();
  document.getElementById('translateModal').classList.add('show');
}

function closeTranslateModal() {
  document.getElementById('translateModal').classList.remove('show');
}

async function runTranslate(targetLang) {
  closeTranslateModal();
  
  const drop = ideas.find(x => x.id === aiToolsDropId);
  if (!drop) {
    toast('Drop not found', 'error');
    return;
  }
  
  showAILoading('translate');
  
  try {
    const response = await fetch(AI_API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'translate',
        text: drop.text,
        targetLang: targetLang
      }),
    });
    
    const data = await response.json();
    hideAILoading();
    
    if (data.success && data.result) {
      showAIResult2('translate', data.result, drop.category, null);
    } else {
      toast(data.error || 'Translation failed', 'error');
    }
  } catch (error) {
    console.error('Translate error:', error);
    hideAILoading();
    toast('Connection error', 'error');
  }
}

function showAIResult2(tool, text, currentCategory, suggestedCategory) {
  aiToolsResult = text;
  aiToolsSuggestedCategory = suggestedCategory;
  
  const titles = {
    summarize: 'Summary',
    expand: 'Expanded',
    rewrite: 'Rewritten',
    enhance: 'Enhanced',
    translate: 'Translated'
  };
  
  document.getElementById('aiResult2Title').textContent = titles[tool] || 'Result';
  document.getElementById('aiResult2Text').textContent = text;
  
  // Show action buttons (may have been hidden during loading)
  document.querySelector('.ai-result-actions').style.display = 'flex';
  
  // Show category suggestion if available
  const catSection = document.getElementById('aiResult2Category');
  if (suggestedCategory && suggestedCategory !== currentCategory) {
    const currentName = CATS[currentCategory]?.single || currentCategory.toUpperCase();
    const suggestedName = CATS[suggestedCategory]?.single || suggestedCategory.toUpperCase();
    
    document.getElementById('aiResult2CurrentCat').textContent = currentName;
    document.getElementById('aiResult2SuggestedCat').textContent = suggestedName;
    catSection.style.display = 'block';
  } else {
    catSection.style.display = 'none';
  }
  
  document.getElementById('aiResultModal2').classList.add('show');
}

function closeAIResult2() {
  document.getElementById('aiResultModal2').classList.remove('show');
  aiToolsResult = null;
  aiToolsSuggestedCategory = null;
  aiToolsDropId = null; // Reset here when user closes without action
}

function replaceOriginal() {
  if (!aiToolsDropId || !aiToolsResult) return;
  
  const drop = ideas.find(x => x.id === aiToolsDropId);
  if (drop) {
    // Save for undo
    saveUndo('replace', { id: drop.id, originalText: drop.text });
    
    // Save original in drop too
    if (!drop.originalText) {
      drop.originalText = drop.text;
    }
    drop.text = aiToolsResult;
    save();
    render();
    toast('Replaced! ‚úì', 'success');
  }
  
  closeAIResult2();
  aiToolsDropId = null;
}

function createNewDrop() {
  if (!aiToolsResult) return;
  
  const sourceDrop = ideas.find(x => x.id === aiToolsDropId);
  const category = aiToolsSuggestedCategory || sourceDrop?.category || 'ideas';
  
  const idea = {
    id: Date.now(),
    text: aiToolsResult,
    category: category,
    timestamp: new Date().toISOString(),
    date: new Date().toLocaleDateString('ru-RU'),
    time: new Date().toLocaleTimeString('ru-RU', {hour:'2-digit', minute:'2-digit'}),
    aiGenerated: true,
    sourceDropId: aiToolsDropId,
    encrypted: window.DROPLIT_PRIVACY_ENABLED || false
  };
  
  ideas.push(idea);
  save();
  render();
  counts();
  toast('Drop created!', 'success');
  
  closeAIResult2();
  aiToolsDropId = null;
}

function copyResult2() {
  if (aiToolsResult) {
    navigator.clipboard.writeText(aiToolsResult);
    toast('Copied!', 'success');
  }
}

function keepCategory() {
  aiToolsSuggestedCategory = null;
  document.getElementById('aiResult2Category').style.display = 'none';
}

function acceptCategory() {
  if (!aiToolsDropId || !aiToolsSuggestedCategory) return;
  
  const drop = ideas.find(x => x.id === aiToolsDropId);
  if (drop) {
    drop.category = aiToolsSuggestedCategory;
    save();
    counts();
  }
  
  document.getElementById('aiResult2Category').style.display = 'none';
  toast('Category updated! ‚úì', 'success');
}

function deleteFromViewer(){
  if(!currentImageId)return;
  if(confirm('Delete this image?')){
    ideas=ideas.filter(x=>x.id!==currentImageId);
    save();
    closeImageViewer();
    render();
    counts();
    toast('Deleted','info');
  }
}


function counts(){
  try{
    const validIdeas=ideas.filter(x=>x&&x.id&&x.category);
    const cntAll=document.getElementById('cntAll');
    const cntToday=document.getElementById('cntToday');
    const cnt7d=document.getElementById('cnt7d');
    
    if(cntAll)cntAll.textContent=validIdeas.length;
    if(cntToday)cntToday.textContent=validIdeas.filter(x=>x.date&&isToday(x.date)).length;
    if(cnt7d)cnt7d.textContent=validIdeas.filter(x=>x.date&&inDays(x.date,7)).length;
    
    // Count ALL items in each category
    for(const k of Object.keys(CATS)){
      const el=document.getElementById('cnt'+k.charAt(0).toUpperCase()+k.slice(1));
      if(el)el.textContent=validIdeas.filter(x=>x.category===k).length;
    }
  }catch(err){}
}

// Clean up expired/completed command drops (v4.20)
function cleanupCommandDrops() {
  const now = new Date();
  let changed = false;
  
  ideas = ideas.filter(idea => {
    // Keep non-command drops
    if (idea.type !== 'command' && idea.category !== 'command') return true;
    
    // Check if command drop is expired (scheduled_at + 1 hour)
    if (idea.scheduled_at) {
      const scheduledTime = new Date(idea.scheduled_at);
      const expireTime = new Date(scheduledTime.getTime() + 60 * 60 * 1000); // +1 hour
      
      if (now > expireTime && idea.status !== 'completed') {
        console.log('[Cleanup] Removing expired command drop:', idea.text);
        changed = true;
        return false; // Remove
      }
    }
    
    // Keep active command drops
    return true;
  });
  
  if (changed) {
    localStorage.setItem('ideas', JSON.stringify(ideas));
    render();
    counts();
    console.log('[Cleanup] Feed updated after removing expired commands');
  }
}

// Run cleanup on filter change to "today"
function onFilterToday() {
  cleanupCommandDrops();
  render(); // Always render after filter change
  // Scroll to newest drop
  setTimeout(() => {
    const wrap = document.getElementById('ideasWrap');
    if (wrap) {
      wrap.scrollTo({top: wrap.scrollHeight, behavior: 'auto'});
    }
  }, 50);
}

document.getElementById('timeRow').addEventListener('click',e=>{
  const b=e.target.closest('.time-btn');if(!b)return;
  document.querySelectorAll('.time-btn').forEach(x=>x.classList.remove('active'));
  if(b.dataset.time!=='all')b.classList.add('active');
  curTime=b.dataset.time;curCat='all';activeCardId=null;
  document.querySelectorAll('.cat').forEach(x=>x.classList.remove('active'));
  
  // Cleanup expired command drops when switching to Today
  if(b.dataset.time==='today') {
    onFilterToday();
  } else {
    render();
  }
});

// Programmatic time filter change (for ASKI drop operations)
function setTimeFilter(filter) {
  if (!['all', 'today', '7days'].includes(filter)) return;
  
  // Update UI
  document.querySelectorAll('.time-btn').forEach(x => x.classList.remove('active'));
  const btn = document.querySelector(`.time-btn[data-time="${filter}"]`);
  if (btn && filter !== 'all') btn.classList.add('active');
  
  // Update state
  curTime = filter;
  curCat = 'all';
  activeCardId = null;
  document.querySelectorAll('.cat').forEach(x => x.classList.remove('active'));
  
  // Render
  if (filter === 'today') {
    onFilterToday();
  } else {
    render();
  }
  
  console.log('[Filter] Set to:', filter);
}

document.getElementById('cats').addEventListener('click',e=>{
  const c=e.target.closest('.cat');if(!c)return;
  if(c.classList.contains('active')){c.classList.remove('active');curCat='all';}
  else{document.querySelectorAll('.cat').forEach(x=>x.classList.remove('active'));c.classList.add('active');curCat=c.dataset.category;}
  activeCardId=null;render();
  // counts already calculated
});

// ============================================
// TOKEN BALANCE
// ============================================

function formatTokens(num) {
  if (num === null || num === undefined) return '‚Äî';
  if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
  return num.toLocaleString();
}

async function updateTokenBalance() {
  const balanceEl = document.getElementById('tokenBalance');
  const usageEl = document.getElementById('tokenUsage');
  
  if (!currentUser) {
    if (balanceEl) balanceEl.textContent = '‚Äî';
    if (usageEl) usageEl.textContent = 'Sign in to view';
    return;
  }
  
  try {
    const client = getSupabaseClient();
    if (!client) {
      if (balanceEl) balanceEl.textContent = '‚àû Beta';
      if (usageEl) usageEl.textContent = 'Free during beta';
      return;
    }
    
    const { data, error } = await client
      .from('profiles')
      .select('token_balance')
      .eq('id', currentUser.id)
      .single();
    
    if (error || !data) {
      console.log('[Tokens] Could not fetch balance:', error?.message);
      if (balanceEl) balanceEl.textContent = '‚àû Beta';
      if (usageEl) usageEl.textContent = 'Free during beta';
      return;
    }
    
    const balance = data.token_balance || 0;
    if (balanceEl) balanceEl.textContent = 'üíé ' + formatTokens(balance);
    
    if (usageEl) {
      if (balance <= 0) {
        usageEl.innerHTML = '‚ö†Ô∏è Empty! <a href="#" onclick="showProPlanInfo();return false;" style="color:#FFD700;">Get Pro ‚Üí</a>';
      } else if (balance < 10000) {
        usageEl.innerHTML = 'Running low ‚Ä¢ <a href="#" onclick="showProPlanInfo();return false;" style="color:#FFD700;">Go Pro</a>';
      } else if (balance < 30000) {
        usageEl.innerHTML = 'Try <a href="#" onclick="showProPlanInfo();return false;" style="color:#FFD700;">Pro plan</a> for more';
      } else {
        usageEl.textContent = '‚úì Plenty available';
      }
    }
    console.log('[Tokens] Balance:', balance);
  } catch (e) {
    console.error('[Tokens] Error:', e);
    if (balanceEl) balanceEl.textContent = '‚àû Beta';
    if (usageEl) usageEl.textContent = 'Free during beta';
  }
}

function showProPlanInfo() {
  toast('Pro Plan: $9.99/mo for 500K tokens ‚Ä¢ Coming soon!', 4000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FILE EXPORT SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let exportState = {
  format: 'txt',
  scope: 'all',
  currentDropId: null
};

function openFileExportModal(dropId = null) {
  exportState.currentDropId = dropId;
  
  console.log('[Export] Opening modal, dropId:', dropId);
  
  // Use local ideas array (already decrypted in memory)
  const allDrops = ideas || [];
  document.getElementById('exportDropCount').textContent = allDrops.length;
  
  // Count filtered drops using curCat (current category filter)
  const currentFilter = curCat || 'all';
  const filteredDrops = currentFilter === 'all' ? allDrops : allDrops.filter(d => d.category === currentFilter);
  document.getElementById('exportFilteredCount').textContent = filteredDrops.length;
  
  // If called from a specific drop, pre-select "current"
  if (dropId) {
    exportState.scope = 'current';
    document.querySelectorAll('.export-scope-option').forEach(opt => {
      const input = opt.querySelector('input');
      const isCurrentOption = input.value === 'current';
      input.checked = isCurrentOption;
      opt.classList.toggle('active', isCurrentOption);
    });
  } else {
    exportState.scope = 'all';
    document.querySelectorAll('.export-scope-option').forEach(opt => {
      const input = opt.querySelector('input');
      const isAllOption = input.value === 'all';
      input.checked = isAllOption;
      opt.classList.toggle('active', isAllOption);
    });
  }
  
  // Generate default filename with full timestamp
  const now = new Date();
  const timestamp = now.toISOString().replace(/[:.]/g, '-').slice(0, 19);
  document.getElementById('exportFilename').value = `droplit-${timestamp}`;
  
  // Initialize format selection (default is txt, so hide doc options)
  exportState.format = 'txt';
  document.querySelectorAll('.export-format-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.format === 'txt');
  });
  const docOptions = document.getElementById('exportDocOptions');
  if (docOptions) docOptions.style.display = 'none';
  
  document.getElementById('fileExportOverlay').classList.add('show');
}

function closeFileExportModal() {
  document.getElementById('fileExportOverlay').classList.remove('show');
}

function selectExportFormat(format) {
  exportState.format = format;
  document.querySelectorAll('.export-format-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.format === format);
  });
  
  // Show/hide document-specific options (only for DOCX and PDF)
  const docOptions = document.getElementById('exportDocOptions');
  if (docOptions) {
    docOptions.style.display = (format === 'docx' || format === 'pdf') ? 'block' : 'none';
  }
}

function selectExportScope(scope) {
  exportState.scope = scope;
  document.querySelectorAll('.export-scope-option').forEach(opt => {
    const input = opt.querySelector('input');
    opt.classList.toggle('active', input.value === scope);
  });
}

function getExportDrops() {
  // Use local ideas array (already decrypted in memory)
  // ideas is defined at top level: let ideas = ...
  const allDrops = ideas || [];
  const currentFilter = curCat || 'all';
  
  console.log('[Export] scope:', exportState.scope, 'currentDropId:', exportState.currentDropId);
  console.log('[Export] allDrops count:', allDrops.length);
  
  switch (exportState.scope) {
    case 'current':
      if (exportState.currentDropId) {
        const targetId = Number(exportState.currentDropId);
        const found = allDrops.filter(d => Number(d.id) === targetId);
        console.log('[Export] Looking for ID:', targetId, 'found:', found.length);
        return found;
      }
      return [];
    case 'filtered':
      return currentFilter === 'all' ? allDrops : allDrops.filter(d => d.category === currentFilter);
    case 'all':
    default:
      return allDrops;
  }
}

async function executeFileExport() {
  console.log('[Export] executeFileExport called');
  console.log('[Export] exportState:', JSON.stringify(exportState));
  console.log('[Export] ideas length:', (ideas || []).length);
  
  const drops = getExportDrops();
  console.log('[Export] getExportDrops returned:', drops.length, 'drops');
  
  if (drops.length === 0) {
    toast('No drops to export', 'warning');
    return;
  }
  
  const filename = document.getElementById('exportFilename').value || 'droplit-export';
  const includeDate = document.getElementById('exportIncludeDate').checked;
  const includeCategory = document.getElementById('exportIncludeCategory').checked;
  const includeMeta = document.getElementById('exportIncludeMeta').checked;
  
  // Document-specific options
  const businessStyle = document.getElementById('exportBusinessStyle')?.checked ?? true;
  const pageSize = document.querySelector('input[name="pageSize"]:checked')?.value || 'a4';
  
  const docOptions = { businessStyle, pageSize };
  console.log('[Export] docOptions:', docOptions);
  
  // Helper: run with timeout
  async function withTimeout(promise, ms, name) {
    return Promise.race([
      promise,
      new Promise((_, reject) => 
        setTimeout(() => reject(new Error(`${name} timeout after ${ms/1000}s`)), ms)
      )
    ]);
  }
  
  try {
    let content, blob, ext;
    
    switch (exportState.format) {
      case 'txt':
        content = generateTXT(drops, includeDate, includeCategory);
        blob = new Blob(['\ufeff' + content], { type: 'text/plain;charset=utf-8' });
        ext = 'txt';
        break;
        
      case 'md':
        content = generateMarkdown(drops, includeDate, includeCategory, includeMeta);
        blob = new Blob(['\ufeff' + content], { type: 'text/markdown;charset=utf-8' });
        ext = 'md';
        break;
        
      case 'csv':
        content = generateCSV(drops, includeDate, includeCategory, includeMeta);
        blob = new Blob(['\ufeff' + content], { type: 'text/csv;charset=utf-8' });
        ext = 'csv';
        break;
        
      case 'docx':
        toast('Generating DOCX...', 'info');
        blob = await withTimeout(generateDOCX(drops, includeDate, includeCategory, docOptions), 30000, 'DOCX');
        ext = 'docx';
        break;
        
      case 'pdf':
        toast('Generating PDF...', 'info');
        blob = await withTimeout(generatePDF(drops, includeDate, includeCategory, docOptions), 30000, 'PDF');
        ext = 'pdf';
        break;
        
      default:
        throw new Error('Unknown format');
    }
    
    // Download file
    downloadBlob(blob, `${filename}.${ext}`);
    closeFileExportModal();
    toast(`Exported ${drops.length} drops as ${ext.toUpperCase()}`, 'success');
    
  } catch (error) {
    console.error('Export error:', error);
    toast('Export failed: ' + error.message, 'error');
  }
}

function downloadBlob(blob, filename) {
  console.log('[Export] downloadBlob called, size:', blob.size, 'name:', filename);
  
  try {
    // Method 1: Standard blob URL (works in most cases)
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.style.display = 'none';
    document.body.appendChild(a);
    
    // Use click with timeout for better compatibility
    setTimeout(() => {
      a.click();
      
      // Cleanup after delay
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        console.log('[Export] Download initiated via blob URL');
      }, 1000);
    }, 100);
    
  } catch (e1) {
    console.warn('[Export] Blob URL failed, trying data URL:', e1);
    
    // Method 2: Data URL fallback (for incognito/restricted environments)
    try {
      const reader = new FileReader();
      reader.onload = function() {
        const a = document.createElement('a');
        a.href = reader.result;
        a.download = filename;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        setTimeout(() => document.body.removeChild(a), 1000);
        console.log('[Export] Download initiated via data URL');
      };
      reader.readAsDataURL(blob);
    } catch (e2) {
      console.error('[Export] All download methods failed:', e2);
      toast('Download failed. Try right-click ‚Üí Save As', 'error');
    }
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// MARKDOWN PARSER ‚Üí AST (Robust version with protection)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function parseMarkdownToAST(text) {
  // Protection: limit input size
  if (!text || typeof text !== 'string') return [{ type: 'paragraph', content: [{ type: 'text', value: '' }] }];
  if (text.length > 50000) text = text.slice(0, 50000) + '\n\n[Text truncated...]';
  
  const ast = [];
  const lines = text.split('\n');
  let i = 0;
  let safetyCounter = 0;
  const MAX_ITERATIONS = 10000;
  
  try {
    while (i < lines.length && safetyCounter < MAX_ITERATIONS) {
      safetyCounter++;
      const line = lines[i];
      
      // Empty line ‚Üí skip
      if (!line || line.trim() === '') {
        i++;
        continue;
      }
      
      // Headers: # ## ###
      const headerMatch = line.match(/^(#{1,3})\s+(.+)$/);
      if (headerMatch) {
        ast.push({
          type: 'heading',
          level: headerMatch[1].length,
          content: parseInlineSafe(headerMatch[2])
        });
        i++;
        continue;
      }
      
      // Unordered list: - or * (but not ---)
      if (/^[\-\*]\s+./.test(line) && !/^[\-\*]{3,}/.test(line)) {
        const items = [];
        let listSafety = 0;
        while (i < lines.length && /^[\-\*]\s+/.test(lines[i]) && listSafety < 500) {
          listSafety++;
          const itemText = lines[i].replace(/^[\-\*]\s+/, '');
          items.push({ type: 'listItem', content: parseInlineSafe(itemText) });
          i++;
        }
        if (items.length > 0) {
          ast.push({ type: 'list', ordered: false, items });
        }
        continue;
      }
      
      // Ordered list: 1. 2. etc
      if (/^\d+\.\s+/.test(line)) {
        const items = [];
        let listSafety = 0;
        while (i < lines.length && /^\d+\.\s+/.test(lines[i]) && listSafety < 500) {
          listSafety++;
          const itemText = lines[i].replace(/^\d+\.\s+/, '');
          items.push({ type: 'listItem', content: parseInlineSafe(itemText) });
          i++;
        }
        if (items.length > 0) {
          ast.push({ type: 'list', ordered: true, items });
        }
        continue;
      }
      
      // Blockquote: >
      if (/^>\s*/.test(line)) {
        let quoteText = '';
        let quoteSafety = 0;
        while (i < lines.length && /^>\s*/.test(lines[i]) && quoteSafety < 100) {
          quoteSafety++;
          quoteText += lines[i].replace(/^>\s*/, '') + '\n';
          i++;
        }
        ast.push({
          type: 'blockquote',
          content: parseInlineSafe(quoteText.trim())
        });
        continue;
      }
      
      // Code block: ```
      if (line.startsWith('```')) {
        const lang = line.slice(3).trim();
        i++;
        let code = '';
        let codeSafety = 0;
        while (i < lines.length && !lines[i].startsWith('```') && codeSafety < 500) {
          codeSafety++;
          code += lines[i] + '\n';
          i++;
        }
        ast.push({ type: 'codeBlock', language: lang, code: code.trimEnd() });
        if (i < lines.length) i++; // skip closing ```
        continue;
      }
      
      // Horizontal rule: --- or ***
      if (/^[\-\*\_]{3,}\s*$/.test(line)) {
        ast.push({ type: 'hr' });
        i++;
        continue;
      }
      
      // Regular paragraph - single line or collect lines until break
      let paraText = line;
      i++;
      
      // Collect following lines that are plain text (not special)
      let paraSafety = 0;
      while (i < lines.length && paraSafety < 100) {
        const nextLine = lines[i];
        // Stop at empty line or special markdown
        if (!nextLine || nextLine.trim() === '' ||
            /^#{1,3}\s/.test(nextLine) ||
            /^[\-\*]\s+/.test(nextLine) ||
            /^\d+\.\s+/.test(nextLine) ||
            /^>\s*/.test(nextLine) ||
            nextLine.startsWith('```') ||
            /^[\-\*\_]{3,}\s*$/.test(nextLine)) {
          break;
        }
        paraText += '\n' + nextLine;
        i++;
        paraSafety++;
      }
      
      if (paraText.trim()) {
        ast.push({
          type: 'paragraph',
          content: parseInlineSafe(paraText)
        });
      }
    }
    
    if (safetyCounter >= MAX_ITERATIONS) {
      console.warn('[Export] Parser hit safety limit');
    }
    
  } catch (error) {
    console.error('[Export] Markdown parse error:', error);
    // Fallback: return as plain text
    return [{ type: 'paragraph', content: [{ type: 'text', value: text }] }];
  }
  
  return ast.length > 0 ? ast : [{ type: 'paragraph', content: [{ type: 'text', value: text }] }];
}

// Safe inline parser - handles **bold**, *italic*, `code`
function parseInlineSafe(text) {
  if (!text || typeof text !== 'string') return [{ type: 'text', value: '' }];
  if (text.length > 10000) text = text.slice(0, 10000);
  
  try {
    const result = [];
    let remaining = text;
    let safety = 0;
    const MAX_INLINE = 1000;
    
    // Pattern: **bold**, *italic*, `code`
    const regex = /(\*\*[^*]+\*\*|\*[^*]+\*|`[^`]+`)/g;
    let lastIndex = 0;
    let match;
    
    while ((match = regex.exec(text)) !== null && safety < MAX_INLINE) {
      safety++;
      
      // Text before match
      if (match.index > lastIndex) {
        result.push({ type: 'text', value: text.slice(lastIndex, match.index) });
      }
      
      const matched = match[0];
      if (matched.startsWith('**') && matched.endsWith('**')) {
        result.push({ type: 'bold', value: matched.slice(2, -2) });
      } else if (matched.startsWith('*') && matched.endsWith('*')) {
        result.push({ type: 'italic', value: matched.slice(1, -1) });
      } else if (matched.startsWith('`') && matched.endsWith('`')) {
        result.push({ type: 'code', value: matched.slice(1, -1) });
      }
      
      lastIndex = regex.lastIndex;
    }
    
    // Remaining text after last match
    if (lastIndex < text.length) {
      result.push({ type: 'text', value: text.slice(lastIndex) });
    }
    
    return result.length > 0 ? result : [{ type: 'text', value: text }];
    
  } catch (error) {
    console.error('[Export] Inline parse error:', error);
    return [{ type: 'text', value: text }];
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// TXT Export
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function generateTXT(drops, includeDate, includeCategory) {
  let output = 'DROPLIT EXPORT\n';
  output += '‚ïê'.repeat(50) + '\n\n';
  
  drops.forEach((drop, i) => {
    // Header line
    let header = `#${i + 1}`;
    if (includeCategory) {
      header += ` [${(drop.category || 'inbox').toUpperCase()}]`;
    }
    if (includeDate && (drop.date || drop.time)) {
      header += ` ${drop.date || ''} ${drop.time || ''}`;
    }
    output += header + '\n\n';
    
    // Content - preserve original formatting
    const text = drop.text || drop.content || '';
    output += text;
    
    // Ensure proper spacing
    if (!text.endsWith('\n')) output += '\n';
    output += '\n' + '‚îÄ'.repeat(50) + '\n\n';
  });
  
  output += `Exported: ${new Date().toLocaleString()}\n`;
  output += `Total: ${drops.length} drops\n`;
  
  return output;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Markdown Export
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function generateMarkdown(drops, includeDate, includeCategory, includeMeta) {
  let output = '# DropLit Export\n\n';
  output += `> Exported: ${new Date().toLocaleString()}  \n`;
  output += `> Total drops: ${drops.length}\n\n`;
  output += '---\n\n';
  
  drops.forEach((drop, i) => {
    // Header
    output += `## ${i + 1}. `;
    if (includeCategory) {
      const cat = (drop.category || 'inbox').toUpperCase();
      output += `\`${cat}\` `;
    }
    
    // First line as title
    const text = drop.text || drop.content || '';
    const firstLine = text.split('\n')[0].slice(0, 60);
    output += firstLine + (firstLine.length >= 60 ? '...' : '') + '\n\n';
    
    // Date/time
    if (includeDate && (drop.date || drop.time)) {
      output += `üìÖ *${drop.date || ''} ${drop.time || ''}*\n\n`;
    }
    
    // Content - preserve all formatting including empty lines
    output += text + '\n';
    
    // Metadata
    if (includeMeta) {
      output += '\n<details>\n<summary>üìã Metadata</summary>\n\n';
      output += `| Field | Value |\n`;
      output += `|-------|-------|\n`;
      output += `| ID | \`${drop.id}\` |\n`;
      output += `| Category | ${drop.category || 'inbox'} |\n`;
      output += `| Creator | ${drop.creator || 'user'} |\n`;
      output += `| Source | ${drop.source || 'unknown'} |\n`;
      if (drop.marker) output += `| Marker | ${drop.marker} |\n`;
      if (drop.timestamp) output += `| Timestamp | ${drop.timestamp} |\n`;
      output += '\n</details>\n';
    }
    
    output += '\n---\n\n';
  });
  
  return output;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// CSV Export
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function generateCSV(drops, includeDate, includeCategory, includeMeta) {
  const escape = (str) => {
    if (!str) return '';
    const s = String(str).replace(/"/g, '""');
    return s.includes(',') || s.includes('\n') || s.includes('"') ? `"${s}"` : s;
  };
  
  // Headers
  let headers = ['Text'];
  if (includeDate) headers.unshift('Date', 'Time');
  if (includeCategory) headers.unshift('Category');
  if (includeMeta) headers.push('ID', 'Creator', 'Source', 'Marker');
  
  let output = headers.join(',') + '\n';
  
  // Data rows
  drops.forEach(drop => {
    let row = [escape(drop.text || drop.content || '')];
    
    if (includeDate) {
      row.unshift(escape(drop.date || ''), escape(drop.time || ''));
    }
    if (includeCategory) {
      row.unshift(escape(drop.category || 'inbox'));
    }
    if (includeMeta) {
      row.push(
        escape(drop.id),
        escape(drop.creator || 'user'),
        escape(drop.source || ''),
        escape(drop.marker || '')
      );
    }
    
    output += row.join(',') + '\n';
  });
  
  return output;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// DOCX Export - WITH MARKDOWN RENDERING
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function generateDOCX(drops, includeDate, includeCategory, docOptions = {}) {
  try {
    // Load docx library if not loaded
    if (typeof docx === 'undefined' && !window.docx) {
      console.log('[Export] Loading docx library...');
      await loadScript('https://unpkg.com/docx@8.5.0/build/index.umd.js');
      await new Promise(r => setTimeout(r, 200));
    }
    
    const docxLib = window.docx || (typeof docx !== 'undefined' ? docx : null);
    if (!docxLib) throw new Error('DOCX library not loaded');
    
    const { Document, Packer, Paragraph, TextRun, HeadingLevel, AlignmentType, BorderStyle } = docxLib;
    
    const children = [];
    const userPlan = localStorage.getItem('droplit_user_plan') || 'beta';
    const showBranding = !['business', 'owner', 'vip'].includes(userPlan);
    
    // Document options
    const businessStyle = docOptions.businessStyle !== false; // default true
    const pageSize = docOptions.pageSize || 'a4';
    
    // Page dimensions (in twentieths of a point - DXA)
    // A4: 210mm x 297mm = 11906 x 16838 DXA
    // Letter: 8.5" x 11" = 12240 x 15840 DXA
    const PAGE_SIZES = {
      a4: { width: 11906, height: 16838 },
      letter: { width: 12240, height: 15840 }
    };
    const pageDims = PAGE_SIZES[pageSize] || PAGE_SIZES.a4;
    
    // Font settings
    const FONT = businessStyle ? 'Times New Roman' : 'Arial';
    const SIZE_BODY = businessStyle ? 28 : 24; // 14pt or 12pt
    const SIZE_H1 = businessStyle ? 36 : 32;
    const SIZE_H2 = businessStyle ? 32 : 28;  
    const SIZE_H3 = businessStyle ? 28 : 24;
    const SIZE_SMALL = 24; // 12pt
    
    console.log('[Export] DOCX options:', { businessStyle, pageSize, pageDims });
    
    // Process each drop
    for (let dropIndex = 0; dropIndex < drops.length; dropIndex++) {
      const drop = drops[dropIndex];
      
      // Drop header with metadata
      if (includeCategory || includeDate) {
        let headerParts = [];
        if (includeCategory) {
          headerParts.push(new TextRun({ 
            text: '[' + (drop.category || 'inbox').toUpperCase() + '] ',
            bold: true,
            font: FONT,
            size: SIZE_SMALL,
            color: '6366F1'
          }));
        }
        if (includeDate && (drop.date || drop.time)) {
          headerParts.push(new TextRun({ 
            text: (drop.date || '') + ' ' + (drop.time || ''),
            italics: true,
            font: FONT,
            color: '666666',
            size: SIZE_SMALL
          }));
        }
        children.push(new Paragraph({
          children: headerParts,
          spacing: { before: dropIndex > 0 ? 400 : 0, after: 100 }
        }));
      }
      
      // Get text content
      const text = drop.text || drop.content || '';
      
      // Business style: parse and render Markdown
      // Plain style: just text paragraphs
      if (businessStyle) {
        let ast;
        try {
          ast = parseMarkdownToAST(text);
        } catch (e) {
          console.error('[Export] AST parse error:', e);
          ast = [{ type: 'paragraph', content: [{ type: 'text', value: text }] }];
        }
        
        // Render AST to DOCX
        for (const node of ast) {
          try {
            switch (node.type) {
              case 'heading':
                children.push(new Paragraph({
                  children: renderInlineToDocx(node.content, docxLib, FONT, 
                    node.level === 1 ? SIZE_H1 : node.level === 2 ? SIZE_H2 : SIZE_H3),
                  heading: node.level === 1 ? HeadingLevel.HEADING_1 : 
                           node.level === 2 ? HeadingLevel.HEADING_2 : HeadingLevel.HEADING_3,
                  spacing: { before: 240, after: 120 }
                }));
                break;
                
              case 'paragraph':
                children.push(new Paragraph({
                  children: renderInlineToDocx(node.content, docxLib, FONT, SIZE_BODY),
                  spacing: { after: 200 }
                }));
                break;
                
              case 'list':
                for (let idx = 0; idx < node.items.length; idx++) {
                  const item = node.items[idx];
                  children.push(new Paragraph({
                    children: [
                      new TextRun({ 
                        text: node.ordered ? (idx + 1) + '. ' : '‚Ä¢ ',
                        font: FONT,
                        size: SIZE_BODY
                      }),
                      ...renderInlineToDocx(item.content, docxLib, FONT, SIZE_BODY)
                    ],
                    indent: { left: 720 },
                    spacing: { after: 80 }
                  }));
                }
                break;
                
              case 'blockquote':
                children.push(new Paragraph({
                  children: [
                    new TextRun({ text: '‚îÇ ', color: '9CA3AF', font: FONT, size: SIZE_BODY }),
                    ...renderInlineToDocx(node.content, docxLib, FONT, SIZE_BODY)
                  ],
                  indent: { left: 360 },
                  spacing: { after: 200 }
                }));
                break;
                
              case 'codeBlock':
                const codeLines = (node.code || '').split('\n');
                for (const codeLine of codeLines) {
                  children.push(new Paragraph({
                    children: [new TextRun({ 
                      text: codeLine || ' ',
                      font: 'Courier New',
                      size: SIZE_SMALL,
                      color: '374151'
                    })],
                    shading: { fill: 'F3F4F6' },
                    spacing: { after: 0 },
                    indent: { left: 360 }
                  }));
                }
                children.push(new Paragraph({ spacing: { after: 200 } }));
                break;
                
              case 'hr':
                children.push(new Paragraph({
                  children: [new TextRun({ text: ' ' })],
                  border: { bottom: { style: BorderStyle?.SINGLE || 'single', size: 6, color: 'CCCCCC' } },
                  spacing: { before: 200, after: 200 }
                }));
                break;
                
              default:
                const plainText = typeof node.content === 'string' ? node.content : '';
                if (plainText) {
                  children.push(new Paragraph({
                    children: [new TextRun({ text: plainText, font: FONT, size: SIZE_BODY })],
                    spacing: { after: 200 }
                  }));
                }
            }
          } catch (nodeError) {
            console.error('[Export] Node render error:', nodeError, node);
          }
        }
      } else {
        // Plain style - just paragraphs, no Markdown
        const paragraphs = text.split(/\n\n+/);
        for (const para of paragraphs) {
          if (!para.trim()) continue;
          const lines = para.split('\n');
          const runs = [];
          for (let idx = 0; idx < lines.length; idx++) {
            if (idx > 0) runs.push(new TextRun({ break: 1 }));
            runs.push(new TextRun({ text: lines[idx], font: FONT, size: SIZE_BODY }));
          }
          children.push(new Paragraph({
            children: runs,
            spacing: { after: 200 }
          }));
        }
      }
      
      // Separator between drops
      if (dropIndex < drops.length - 1) {
        children.push(new Paragraph({
          children: [new TextRun({ text: ' ' })],
          spacing: { before: 100, after: 100 }
        }));
      }
    }
    
    // Footer with branding (for free/beta users)
    if (showBranding) {
      children.push(new Paragraph({
        children: [new TextRun({ 
          text: 'Created with DropLit.app',
          font: FONT,
          size: 18,
          color: '9CA3AF',
          italics: true
        })],
        alignment: AlignmentType?.CENTER || 'center',
        spacing: { before: 600 }
      }));
    }
    
    const doc = new Document({
      sections: [{
        properties: {
          page: {
            size: { width: pageDims.width, height: pageDims.height },
            margin: { top: 1440, right: 1440, bottom: 1440, left: 1440 }
          }
        },
        children
      }]
    });
    
    const blob = await Packer.toBlob(doc);
    console.log('[Export] DOCX blob created, size:', blob.size);
    return blob;
    
  } catch (error) {
    console.error('[Export] DOCX generation error:', error);
    throw new Error('DOCX: ' + error.message);
  }
}

// Render inline AST nodes to DOCX TextRuns
function renderInlineToDocx(nodes, docxLib, font, size) {
  const { TextRun } = docxLib;
  const runs = [];
  
  if (!nodes || !Array.isArray(nodes)) {
    const text = typeof nodes === 'string' ? nodes : '';
    return [new TextRun({ text, font, size })];
  }
  
  for (const node of nodes) {
    try {
      const text = typeof node.value === 'string' ? node.value : String(node.value || '');
      switch (node.type) {
        case 'bold':
          runs.push(new TextRun({ text, bold: true, font, size }));
          break;
        case 'italic':
          runs.push(new TextRun({ text, italics: true, font, size }));
          break;
        case 'code':
          runs.push(new TextRun({ text, font: 'Courier New', size: size - 4, color: '7C3AED' }));
          break;
        case 'text':
        default:
          runs.push(new TextRun({ text, font, size }));
      }
    } catch (e) {
      console.error('[Export] TextRun error:', e);
    }
  }
  
  return runs.length > 0 ? runs : [new TextRun({ text: '', font, size })];
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// PDF Export - ROBUST VERSION (larger font, page size options)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function generatePDF(drops, includeDate, includeCategory, docOptions = {}) {
  console.log('[Export] Starting PDF generation for', drops.length, 'drops');
  
  try {
    // Load jsPDF
    if (!window.jspdf) {
      console.log('[Export] Loading jsPDF...');
      await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
      await new Promise(r => setTimeout(r, 200));
    }
    
    if (!window.jspdf) throw new Error('jsPDF not loaded');
    
    const { jsPDF } = window.jspdf;
    
    // Page size: a4 or letter
    const pageSize = docOptions.pageSize || 'a4';
    const doc = new jsPDF({ format: pageSize });
    
    const userPlan = localStorage.getItem('droplit_user_plan') || 'beta';
    const showBranding = !['business', 'owner', 'vip'].includes(userPlan);
    
    // Page dimensions depend on format
    // A4: 210x297mm, Letter: 215.9x279.4mm
    const isLetter = pageSize === 'letter';
    const pageWidth = isLetter ? 175 : 170;
    const pageHeight = isLetter ? 250 : 270;
    
    let y = 25;
    const margin = 20;
    const lineHeight = 8;
    
    console.log('[Export] PDF options:', { pageSize, pageWidth, pageHeight });
    
    // Process each drop
    for (let dropIndex = 0; dropIndex < drops.length; dropIndex++) {
      const drop = drops[dropIndex];
      console.log('[Export] Processing drop', dropIndex + 1);
      
      // New page if needed
      if (y > pageHeight - 40) {
        doc.addPage();
        y = 25;
      }
      
      // Header with category/date
      if (includeCategory || includeDate) {
        doc.setFontSize(11);
        doc.setFont('helvetica', 'bold');
        
        let header = '';
        if (includeCategory) {
          doc.setTextColor(99, 102, 241);
          header += '[' + (drop.category || 'inbox').toUpperCase() + '] ';
        }
        if (includeDate && (drop.date || drop.time)) {
          header += (drop.date || '') + ' ' + (drop.time || '');
        }
        
        doc.text(header, margin, y);
        y += lineHeight + 2;
        doc.setTextColor(0, 0, 0);
      }
      
      // Content
      doc.setFontSize(13);
      doc.setFont('helvetica', 'normal');
      
      const text = drop.text || drop.content || '';
      const paragraphs = text.split(/\n/);
      
      for (let pIdx = 0; pIdx < paragraphs.length && pIdx < 200; pIdx++) {
        const para = paragraphs[pIdx];
        
        if (!para.trim()) {
          y += lineHeight / 2;
          continue;
        }
        
        // Clean markdown markers
        let cleanText = para
          .replace(/\*\*([^*]+)\*\*/g, '$1')
          .replace(/\*([^*]+)\*/g, '$1')
          .replace(/`([^`]+)`/g, '$1')
          .replace(/^#+\s*/, '')
          .replace(/^[\-\*]\s+/, '‚Ä¢ ')
          .replace(/^\d+\.\s+/, (m) => m);
        
        // Note: Cyrillic will show as "?" - jsPDF limitation
        // For Cyrillic, recommend DOCX or TXT export
        
        try {
          const lines = doc.splitTextToSize(cleanText, pageWidth);
          
          for (const line of lines) {
            if (y > pageHeight) {
              doc.addPage();
              y = 25;
            }
            doc.text(line, margin, y);
            y += lineHeight;
          }
        } catch (e) {
          doc.text(cleanText.slice(0, 80), margin, y);
          y += lineHeight;
        }
      }
      
      // Separator
      y += 5;
      if (dropIndex < drops.length - 1) {
        doc.setDrawColor(200, 200, 200);
        doc.line(margin, y, margin + pageWidth, y);
        y += 10;
      }
    }
    
    // Footer branding
    if (showBranding) {
      const footerY = isLetter ? 265 : 285;
      doc.setFontSize(9);
      doc.setFont('helvetica', 'italic');
      doc.setTextColor(150, 150, 150);
      doc.text('Created with DropLit.app', 105, footerY, { align: 'center' });
    }
    
    console.log('[Export] PDF generation complete');
    return doc.output('blob');
    
  } catch (error) {
    console.error('[Export] PDF generation error:', error);
    throw new Error('PDF: ' + error.message);
  }
}

// Simplified inline renderer for PDF
function renderInlineToPdf(nodes) {
  if (!nodes) return '';
  if (typeof nodes === 'string') return nodes;
  if (!Array.isArray(nodes)) return String(nodes);
  
  return nodes.map(n => {
    if (typeof n === 'string') return n;
    if (typeof n.value === 'string') return n.value;
    if (typeof n.text === 'string') return n.text;
    return '';
  }).join('');
}

// Helper: load external script
function loadScript(src) {
  return new Promise((resolve, reject) => {
    if (document.querySelector(`script[src="${src}"]`)) {
      resolve();
      return;
    }
    const script = document.createElement('script');
    script.src = src;
    script.onload = resolve;
    script.onerror = reject;
    document.head.appendChild(script);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// END FILE EXPORT SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function toast(m,t='info'){
  const w=document.getElementById('toastWrap'),el=document.createElement('div');
  el.className='toast '+t;
  el.innerHTML=({success:'OK',warning:'!',error:'X',info:'i'})[t]+' '+m;
  w.appendChild(el);
  setTimeout(()=>el.classList.add('show'),10);
  setTimeout(()=>{el.classList.remove('show');setTimeout(()=>el.remove(),300);},2500);
}

function updateNet(){document.getElementById('netBanner').classList.toggle('show',!navigator.onLine);}
window.addEventListener('online',updateNet);
window.addEventListener('offline',updateNet);

// Handle page visibility changes (screen lock, tab switch)
document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    // Page is hidden - stop voice mode listening
    if (voiceModeRecognition) {
      stopVoiceModeListening();
      voiceModeSleeping = true;
      updateVoiceModeIndicator('sleeping');
      console.log('Voice mode paused (page hidden)');
    }
  } else {
    // Page is visible again - re-acquire Wake Lock if chat is open
    if (document.getElementById('askAIPanel')?.classList.contains('show')) {
      acquireWakeLock();
      console.log('Wake Lock re-acquired (page visible)');
    }
  }
});

document.addEventListener('DOMContentLoaded',()=>{
  // Initialize roll-up mode BEFORE render
  if (localStorage.getItem('droplit_rollup_mode') === 'true') {
    rollUpMode = true;
    document.getElementById('rollUpModeToggle')?.classList.add('active');
  }
  
  initSR();render();counts();updateNet();initFiltersState();
  setTimeout(scrollToBottomInstant,50);
  
  // Initialize dark mode
  if (localStorage.getItem('droplit_darkmode') === 'true') {
    document.getElementById('darkModeToggle')?.classList.add('active');
    document.body.classList.add('dark-mode');
  }
  
  // Initialize auto-speak
  if (localStorage.getItem('aski_auto_speak') === 'true') {
    document.getElementById('autoSpeakToggle')?.classList.add('active');
  }
  
  // Initialize voice mode
  if (localStorage.getItem('aski_voice_mode') === 'true') {
    document.getElementById('voiceModeToggle')?.classList.add('active');
  }
  
  // Initialize voice selector (OpenAI TTS)
  const savedVoice = localStorage.getItem('aski_voice') || 'nova';
  document.querySelectorAll('#voiceSelector .pill-m').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.voice === savedVoice);
  });
  
  // FIX v0.9.117: Initialize TTS Provider selector
  const savedProvider = localStorage.getItem('tts_provider') || 'openai';
  document.querySelectorAll('#ttsProviderSelector .pill-m').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.provider === savedProvider);
  });
  // Show/hide provider-specific settings
  const openaiVoiceSettings = document.getElementById('openaiVoiceSettings');
  const elevenlabsVoiceSettings = document.getElementById('elevenlabsVoiceSettings');
  if (openaiVoiceSettings) openaiVoiceSettings.style.display = (savedProvider === 'openai') ? 'block' : 'none';
  if (elevenlabsVoiceSettings) elevenlabsVoiceSettings.style.display = (savedProvider === 'elevenlabs') ? 'block' : 'none';
  
  // Initialize ElevenLabs voice selector
  const savedElevenLabsVoiceId = localStorage.getItem('elevenlabs_voice_id') || 'EXAVITQu4vr4xnSDxMaL';
  document.querySelectorAll('#elevenlabsVoiceSelector .pill-m').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.voiceid === savedElevenLabsVoiceId);
  });
  
  // Initialize AI model selector
  initAIModelSelector();
  
  // Load OpenAI API key on page load
  setTimeout(loadOpenAIKey, 100);
  
  // Initialize listen time
  const savedSeconds = localStorage.getItem('aski_listen_seconds') || '15';
  document.querySelectorAll('#listenCyclesSelector .pill-m').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.cycles === savedSeconds);
  });
  
  // Initialize font size (function is in settings.js)
  const savedFontSize = localStorage.getItem('droplit_fontsize') || 'normal';
  document.body.classList.add('font-' + savedFontSize);
  // Update button state
  document.querySelectorAll('#fontSizeSelector .pill-m').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.size === savedFontSize);
  });
  
  // Initialize sensitive data protection settings
  initSensitiveSettings();
  
  // Initialize archive toggle (v0.9.105)
  if (localStorage.getItem('droplit_show_archived') === 'true') {
    showArchived = true;
    document.getElementById('showArchivedToggle')?.classList.add('active');
  }
});

// ============================================
// AI MODEL FUNCTIONS
// ============================================

const AI_PERSONAS = {
  'sonnet': {
    name: 'ASKI',
    subtitle: 'AI Assistant',
    description: 'Fast, creative, enthusiastic',
    color: '#8B5CF6',
    gradient: 'linear-gradient(135deg, #8B5CF6, #6366F1)',
    avatar: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m12 3-1.9 5.8a2 2 0 0 1-1.3 1.3L3 12l5.8 1.9a2 2 0 0 1 1.3 1.3L12 21l1.9-5.8a2 2 0 0 1 1.3-1.3L21 12l-5.8-1.9a2 2 0 0 1-1.3-1.3Z"/></svg>',
    avatarLetter: 'A'
  },
  'opus': {
    name: 'NOUS',
    subtitle: 'Deep Thinking',
    description: 'No us ‚Äî –Ω–∞–º –Ω–µ—Ç —Ä–∞–≤–Ω—ã—Ö',
    color: '#1E1B4B',
    colorAccent: '#D4AF37',
    gradient: 'linear-gradient(135deg, #312E81, #1E1B4B)',
    avatar: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="4"/><circle cx="12" cy="12" r="1" fill="currentColor"/></svg>',
    avatarLetter: 'N'
  },
  'haiku': {
    name: 'ASKI Quick',
    subtitle: 'Lightning Fast',
    description: 'Instant responses',
    color: '#06B6D4',
    gradient: 'linear-gradient(135deg, #06B6D4, #0891B2)',
    avatar: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>',
    avatarLetter: 'Q'
  }
};

function initAIModelSelector() {
  const savedModel = localStorage.getItem('aski_model') || 'sonnet';
  document.querySelectorAll('#aiModelSelector .pill-m').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.model === savedModel);
  });
  updateAIPersona(savedModel);
}

function setAIModel(model) {
  localStorage.setItem('aski_model', model);
  
  // Update UI
  document.querySelectorAll('#aiModelSelector .pill-m').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.model === model);
  });
  
  updateAIPersona(model);
  
  const persona = AI_PERSONAS[model] || AI_PERSONAS['sonnet'];
  toast(persona.name + ' activated', 'success');
}

function updateAIPersona(model) {
  const persona = AI_PERSONAS[model] || AI_PERSONAS['sonnet'];
  
  // Update description
  const desc = document.getElementById('aiModelDescription');
  if (desc) desc.textContent = persona.description;
  
  // Update chat header
  const title = document.getElementById('askiTitle');
  if (title) title.textContent = persona.name;
  
  const subtitle = document.getElementById('askiSubtitle');
  if (subtitle) subtitle.textContent = persona.subtitle;
  
  // Update chat avatar
  const avatar = document.querySelector('.ask-ai-avatar');
  if (avatar) {
    avatar.textContent = persona.avatarLetter;
    avatar.style.background = persona.gradient;
  }
  
  // Update panel class for styling
  const panel = document.getElementById('askAIPanel');
  if (panel) {
    panel.classList.remove('persona-sonnet', 'persona-opus', 'persona-haiku');
    panel.classList.add('persona-' + model);
  }
}

function getAIModel() {
  return localStorage.getItem('aski_model') || 'sonnet';
}

function getAIPersona() {
  const model = getAIModel();
  return AI_PERSONAS[model] || AI_PERSONAS['sonnet'];
}

// ============================================
// AUTODROP FUNCTIONS ‚Äî v1.1 FIXED
// ============================================

// Current chat session ID
let currentChatSessionId = null;

function generateChatSessionId() {
  currentChatSessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  console.log('[AutoDrop] New session:', currentChatSessionId);
  return currentChatSessionId;
}

function clearChatSessionId() {
  console.log('[AutoDrop] Session cleared:', currentChatSessionId);
  currentChatSessionId = null;
}

function getChatSessionId() {
  return currentChatSessionId;
}

function toggleAutoDrop() {
  const currentState = localStorage.getItem('droplit_autodrop');
  const newEnabled = currentState !== 'true';
  
  localStorage.setItem('droplit_autodrop', newEnabled ? 'true' : 'false');
  
  // Update BOTH UI elements
  const toggle = document.getElementById('autoDropToggle');
  if (toggle) toggle.classList.toggle('active', newEnabled);
  
  const indicator = document.getElementById('autoDropIndicator');
  if (indicator) {
    indicator.classList.toggle('active', newEnabled);
    indicator.textContent = newEnabled ? 'AUTODROP ON' : 'AUTODROP';
  }
  
  toast(newEnabled ? 'AutoDrop enabled' : 'AutoDrop disabled');
}

function toggleAutoDropFromChat() {
  toggleAutoDrop();
}

function updateAutoDropIndicator() {
  const enabled = localStorage.getItem('droplit_autodrop') === 'true';
  
  const toggle = document.getElementById('autoDropToggle');
  if (toggle) toggle.classList.toggle('active', enabled);
  
  const indicator = document.getElementById('autoDropIndicator');
  if (indicator) {
    indicator.classList.toggle('active', enabled);
    indicator.textContent = enabled ? 'AUTODROP ON' : 'AUTODROP';
  }
}

// User email for ASKI send_email
function saveUserEmail() {
  const input = document.getElementById('userEmailInput');
  if (input && input.value) {
    localStorage.setItem('droplit_user_email', input.value.trim());
  }
}

function loadUserEmail() {
  const email = localStorage.getItem('droplit_user_email') || '';
  const input = document.getElementById('userEmailInput');
  if (input) {
    input.value = email;
  }
  return email;
}

function getUserEmail() {
  return localStorage.getItem('droplit_user_email') || '';
}

// ASKI Knowledge Base functions
function saveAskiKnowledge() {
  const input = document.getElementById('askiKnowledgeInput');
  if (input) {
    localStorage.setItem('droplit_aski_knowledge', input.value);
    console.log('[Knowledge] Saved:', input.value.length, 'chars');
  }
}

function loadAskiKnowledge() {
  const knowledge = localStorage.getItem('droplit_aski_knowledge') || '';
  const input = document.getElementById('askiKnowledgeInput');
  if (input) {
    input.value = knowledge;
  }
  return knowledge;
}

function getAskiKnowledge() {
  return localStorage.getItem('droplit_aski_knowledge') || '';
}

function exportAskiKnowledge() {
  const knowledge = getAskiKnowledge();
  if (!knowledge) {
    toast('Knowledge base is empty', 'warning');
    return;
  }
  
  const blob = new Blob([knowledge], { type: 'text/markdown' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'aski-knowledge.md';
  a.click();
  URL.revokeObjectURL(url);
  toast('Knowledge exported', 'success');
}

function importAskiKnowledge(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    const content = e.target.result;
    localStorage.setItem('droplit_aski_knowledge', content);
    loadAskiKnowledge();
    toast('Knowledge imported: ' + file.name, 'success');
  };
  reader.readAsText(file);
  
  // Reset input
  event.target.value = '';
}

function autoSaveMessageAsDrop(text, isUser) {
  const isEnabled = localStorage.getItem('droplit_autodrop') === 'true';
  
  if (!isEnabled) {
    console.log('[AutoDrop] Skipped - disabled');
    return null;
  }
  
  if (!text || !text.trim()) return null;
  
  const now = new Date();
  const drop = {
    id: Date.now(),
    text: text,
    category: 'inbox',
    timestamp: now.toISOString(),
    date: now.toLocaleDateString('ru-RU'),
    time: now.toLocaleTimeString('ru-RU', {hour:'2-digit', minute:'2-digit'}),
    isMedia: false,
    creator: isUser ? 'user' : 'aski',
    source: 'autodrop',
    sessionId: currentChatSessionId,
    encrypted: window.DROPLIT_PRIVACY_ENABLED || false
  };
  
  ideas.unshift(drop);
  save(drop);
  counts();
  
  // Play sound for feedback
  if (typeof playDropSound === 'function') {
    playDropSound();
  }
  
  console.log('[AutoDrop] Saved:', isUser ? 'User' : 'ASKI', 'session:', currentChatSessionId?.slice(-8));
  return drop;
}

// ============================================
// MAIN MENU FUNCTIONS
// ============================================
function toggleMainMenu() {
  const menu = document.getElementById('mainMenu');
  if (!menu) return;
  
  if (menu.classList.contains('show')) {
    closeMainMenu();
  } else {
    openMainMenu();
  }
}

// ============================================
// SENSITIVE DATA PROTECTION SYSTEM v1.0
// ============================================

// Patterns for sensitive data detection (US/Global)
const SENSITIVE_PATTERNS = {
  // Credit Cards (Visa, MC, Amex, Discover)
  creditCard: {
    pattern: /\b(?:4[0-9]{3}|5[1-5][0-9]{2}|3[47][0-9]{2}|6(?:011|5[0-9]{2}))[- ]?[0-9]{4}[- ]?[0-9]{4}[- ]?[0-9]{1,4}\b/g,
    label: 'Credit Card',
    icon: 'üí≥'
  },
  // SSN (US Social Security Number)
  ssn: {
    pattern: /\b\d{3}[-\s]?\d{2}[-\s]?\d{4}\b/g,
    label: 'SSN',
    icon: 'üÜî',
    // Exclude dates like 123-45-6789
    validate: (match) => {
      const clean = match.replace(/[-\s]/g, '');
      // SSN can't start with 000, 666, or 900-999
      const area = parseInt(clean.substring(0, 3));
      return area > 0 && area !== 666 && area < 900;
    }
  },
  // CVV/CVC
  cvv: {
    pattern: /\b(?:CVV|CVC|CVV2|CVC2|security code)[:\s]*(\d{3,4})\b/gi,
    label: 'CVV',
    icon: 'üî¢'
  },
  // PIN codes (when explicitly mentioned)
  pin: {
    pattern: /\b(?:PIN|pin code|pincode)[:\s]*(\d{4,6})\b/gi,
    label: 'PIN',
    icon: 'üîë'
  },
  // Passwords (when explicitly mentioned)
  password: {
    pattern: /\b(?:password|passwd|pwd|pass)[:\s]+(\S{4,})\b/gi,
    label: 'Password',
    icon: 'üîí'
  },
  // API Keys / Tokens (common patterns)
  apiKey: {
    pattern: /\b(?:api[_-]?key|token|secret|auth)[:\s=]+['"]?([a-zA-Z0-9_-]{20,})['"]?\b/gi,
    label: 'API Key/Token',
    icon: 'üóùÔ∏è'
  },
  // Bank Account + Routing (US)
  bankAccount: {
    pattern: /\b(?:account|acct)[:\s#]*(\d{8,17})\b/gi,
    label: 'Bank Account',
    icon: 'üè¶'
  }
};

// State for pending save
let pendingSensitiveSave = null;

// Detect sensitive data in text
function detectSensitiveData(text) {
  if (!text || typeof text !== 'string') return [];
  
  const detected = [];
  
  for (const [type, config] of Object.entries(SENSITIVE_PATTERNS)) {
    const matches = text.match(config.pattern);
    if (matches) {
      for (const match of matches) {
        // Run additional validation if exists
        if (config.validate && !config.validate(match)) continue;
        
        detected.push({
          type: type,
          label: config.label,
          icon: config.icon,
          value: match,
          masked: maskSensitiveValue(match, type)
        });
      }
    }
  }
  
  return detected;
}

// Mask a sensitive value
function maskSensitiveValue(value, type) {
  const clean = value.replace(/[-\s]/g, '');
  
  switch(type) {
    case 'creditCard':
      // Show last 4 digits
      return '****-****-****-' + clean.slice(-4);
    case 'ssn':
      return '***-**-' + clean.slice(-4);
    case 'cvv':
    case 'pin':
      return '****';
    case 'password':
    case 'apiKey':
      return '[REDACTED]';
    case 'bankAccount':
      return '****' + clean.slice(-4);
    default:
      return '****';
  }
}

// Mask all sensitive data in text
function maskSensitiveInText(text) {
  if (!text) return text;
  
  let masked = text;
  
  for (const [type, config] of Object.entries(SENSITIVE_PATTERNS)) {
    masked = masked.replace(config.pattern, (match) => {
      if (config.validate && !config.validate(match)) return match;
      return maskSensitiveValue(match, type);
    });
  }
  
  return masked;
}

// Export for chat.js to use before sending to AI
window.maskSensitiveForAI = maskSensitiveInText;
window.detectSensitiveData = detectSensitiveData;
window.isSensitiveProtectionEnabled = isSensitiveProtectionEnabled;

// Check if sensitive protection is enabled
function isSensitiveProtectionEnabled() {
  return localStorage.getItem('droplit_sensitive_protection') !== 'false';
}

// Get sensitive action mode
function getSensitiveAction() {
  return localStorage.getItem('droplit_sensitive_action') || 'warn';
}

// Toggle sensitive protection
function toggleSensitiveProtection() {
  const toggle = document.getElementById('sensitiveDataToggle');
  const enabled = !toggle.classList.contains('active');
  
  toggle.classList.toggle('active', enabled);
  localStorage.setItem('droplit_sensitive_protection', enabled ? 'true' : 'false');
  
  toast(enabled ? 'üõ°Ô∏è Sensitive data protection ON' : '‚ö†Ô∏è Protection disabled', enabled ? 'success' : 'info');
}

// Set sensitive action mode
function setSensitiveAction(action) {
  localStorage.setItem('droplit_sensitive_action', action);
  
  document.querySelectorAll('#sensitiveActionSelector .pill-m').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.action === action);
  });
  
  const labels = { mask: 'Auto-mask', warn: 'Warn me', ignore: 'Ignore' };
  toast('Sensitive data: ' + labels[action], 'info');
}

// Initialize sensitive settings UI
function initSensitiveSettings() {
  const enabled = isSensitiveProtectionEnabled();
  const action = getSensitiveAction();
  
  const toggle = document.getElementById('sensitiveDataToggle');
  if (toggle) toggle.classList.toggle('active', enabled);
  
  document.querySelectorAll('#sensitiveActionSelector .pill-m').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.action === action);
  });
}

// Show sensitive warning modal
function showSensitiveWarning(detected, saveCallback) {
  pendingSensitiveSave = saveCallback;
  
  const listEl = document.getElementById('sensitiveDataList');
  listEl.innerHTML = detected.map(d => 
    `<div style="margin-bottom: 6px;">${d.icon} <strong>${d.label}:</strong> <span style="color: #EF4444;">${d.value}</span></div>`
  ).join('');
  
  document.getElementById('sensitiveWarningModal').classList.add('show');
}

// Close sensitive warning
function closeSensitiveWarning() {
  document.getElementById('sensitiveWarningModal').classList.remove('show');
  pendingSensitiveSave = null;
}

// Save with masked data
function saveSensitiveAsMasked() {
  if (pendingSensitiveSave) {
    pendingSensitiveSave(true); // true = mask
  }
  closeSensitiveWarning();
}

// Save as is (no masking)
function saveSensitiveAsIs() {
  if (pendingSensitiveSave) {
    pendingSensitiveSave(false); // false = don't mask
  }
  closeSensitiveWarning();
}

// Check text for sensitive data before save
// Returns: { proceed: boolean, text: string }
function checkSensitiveBeforeSave(text, callback) {
  if (!isSensitiveProtectionEnabled()) {
    callback(text);
    return;
  }
  
  const detected = detectSensitiveData(text);
  if (detected.length === 0) {
    callback(text);
    return;
  }
  
  const action = getSensitiveAction();
  
  switch(action) {
    case 'mask':
      // Auto-mask and proceed
      const masked = maskSensitiveInText(text);
      toast('üõ°Ô∏è Sensitive data auto-masked', 'success');
      callback(masked);
      break;
      
    case 'warn':
      // Show warning modal
      showSensitiveWarning(detected, (shouldMask) => {
        if (shouldMask) {
          callback(maskSensitiveInText(text));
          toast('üõ°Ô∏è Saved with masking', 'success');
        } else {
          callback(text);
          toast('üíæ Saved as is', 'info');
        }
      });
      break;
      
    case 'ignore':
    default:
      callback(text);
      break;
  }
}

// ============================================
// PRINT FUNCTION
// ============================================

function printDrops() {
  // Get drops to print based on export scope
  const scope = document.querySelector('input[name="exportScope"]:checked')?.value || 'all';
  let dropsToPrint = [];
  
  if (scope === 'current' && exportState.dropId) {
    const drop = ideas.find(d => d.id === exportState.dropId);
    if (drop) dropsToPrint = [drop];
  } else if (scope === 'filtered') {
    dropsToPrint = filtered();
  } else {
    dropsToPrint = [...ideas].filter(d => d && d.text);
  }
  
  if (dropsToPrint.length === 0) {
    toast('Nothing to print', 'error');
    return;
  }
  
  // Create print content
  const includeDate = document.getElementById('exportIncludeDate')?.checked ?? true;
  const includeCategory = document.getElementById('exportIncludeCategory')?.checked ?? true;
  
  let content = `
    <html>
    <head>
      <title>DropLit Export</title>
      <style>
        body { font-family: 'Times New Roman', serif; font-size: 14pt; line-height: 1.6; padding: 20px; max-width: 800px; margin: 0 auto; }
        .drop { margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid #ddd; }
        .drop:last-child { border-bottom: none; }
        .drop-meta { font-size: 11pt; color: #666; margin-bottom: 8px; }
        .drop-text { white-space: pre-wrap; }
        h1, h2, h3 { margin-top: 16px; margin-bottom: 8px; }
        blockquote { border-left: 3px solid #ccc; padding-left: 12px; margin: 8px 0; color: #555; }
        code { background: #f5f5f5; padding: 2px 6px; border-radius: 3px; font-family: monospace; }
        ul, ol { margin: 8px 0; padding-left: 24px; }
        .footer { margin-top: 40px; text-align: center; font-size: 10pt; color: #999; font-style: italic; }
        @media print { 
          body { padding: 0; }
          .footer { position: fixed; bottom: 20px; left: 0; right: 0; }
        }
      </style>
    </head>
    <body>
      <h1 style="text-align: center; margin-bottom: 32px;">DropLit Notes</h1>
  `;
  
  for (const drop of dropsToPrint) {
    content += '<div class="drop">';
    
    if (includeDate || includeCategory) {
      content += '<div class="drop-meta">';
      if (includeCategory && drop.category) {
        content += `[${drop.category.toUpperCase()}] `;
      }
      if (includeDate && drop.date) {
        content += `${drop.date} ${drop.time || ''}`;
      }
      content += '</div>';
    }
    
    // Simple markdown rendering for print
    let text = drop.text || '';
    text = text.replace(/</g, '&lt;').replace(/>/g, '&gt;'); // Escape HTML
    text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
    text = text.replace(/`(.*?)`/g, '<code>$1</code>');
    text = text.replace(/^### (.*?)$/gm, '<h3>$1</h3>');
    text = text.replace(/^## (.*?)$/gm, '<h2>$1</h2>');
    text = text.replace(/^# (.*?)$/gm, '<h1>$1</h1>');
    text = text.replace(/^> (.*?)$/gm, '<blockquote>$1</blockquote>');
    text = text.replace(/^- (.*?)$/gm, '<li>$1</li>');
    
    content += `<div class="drop-text">${text}</div>`;
    content += '</div>';
  }
  
  content += `
      <div class="footer">Created with DropLit.app</div>
    </body>
    </html>
  `;
  
  // Open print window
  const printWindow = window.open('', '_blank');
  if (printWindow) {
    printWindow.document.write(content);
    printWindow.document.close();
    
    // Wait for content to load, then print
    printWindow.onload = function() {
      printWindow.print();
    };
    
    // Fallback if onload doesn't fire
    setTimeout(() => {
      printWindow.print();
    }, 500);
    
    toast('üñ®Ô∏è Print dialog opened', 'success');
  } else {
    toast('Popup blocked. Please allow popups.', 'error');
  }
  
  closeFileExportModal();
}

// ============================================
// SECURITY INDICATOR FUNCTIONS
// ============================================

function updateSecurityIndicator() {
  const lockBtn = document.getElementById('headerLock');
  const securityBanner = document.getElementById('securityBanner');
  
  // Check multiple sources for encryption status
  const encEnabled = 
    localStorage.getItem('droplit_encryption_enabled') === 'true' || 
    window.DROPLIT_PRIVACY_ENABLED === true ||
    (typeof DropLitEncryptedSync !== 'undefined' && DropLitEncryptedSync.isEnabled && DropLitEncryptedSync.isEnabled());
  
  if (lockBtn) {
    lockBtn.style.display = encEnabled ? 'flex' : 'none';
  }
  
  if (securityBanner) {
    securityBanner.style.display = encEnabled ? 'flex' : 'none';
  }
  
  console.log('[Security] Encryption enabled:', encEnabled);
}

function showSecurityInfo() {
  // Remove existing
  const existing = document.getElementById('securityInfoModal');
  if (existing) existing.remove();
  
  const modal = document.createElement('div');
  modal.id = 'securityInfoModal';
  modal.innerHTML = `
    <div class="security-modal-overlay" onclick="closeSecurityInfo()"></div>
    <div class="security-modal">
      <div class="security-modal-header">
        <div class="security-modal-header-icon">üîê</div>
        <h3 class="security-modal-header-title">AES-256-GCM</h3>
        <div class="security-modal-header-status">–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ</div>
      </div>
      <div class="security-modal-body">
        <div class="security-modal-details">
          ‚Ä¢ –í—Å–µ –¥–∞–Ω–Ω—ã–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ã –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ<br>
          ‚Ä¢ –ö–ª—é—á–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è —Ç–æ–ª—å–∫–æ —É –≤–∞—Å<br>
          ‚Ä¢ Syntrise Inc. –Ω–µ –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø–∞<br>
          ‚Ä¢ –î–∞–Ω–Ω—ã–µ –Ω–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è —Ç—Ä–µ—Ç—å–∏–º –ª–∏—Ü–∞–º
        </div>
        <div class="security-modal-warning">
          ‚ö†Ô∏è –£—Ç–µ—Ä—è –ø–∞—Ä–æ–ª—è –∏–ª–∏ –∫–ª—é—á–∞ –ø—Ä–∏–≤–µ–¥—ë—Ç –∫ –ø–æ—Ç–µ—Ä–µ –¥–∞–Ω–Ω—ã—Ö. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é!
        </div>
        <div class="security-modal-actions">
          <button class="security-modal-btn" onclick="closeSecurityInfo()">–ü–æ–Ω—è—Ç–Ω–æ</button>
        </div>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

function closeSecurityInfo() {
  const modal = document.getElementById('securityInfoModal');
  if (modal) modal.remove();
}

// Update indicator on load
document.addEventListener('DOMContentLoaded', () => {
  setTimeout(updateSecurityIndicator, 500);
});

// ============================================
// ACCOUNT UI FUNCTIONS
// ============================================

async function updateAccountUI() {
  const cardEl = document.getElementById('accountCard');
  const nameEl = document.getElementById('accountName');
  const emailEl = document.getElementById('accountEmail');
  const avatarEl = document.getElementById('accountAvatar');
  const logoutBtn = document.getElementById('accountLogoutBtn');
  const badgeEl = document.getElementById('accountPlanBadge');
  
  if (!nameEl || !emailEl) return;
  
  // Plan display config
  const planConfig = {
    'free': { label: 'FREE', class: 'plan-free' },
    'beta': { label: 'üß™ BETA', class: 'plan-beta' },
    'pro': { label: '‚≠ê PRO', class: 'plan-pro' },
    'business': { label: 'üíº BUSINESS', class: 'plan-business' },
    'owner': { label: 'üëë OWNER', class: 'plan-owner' }
  };
  
  if (typeof currentUser !== 'undefined' && currentUser) {
    // Get display name
    const meta = currentUser.user_metadata || {};
    const displayName = meta.full_name || meta.name || currentUser.email?.split('@')[0] || 'User';
    const email = currentUser.email || '‚Äî';
    
    nameEl.textContent = displayName;
    emailEl.textContent = email;
    
    // Set avatar image if available
    if (avatarEl && meta.avatar_url) {
      avatarEl.innerHTML = `<img src="${meta.avatar_url}" alt="Avatar">`;
    }
    
    if (logoutBtn) logoutBtn.style.display = 'flex';
    
    // Fetch plan from database
    let userPlan = localStorage.getItem('droplit_user_plan') || 'beta';
    
    try {
      const client = getSupabaseClient();
      if (client) {
        const { data } = await client.rpc('get_token_balance', { p_user_id: currentUser.id });
        if (data && data.tier) {
          userPlan = data.tier;
          localStorage.setItem('droplit_user_plan', userPlan);
          console.log('[Account] Plan from DB:', userPlan);
        }
      }
    } catch (e) {
      console.log('[Account] Could not fetch plan from DB:', e);
    }
    
    const plan = planConfig[userPlan] || planConfig['beta'];
    
    // Update card gradient
    if (cardEl) {
      cardEl.className = 'account-card ' + plan.class;
    }
    
    // Update badge
    if (badgeEl) {
      badgeEl.textContent = plan.label;
      badgeEl.className = 'account-plan-badge ' + plan.class;
    }
    
  } else {
    nameEl.textContent = 'Not signed in';
    emailEl.textContent = 'Tap to sign in';
    
    // Reset to default
    if (cardEl) cardEl.className = 'account-card plan-free';
    if (badgeEl) {
      badgeEl.textContent = 'FREE';
      badgeEl.className = 'account-plan-badge plan-free';
    }
    
    if (avatarEl) {
      avatarEl.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`;
    }
    
    if (logoutBtn) logoutBtn.style.display = 'none';
    
    // Reset token display for logged out
    const tokenBalanceEl = document.getElementById('tokenBalance');
    const tokenUsageEl = document.getElementById('tokenUsage');
    if (tokenBalanceEl) tokenBalanceEl.textContent = '‚Äî';
    if (tokenUsageEl) tokenUsageEl.textContent = 'Sign in to view';
  }
  
  // Update header lock indicator
  updateSecurityIndicator();
  
  // Update token balance if logged in
  if (typeof currentUser !== 'undefined' && currentUser) {
    updateTokenBalance();
  }
}

async function handleLogout() {
  if (!confirm('Sign out of DropLit?')) return;
  
  try {
    // Use global client
    if (window._supabaseClient) {
      await window._supabaseClient.auth.signOut();
    }
    
    // Clear local storage auth-related items
    localStorage.removeItem('sb-ughfdhmyflotgsysvrrc-auth-token');
    
    // Reset currentUser
    window.currentUser = null;
    window._authListenerSetup = false;
    
    // Update UI
    updateAccountUI();
    
    // Close menu
    closeMainMenu();
    
    // Show toast
    if (typeof toast === 'function') {
      toast('Signed out', 'info');
    }
    
    // Reload to show onboarding
    setTimeout(() => {
      window.location.reload();
    }, 500);
    
  } catch (err) {
    console.error('[Account] Logout error:', err);
    if (typeof toast === 'function') {
      toast('Error signing out', 'error');
    }
  }
}

// Create single global Supabase client
function getSupabaseClient() {
  if (!window._supabaseClient && typeof supabase !== 'undefined') {
    window._supabaseClient = supabase.createClient(
      'https://ughfdhmyflotgsysvrrc.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVnaGZkaG15ZmxvdGdzeXN2cnJjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4NDgwMTEsImV4cCI6MjA4MjQyNDAxMX0.s6oAvyk6gJU0gcJV00HxPnxkvWIbhF2I3pVnPMNVcrE'
    );
    console.log('[Auth] Global Supabase client created');
  }
  return window._supabaseClient;
}

// Update account UI when menu opens - NO AUTH LISTENER
document.addEventListener('DOMContentLoaded', function() {
  // Initial update only
  setTimeout(updateAccountUI, 500);
  console.log('[Auth] DOMContentLoaded - NO auth listener (disabled to stop loop)');
});

function openMainMenu() {
  const menu = document.getElementById('mainMenu');
  const btn = document.getElementById('menuToggleBtn');
  
  if (!menu) return;
  
  menu.classList.add('show');
  
  if (btn) {
    const iconOpen = btn.querySelector('.menu-icon-open');
    const iconClose = btn.querySelector('.menu-icon-close');
    if (iconOpen) iconOpen.style.display = 'none';
    if (iconClose) iconClose.style.display = 'block';
  }
  
  // Sync AutoDrop toggle state
  updateAutoDropIndicator();
  
  // Load user email
  loadUserEmail();
  
  // Load ASKI Knowledge Base
  loadAskiKnowledge();
  
  // Update account info
  updateAccountUI();
}

function closeMainMenu() {
  const menu = document.getElementById('mainMenu');
  const btn = document.getElementById('menuToggleBtn');
  
  if (!menu) return;
  
  menu.classList.remove('show');
  
  if (btn) {
    const iconOpen = btn.querySelector('.menu-icon-open');
    const iconClose = btn.querySelector('.menu-icon-close');
    if (iconOpen) iconOpen.style.display = 'block';
    if (iconClose) iconClose.style.display = 'none';
  }
}

// Initialize on load
document.addEventListener('DOMContentLoaded', function() {
  updateAutoDropIndicator();
});


// ============================================
// PRIVACY STATUS FUNCTION
// ============================================

function showPrivacyStatus() {
  let status = "üîê PRIVACY STATUS\n\n";
  
  // Check modules loaded
  const modulesLoaded = typeof DropLitPrivacy !== "undefined";
  status += "Modules Loaded: " + (modulesLoaded ? "‚úÖ Yes" : "‚ùå No") + "\n";
  
  // Check if enabled
  const enabled = window.DROPLIT_PRIVACY_ENABLED === true;
  status += "Privacy Enabled: " + (enabled ? "‚úÖ Yes" : "‚ùå No") + "\n";
  
  // Check version
  status += "Version: " + (window.DROPLIT_PRIVACY_VERSION || "N/A") + "\n\n";
  
  if (modulesLoaded && typeof DropLitPrivacy.getStatus === "function") {
    try {
      const ps = DropLitPrivacy.getStatus();
      status += "=== COMPONENTS ===\n";
      status += "Encryption: " + (ps.layers?.encryption ? "‚úÖ" : "‚ùå") + "\n";
      status += "Embeddings: " + (ps.layers?.embeddings ? "‚úÖ" : "‚ùå") + "\n";
      status += "ZK Search: " + (ps.layers?.zkSearch ? "‚úÖ" : "‚ùå") + "\n";
      status += "Audit Trail: " + (ps.layers?.audit ? "‚úÖ" : "‚ùå") + "\n";
      status += "\nInitialized: " + (ps.initialized ? "‚úÖ" : "‚ùå") + "\n";
    } catch(e) {
      status += "Status Error: " + e.message + "\n";
    }
  } else {
    status += "Privacy system not initialized.\n";
    status += "Setup encryption in Settings.\n";
  }
  
  // Check if user has key
  if (currentUser && typeof DropLitKeys !== "undefined") {
    status += "\n=== USER ===\n";
    status += "User ID: " + currentUser.id.slice(0,8) + "...\n";
    const hasKeyFlag = localStorage.getItem("droplit_has_key_" + currentUser.id);
    status += "Has Key: " + (hasKeyFlag === "true" ? "‚úÖ Yes" : "‚ùå No") + "\n";
  }
  
  alert(status);
}

// ============================================
// SETUP ENCRYPTION FUNCTION (Simplified v0.9.103)
// ============================================

async function setupEncryption() {
  // Check if user is logged in
  if (!currentUser) {
    toast("Please sign in first", "error");
    return;
  }
  
  // Check if encryption UI module is loaded
  if (typeof DropLitEncryptionUI === "undefined") {
    toast("Encryption module not loaded. Refresh page.", "error");
    return;
  }
  
  // Check if user already has a key
  try {
    const hasKey = await DropLitKeys.hasStoredKey(currentUser.id);
    
    if (hasKey) {
      // User already has encryption key
      if (window.DROPLIT_PRIVACY_ENABLED) {
        // Already active - show status
        showPrivacyStatus();
      } else {
        // Key exists but not initialized - initialize now
        toast("üîê Activating encryption...", "info");
        await initializePrivacySystem();
      }
      return;
    }
    
    // No key exists - show setup dialog
    closeMainMenu();
    DropLitEncryptionUI.showEncryptionSetupModal(currentUser.id);
    
  } catch (e) {
    console.error("[Encryption] Setup error:", e);
    toast("Encryption error: " + e.message, "error");
  }
}

// Initialize privacy system after key setup
async function initializePrivacySystem() {
  if (!currentUser) {
    console.warn("[Privacy] No user for init");
    return;
  }
  
  try {
    // Get the stored key
    const keyData = await DropLitKeys.retrieveKey(currentUser.id);
    
    if (!keyData) {
      console.warn("[Privacy] No key found");
      updateEncryptionButton(false);
      return;
    }
    
    // Initialize privacy system
    if (typeof DropLitPrivacy !== "undefined") {
      const result = await DropLitPrivacy.init({
        masterKey: keyData.key,
        config: {
          enableEncryption: true,
          enableLocalEmbeddings: true,
          enableZKSearch: true,
          enableAudit: true
        },
        onProgress: (msg, pct) => {
          console.log("[Privacy Init]", msg, pct ? pct + "%" : "");
        }
      });
      
      if (result.success) {
        window.DROPLIT_PRIVACY_ENABLED = true;
        localStorage.setItem("droplit_has_key_" + currentUser.id, "true");
        updateEncryptionButton(true);
        updateSecurityIndicator();
        console.log("[Privacy] ‚úÖ System activated");
        // Only show toast if user triggered it manually (not auto-init)
        if (document.visibilityState === 'visible') {
          toast("üîê Encryption active", "success");
        }
      } else {
        console.error("[Privacy] Init failed:", result.error);
        updateEncryptionButton(false);
      }
    } else {
      // DropLitPrivacy not loaded - just mark as having key
      window.DROPLIT_PRIVACY_ENABLED = true;
      localStorage.setItem("droplit_has_key_" + currentUser.id, "true");
      updateEncryptionButton(true);
      updateSecurityIndicator();
      console.log("[Privacy] ‚úÖ Key active (lite mode)");
    }
    
  } catch (error) {
    console.error("[Privacy] Init error:", error);
    updateEncryptionButton(false);
  }
}

// Auto-initialize privacy on page load if user has key
document.addEventListener("DOMContentLoaded", async function() {
  // Wait for auth to complete
  setTimeout(async () => {
    await autoInitEncryption();
  }, 1500);
});

// Auto-init encryption if user has key
async function autoInitEncryption() {
  if (!currentUser) {
    console.log("[Privacy] No user, skipping auto-init");
    updateEncryptionButton(false);
    return;
  }
  
  if (typeof DropLitKeys === "undefined") {
    console.log("[Privacy] DropLitKeys not loaded, skipping");
    return;
  }
  
  try {
    const hasKey = await DropLitKeys.hasStoredKey(currentUser.id);
    
    if (hasKey) {
      console.log("[Privacy] User has key, auto-initializing...");
      await initializePrivacySystem();
    } else {
      console.log("[Privacy] No key found, encryption available but not active");
      updateEncryptionButton(false);
    }
  } catch (e) {
    console.log("[Privacy] Auto-init error:", e.message);
    updateEncryptionButton(false);
  }
}

// Update encryption button UI
function updateEncryptionButton(isActive) {
  const btn = document.getElementById("setupEncryptionBtn");
  if (!btn) return;
  
  if (isActive) {
    btn.textContent = "‚úÖ Encrypted";
    btn.classList.remove("pri");
    btn.classList.add("sec");
    btn.style.background = "linear-gradient(135deg, #10B981, #059669)";
    btn.style.color = "white";
  } else {
    btn.textContent = "üîê Encryption";
    btn.classList.remove("pri");
    btn.classList.add("sec");
    btn.style.background = "";
    btn.style.color = "";
  }
}

// Reset encryption (for testing/troubleshooting)
async function resetEncryption() {
  if (!currentUser) {
    toast("Please sign in first", "error");
    return;
  }
  
  const confirmed = confirm(
    "‚ö†Ô∏è RESET ENCRYPTION ‚ö†Ô∏è\n\n" +
    "This will delete your encryption key.\n" +
    "Encrypted data will become unreadable.\n\n" +
    "Are you sure?"
  );
  
  if (!confirmed) return;
  
  try {
    // Delete key from IndexedDB
    if (typeof DropLitKeys !== "undefined") {
      await DropLitKeys.deleteKey(currentUser.id);
    }
    
    // Clear localStorage flags
    localStorage.removeItem("droplit_has_key_" + currentUser.id);
    localStorage.removeItem("droplit_had_encryption_" + currentUser.id);
    
    // Reset privacy state
    window.DROPLIT_PRIVACY_ENABLED = false;
    
    // Update UI
    updateEncryptionButton(false);
    updateSecurityIndicator();
    
    toast("‚úÖ Encryption reset. You can set it up again.", "success");
    
  } catch (error) {
    toast("Reset failed: " + error.message, "error");
  }
}

</script>
</body>
</html>
